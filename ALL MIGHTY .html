    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">


        <!-- PWA CONFIGURATION -->
        <link rel="manifest" href="manifest.json">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="theme-color" content="#0f172a">
            <!-- Icône pour l'onglet du navigateur -->
        <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/13594/13594876.png">
        <!-- Icône pour iPhone/iPad (Apple) -->
        <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/128/13594/13594876.png">




        <title>SIRH Pro | Secure Access</title>
        
        <!-- Bibliothèques -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>


  <style>
        /* ============================================================
        1. VARIABLES DE MARQUE & CONFIGURATION (ROOT)
        ============================================================ */
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --base-size: 14px;
            /* Variables de contraste calculées par le JS */
            --text-on-primary: #ffffff;
            --text-on-accent: #ffffff;
        }


        /* ============================================================
        2. DARK MODE ULTRA-CLEAN
        ============================================================ */
        body.dark-mode { background-color: #020617 !important; color: #f1f5f9 !important; }
        body.dark-mode aside { background-color: #020617 !important; border-right: 1px solid #1e293b !important; }
        body.dark-mode header, body.dark-mode .glass { background: rgba(2, 6, 23, 0.9) !important; border-bottom: 1px solid #1e293b !important; box-shadow: none !important; color: white !important; }
        
        /* Cartes et Sections en Dark Mode */
        body.dark-mode .bg-white, body.dark-mode section, body.dark-mode .rounded-3xl, 
        body.dark-mode .rounded-2xl, body.dark-mode .shadow-xl, body.dark-mode .bg-slate-50, 
        body.dark-mode .bg-slate-100 {
            background-color: #0f172a !important; border: 1px solid #1e293b !important; box-shadow: none !important; color: #f1f5f9 !important;
        }

        /* Tableaux Dark Mode */
        body.dark-mode table thead { background-color: #1e293b !important; }
        body.dark-mode table thead th { color: #94a3b8 !important; border-bottom: 1px solid #334155 !important; }
        body.dark-mode table tbody tr { background-color: transparent !important; border-bottom: 1px solid #1e293b !important; }
        body.dark-mode table tbody tr:hover { background-color: #1e293b !important; }
        body.dark-mode td { color: #cbd5e1 !important; }

        /* Inputs Dark Mode */
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #1e293b !important; border: 1px solid #334155 !important; color: #ffffff !important; box-shadow: none !important;
        }

        /* Textes Dark Mode */
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode .text-slate-800, body.dark-mode .text-slate-900 { color: #f8fafc !important; }
        body.dark-mode .text-slate-500, body.dark-mode .text-slate-400 { color: #94a3b8 !important; }

        /* SweetAlert Dark Mode */
        body.dark-mode .swal2-popup { background-color: #0f172a !important; color: #f1f5f9 !important; border: 1px solid #334155 !important; }
        body.dark-mode .swal2-title, body.dark-mode .swal2-html-container, body.dark-mode .swal2-content { color: #f1f5f9 !important; }
        body.dark-mode .swal2-timer-progress-bar { background: #2563eb !important; }

        /* ============================================================
        3. STYLES DE BASE & LAYOUT
        ============================================================ */
        /* FIX: Fond sombre par défaut pour éviter le flash blanc au démarrage */
        html, body { background-color: #0f172a !important; font-family: var(--font-main); font-size: var(--base-size); }
        
    
    /* ============================================================
    STYLE DE LA BARRE DE SCROLL "PROFESSIONNEL"
    ============================================================ */

    /* 1. Largeur de la barre (très fine) */
    ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
    }

    /* 2. Fond de la barre (Transparent pour ne pas faire de bande moche) */
    ::-webkit-scrollbar-track {
        background: transparent;
    }

    /* 3. Le curseur (la partie qui bouge) */
    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1); /* Couleur discrète par défaut */
        border-radius: 20px;
        transition: background 0.3s;
    }

    /* 4. Au survol du menu, on rend la barre un peu plus visible */
    aside:hover ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.25);
    }

    /* 5. Style spécifique pour le mode clair (Main content) */
    main ::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.1);
    }

    main:hover ::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.2);
    }


        /* Gestion des vues */
        .view-section { display: none !important; opacity: 0; }
        .view-section.active { display: block !important; opacity: 1; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Squelettes et Progressions */
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite linear; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* FIX: Animation renommée pour correspondre au HTML progress_1.5s */


    /* Animation de la barre de chargement (va et vient infini) */
    @keyframes bar-slide {
        0% { left: -40%; width: 30%; }
        50% { width: 60%; }
        100% { left: 100%; width: 30%; }
    }

    .loading-bar-active {
        position: relative;
        left: -40%;
        width: 30%;
        height: 100%;
        background: linear-gradient(90deg, #2563eb, #818cf8);
        border-radius: 9999px;
        animation: barProgress 1.8s ease-in-out infinite;
    }

    /* État initial de l'application : invisible */
    #app-layout {
        opacity: 0;
        transition: opacity 0.8s ease-in-out;
        visibility: hidden;
    }

    /* Quand l'application est prête */
    #app-layout.ready {
        opacity: 1;
        visibility: visible;
    }








        /* Rôles et visibilité */
        .admin-only, .rh-only, .management-only { display: none !important; }
        body.role-admin .admin-only, body.role-admin .rh-only, body.role-admin .management-only { display: block !important; } 
        body.role-rh .rh-only, body.role-rh .management-only { display: block !important; }       
        body.role-manager .management-only { display: block !important; }

        /* Éléments fixes */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        main header { position: sticky; top: 0; z-index: 40; backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.85); }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; }

        /* ============================================================
        4. BRANDING DYNAMIQUE ET COMPOSANTS
        ============================================================ */
        
        /* Couleurs de marque appliquées aux éléments clés */
        aside { background-color: var(--primary) !important; color: var(--text-on-primary) !important; }
        .nav-btn.bg-blue-600, #btn-login, .bg-blue-600 { background-color: var(--accent) !important; color: var(--text-on-accent) !important; }

        /* Correction du nom de l'entreprise (Ellipsis) */
        .company-name-display {
            display: inline-block;
            max-width: 150px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        /* Dashboard et Header */
        #main-scroll-container { padding-top: 1.5rem !important; }
        #login-screen img { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }

        /* Filtres et Chips */
        .filter-chip { background-color: white; border-color: #e2e8f0; color: #64748b; }
        .filter-chip:hover { border-color: #3b82f6; color: #3b82f6; }
        .filter-chip.active-chip { background-color: var(--accent) !important; border-color: var(--accent) !important; color: var(--text-on-accent) !important; }
        body.dark-mode .filter-chip { background-color: #1e293b; border-color: #334155; color: #94a3b8; }




                        /* SCROLLBAR INTERNE POUR LES BLOCS */
        .custom-scroll {
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #cbd5e1 transparent; /* Couleur / Fond */
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .custom-scroll:hover::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
        }


    </style>










    </head>



    <body class="text-slate-900 overflow-hidden h-screen w-full"> 


                                                    <!-- LOADER PREMIUM -->
                           <div id="initial-loader" class="fixed inset-0 bg-slate-900 z-[999] flex flex-col items-center justify-center transition-all duration-1000 ease-in-out">
    <!-- Logo Container -->
    <div class="relative mb-8">
        <div class="absolute inset-0 bg-blue-500 rounded-full blur-xl opacity-20 animate-pulse"></div>
        <div class="relative bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-2xl flex items-center justify-center">
            <i class="fa-solid fa-fingerprint text-5xl text-blue-500 animate-pulse"></i>
        </div>
    </div>
    
    <!-- Texte -->
    <h2 class="text-white text-2xl font-black tracking-tight mb-2">SIRH <span class="text-blue-500">SECURE</span></h2>
    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] mb-8">CHARGEMENT...</p>

    <!-- Barre de chargement améliorée -->
    <div class="w-64 h-1 bg-slate-800 rounded-full overflow-hidden relative">
        <!-- La barre interne avec animation de va-et-vient (indéterminée) -->
        <div class="h-full bg-gradient-to-r from-blue-600 to-indigo-400 rounded-full absolute top-0" 
             style="width: 40%; animation: bar-slide 1.8s infinite ease-in-out; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);">
        </div>
    </div>
</div>




        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/80 z-40 hidden md:hidden transition-opacity backdrop-blur-sm"></div>

        <!-- ECRAN DE CONNEXION -->
        <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100] transition-all duration-500 p-4">
            <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-600 rounded-2xl shadow-xl shadow-blue-500/30 mb-6 text-white"><i class="fa-solid fa-fingerprint text-3xl"></i></div>
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight text-center">SIRH Secure</h1>
                    <p class="text-slate-400 mt-2 font-medium text-center">Portail De Connexion</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Identifiant</label><input type="text" id="login-user" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Mot de passe</label><input type="password" id="login-pass" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                    <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 shadow-lg transition-all active:scale-95 uppercase tracking-widest">Se Connecter</button>
                </form>
            </div>
        </div>

        <!-- APP LAYOUT -->
        <div id="app-layout" class="hidden h-screen flex flex-col md:flex-row overflow-hidden relative">
            <aside id="sidebar" class="w-72 bg-slate-900 text-slate-300 flex flex-col fixed md:relative inset-y-0 left-0 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 border-r border-slate-800">
                <div class="p-8 flex-1 overflow-y-auto">
                    <div class="flex items-center justify-between mb-10 text-white">
    
    <div class="flex items-center gap-3">
        <div class="p-1.5 rounded-xl shadow-lg flex items-center justify-center" style="background-color: var(--accent); min-width: 40px; height: 40px;">
            <img src="" class="app-logo-display w-7 h-7 object-contain">
        </div>
        <span class="font-black text-lg tracking-tighter company-name-display">SIRH SECURE</span>
    </div>

                        <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <nav class="space-y-2">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-2 ml-4 tracking-widest">Personnel</p>
                        <button onclick="switchView('my-profile')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group"><i class="fa-solid fa-id-badge w-5"></i> <span class="font-semibold">Mon Profil</span></button>
                        
                                            <!-- Dans la <nav>, juste après le bouton "Mon Profil" -->
                        <button onclick="switchView('help')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group">
                            <i class="fa-solid fa-circle-info w-5"></i> 
                            <span class="font-semibold">Infos & Aide</span>
                        </button>

                                            
                        <div id="nav-admin-section" class="management-only pt-4 border-t border-slate-800 mt-4">
                            <p class="text-[10px] font-black text-slate-500 uppercase mb-2 ml-4 tracking-widest">Gestion</p>
                            <button onclick="switchView('dash')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group"><i class="fa-solid fa-chart-pie w-5"></i> <span class="font-semibold">Tableau de Bord</span></button>
                            
                        <button onclick="openFlashModal()" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group management-only">
                            <i class="fa-solid fa-bullhorn w-5 text-orange-500"></i> 
                            <span class="font-semibold text-orange-400 group-hover:text-white">Diffuser Une Annonce</span>
                        </button>
                            
                            
                            <button onclick="switchView('employees')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group"><i class="fa-solid fa-user-group w-5"></i> <span class="font-semibold">Collaborateurs</span></button>
                            <button onclick="switchView('add-new')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group rh-only"><i class="fa-solid fa-user-plus w-5"></i> <span class="font-semibold">Nouveau Profil</span></button>
                            <!-- BOUTON RECRUTEMENT -->
                            <button onclick="switchView('recruitment')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group rh-only">
                                <i class="fa-solid fa-briefcase w-5"></i> 
                                <span class="font-semibold">Recrutement</span>
                            </button>
                                                    
                            <button onclick="switchView('logs')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:text-white group admin-only"><i class="fa-solid fa-list-check w-5"></i> <span class="font-semibold">Audit Sécurité</span></button>
                        </div>
                    </nav>
                </div>
                <div class="mt-auto p-6 border-t border-slate-800 bg-slate-900/50">
                    <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-2xl mb-4 border border-slate-700/30">
                        <div id="avatar-display" class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold uppercase shadow-lg">?</div>
                        <div class="overflow-hidden"><p id="name-display" class="text-sm font-bold text-white truncate">User</p><p id="role-display" class="text-[10px] uppercase font-black text-blue-400">Rôle</p></div>
                    </div>
                    <button id="install-button" class="hidden w-full flex items-center justify-center gap-2 p-3 mb-2 text-xs font-bold text-emerald-400 bg-emerald-500/10 hover:bg-emerald-500/20 rounded-xl transition-all uppercase tracking-tighter border border-emerald-500/30">
                        <i class="fa-solid fa-download"></i> Installer l'App
                    </button>
                    <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 p-3 text-xs font-bold text-red-400 hover:bg-red-500/10 rounded-xl transition-all uppercase tracking-tighter"><i class="fa-solid fa-power-off"></i> Déconnexion</button>           
                </div>
            </aside>

            <main class="flex-1 flex flex-col min-w-0 bg-slate-50 overflow-hidden w-full">

                <header class="h-20 glass border-b border-slate-200 px-4 md:px-8 flex justify-between items-center shrink-0 z-10">


                <div class="flex items-center flex-1 max-w-2xl gap-3">
                        <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-600 bg-white border border-slate-200 rounded-lg"><i class="fa-solid fa-bars text-lg"></i></button>
                        <div id="global-search-container" class="relative w-full">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="search-input" onkeyup="filterTable()" placeholder="Rechercher..." class="w-full pl-12 pr-4 py-3 bg-slate-100 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                        </div>
                    </div>
                    <button onclick="toggleDarkMode()" class="p-2.5 bg-slate-100 dark-toggle-btn text-slate-600 rounded-xl hover:bg-slate-200 transition-all active:scale-95 mr-2">
                    <i class="fa-solid fa-moon text-lg" id="dark-icon"></i>
                    </button>
                    <button onclick="startScanner()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold ml-4 transition-all hover:scale-105 shadow-lg active:scale-95"><i class="fa-solid fa-qrcode mr-2"></i> SCANNER</button>
                </header>

    <div id="main-scroll-container" class="flex-1 overflow-y-auto p-3 md:p-8 scroll-smooth no-scrollbar">             
                    

                    <!-- CONTENEUR POUR PLUSIEURS ALERTES -->
                        <div id="flash-container" class="space-y-3 mb-6"></div>


                    <!-- VUE 1: DASHBOARD -->
                <section id="view-dash" class="view-section active">             
    <!-- EN-TÊTE RESPONSIVE (CORRIGÉ) -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-extrabold text-slate-800">Analyse de l'Effectif</h2>
                    
                    <!-- Conteneur boutons : En ligne et flexible -->
                    <div class="flex flex-wrap gap-2 w-full md:w-auto">
                        <!-- Bouton Actualiser (Prend la moitié sur mobile) -->
                        <button onclick="refreshAllData(true)" class="flex-1 md:flex-none justify-center p-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-all text-slate-600 shadow-sm flex items-center gap-2 text-sm font-bold active:scale-95">
                            <i class="fa-solid fa-rotate" id="refresh-icon"></i> <span class="hidden sm:inline">Actualiser</span><span class="sm:hidden">Sync</span>
                        </button>
                        
                        <!-- Bouton Exporter (Prend la moitié sur mobile) -->
                        <button onclick="exportToCSV()" class="flex-1 md:flex-none justify-center p-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-all shadow-sm flex items-center gap-2 text-sm font-bold active:scale-95">
                        <i class="fa-solid fa-file-excel"></i> Exporter
                        </button>

                        <button onclick="openAttendancePicker()" class="flex-1 md:flex-none justify-center p-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all shadow-sm flex items-center gap-2 text-sm font-bold active:scale-95 management-only">
                            <i class="fa-solid fa-clipboard-list"></i> Rapport Présence
                        </button>



                        <!-- Date (Pleine largeur sur tout petit écran, ou auto) -->
                        <div id="current-date" class="w-full sm:w-auto text-center bg-blue-50 text-blue-700 px-4 py-2.5 rounded-xl font-bold text-sm border border-blue-100 italic">--</div>
                    </div>
                </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Effectif Total</p><h3 id="stat-total" class="text-4xl font-black mt-2 text-slate-800">0</h3></div>
                        <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Alertes Contrats</p><h3 id="stat-alert" class="text-4xl font-black mt-2 text-red-600">0</h3></div>
                        <div class="bg-white p-7 rounded-3xl shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Collaborateurs Actifs</p><h3 id="stat-active" class="text-4xl font-black mt-2 text-emerald-600">0</h3></div>
                    </div>

                    <!-- NOUVEAU : ZONE GRAPHIQUES -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                        <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                            <p class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-widest">Répartition par Statut</p>
                            <canvas id="chartStatus" height="200"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                            <p class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-widest">Répartition par Département</p>
                            <canvas id="chartDept" height="200"></canvas>
                        </div>
                    </div>




                                <!-- NOUVEAU : SECTION VALIDATION CONGÉS (Visible uniquement pour Managers/RH/Admin) -->
                    <div id="manager-leave-section" class="management-only bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden mb-10 hidden">
                        <div class="px-8 py-6 border-b border-slate-100 font-extrabold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-check text-blue-500"></i> Demandes de congés à valider
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left whitespace-nowrap">
                                <thead class="bg-slate-50/80 text-[10px] uppercase font-black text-slate-400">
                                    <tr>
                                        <th class="px-8 py-4">Employé</th>
                                        <th class="px-8 py-4">Dates</th>
                                        <th class="px-8 py-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="leave-requests-body" class="divide-y divide-slate-50">
                                    <!-- Les demandes apparaîtront ici via le JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>





                    <!-- Alert Table -->
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                        <div class="px-8 py-6 border-b border-slate-100 font-extrabold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-hourglass-half text-orange-500"></i> Alertes Fin de Contrat / Essai
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left whitespace-nowrap">
                                <thead class="bg-slate-50/80 text-[10px] uppercase font-black text-slate-400">
                                    <tr><th class="px-8 py-4">Nom</th><th class="px-8 py-4">Poste</th><th class="px-8 py-4">Délai</th><th class="px-8 py-4 rh-only text-right">Action</th></tr>
                                </thead>
                                <tbody id="dashboard-body" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </section>


                








    


    <!-- VUE 2: LISTE COLLABORATEURS -->
    <section id="view-employees" class="view-section">
        <!-- EN-TÊTE (HAUT) AVEC FILTRES -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-6 px-1 gap-4">
            <div>
                <h2 class="text-2xl font-extrabold text-slate-800 tracking-tight">Liste des Collaborateurs</h2>
                <p class="text-sm text-slate-500 font-medium mt-1">Gestion administrative et contractuelle</p>
                
                <!-- ZONE DE FILTRES INTELLIGENTS -->
                <div class="flex flex-wrap gap-2 mt-4" id="filter-container">
                    <button onclick="applySmartFilter('all')" class="filter-chip active-chip px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all uppercase tracking-widest">Tous</button>
                    <button onclick="applySmartFilter('Actif')" class="filter-chip px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all uppercase tracking-widest">Actifs</button>
                    <button onclick="applySmartFilter('Congé')" class="filter-chip px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all uppercase tracking-widest">En Congé</button>
                    <button onclick="applySmartFilter('Sortie')" class="filter-chip px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all uppercase tracking-widest">Sortis</button>
                    <div class="h-6 w-[1px] bg-slate-200 mx-1 self-center"></div>
                    <button onclick="applySmartFilter('IT & Tech')" class="filter-chip px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all uppercase tracking-widest">IT & Tech</button>
                    <button onclick="applySmartFilter('Finance')" class="filter-chip px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all uppercase tracking-widest">Finance</button>
                </div>
            </div>



            <!-- PAGINATION HAUT -->
            <div class="flex items-center gap-3">
                <button onclick="changePage(-1)" class="btn-prev-global w-8 h-8 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition-all shadow-sm">
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
                <span class="page-info-global text-[10px] font-black uppercase tracking-widest text-slate-400 select-none min-w-[80px] text-center">PAGE 1 / 1</span>
                <button onclick="changePage(1)" class="btn-next-global w-8 h-8 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-slate-900 hover:text-white transition-all shadow-sm">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            </div>
        </div>

        <!-- TABLEAU -->
        <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden min-h-[500px] flex flex-col justify-between">
            <div class="overflow-x-auto">
                <table class="w-full text-left whitespace-nowrap">
                    <thead class="bg-slate-900 text-white text-[10px] uppercase font-bold">
                        <tr>
                            <th class="px-8 py-5">Identité</th>
                            <th class="px-8 py-5">Poste</th>
                            <th class="px-8 py-5">Statut</th>
                            <th class="px-8 py-5 text-right rh-only">Dossier & Actions</th>
                        </tr>
                    </thead>
                    <tbody id="full-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <!-- PAGINATION BAS -->
            <div class="border-t border-slate-100 bg-slate-50 p-4 flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Affichage par 10</span>
                <div class="flex items-center gap-3">
                    <button onclick="changePage(-1)" class="btn-prev-global w-8 h-8 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-slate-600 hover:bg-slate-200 transition-all">
                        <i class="fa-solid fa-chevron-left text-xs"></i>
                    </button>
                    <span class="page-info-global text-[10px] font-black uppercase tracking-widest text-slate-500 select-none min-w-[80px] text-center">PAGE 1 / 1</span>
                    <button onclick="changePage(1)" class="btn-next-global w-8 h-8 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-slate-600 hover:bg-slate-200 transition-all">
                        <i class="fa-solid fa-chevron-right text-xs"></i>
                    </button>
                </div>
            </div>
        </div>




        
                        <!-- NOUVEAU : SOLDE CONGÉS MANAGER -->
            <div id="manager-leave-balance" class="management-only bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden mt-8 mb-10">
                <div class="px-8 py-6 border-b border-slate-100 font-extrabold text-slate-700 flex justify-between items-center">
                    <span>Solde de Congés par Collaborateur</span>
                    <button onclick="fetchEmployeeLeaveBalances()" class="text-blue-600 hover:text-blue-800 transition-all text-sm font-bold">
                        <i class="fa-solid fa-rotate mr-2"></i> Actualiser
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50/80 text-[10px] uppercase font-black text-slate-400">
                            <tr>
                                <th class="px-8 py-4">Nom</th>
                                <th class="px-8 py-4">Département</th>
                                <th class="px-8 py-4 text-center">Statut Demande</th>
                                <th class="px-8 py-4 text-right">Jours Restants</th>
                            </tr>
                        </thead>
                        <tbody id="manager-leave-body">
                            <!-- Les soldes apparaîtront ici via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
    </section>












                    <!-- VUE 3: AJOUT -->
                    <section id="view-add-new" class="view-section">
                        <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border">
                            <div class="bg-slate-900 px-10 py-6 text-white flex justify-between items-center"><h2 class="text-xl font-bold">Nouveau Profil</h2><i class="fa-solid fa-user-plus opacity-20 text-3xl"></i></div>
                            <form id="form-onboarding" onsubmit="handleOnboarding(event)" class="p-10 grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="md:col-span-2 space-y-4">
                                    <input type="text" id="f-nom" class="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Nom Complet" required>
                                    <input type="email" id="f-email" class="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Email Pro" required>
                                    <div class="grid grid-cols-2 gap-4"><input type="tel" id="f-phone" class="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Téléphone"><input type="date" id="f-dob" class="w-full p-4 bg-slate-50 border rounded-xl outline-none"></div>
                                    <input type="text" id="f-address" class="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Adresse complète">
                                    <div class="grid grid-cols-2 gap-4"><input type="date" id="f-date" class="w-full p-4 bg-slate-50 border rounded-xl outline-none" required><input type="text" id="f-poste" class="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Poste" required></div>
                                    <div class="grid grid-cols-3 gap-4">
                                        <select id="f-dept" class="w-full p-4 bg-slate-50 border rounded-xl font-medium"><option>IT & Tech</option><option>RH</option><option>Finance</option><option>Marketing</option></select>
                                        <select id="f-limit" class="w-full p-4 bg-slate-50 border rounded-xl font-medium"><option value="365">CDI</option><option value="180">CDD</option><option value="90">Essai</option></select>
                                        <select id="f-role" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-xl font-bold text-blue-700"><option value="EMPLOYEE">EMPLOYE</option><option value="MANAGER">MANAGER</option><option value="RH">RH</option><option value="ADMIN">ADMIN</option></select>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center justify-start p-4 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                                    <div class="w-full h-44 bg-slate-200 rounded-xl mb-4 overflow-hidden flex items-center justify-center"><video id="video-stream" class="w-full h-full object-cover hidden" autoplay playsinline></video><img id="captured-image" class="w-full h-full object-cover hidden"><i class="fa-solid fa-image text-slate-400 text-3xl" id="photo-placeholder"></i></div>
                                    <div id="initial-controls" class="flex flex-col w-full gap-2 mt-auto"><button type="button" onclick="startCameraFeed()" class="w-full text-[10px] font-bold text-slate-500 uppercase bg-white border py-2.5 rounded-lg shadow-sm">Caméra</button><button type="button" onclick="document.getElementById('file-upload').click()" class="w-full text-[10px] font-bold text-blue-600 uppercase bg-blue-50 border border-blue-200 py-2.5 rounded-lg">Téléverser</button></div>
                                    <canvas id="camera-canvas" class="hidden"></canvas><input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileUpload(event)"><button type="button" id="btn-capture" onclick="takeSnapshot()" class="hidden bg-blue-600 text-white py-2.5 rounded-lg w-full mt-2 font-bold text-xs">Prendre</button><button type="button" id="btn-retake" onclick="resetCamera()" class="hidden bg-slate-400 text-white py-2.5 rounded-lg w-full mt-2 font-bold text-xs">Refaire</button>
                                </div>



                                    <!-- SECTION DOCUMENTS KYC (CORRIGÉE) -->
                                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-4 p-6 bg-slate-100 rounded-2xl border-2 border-dashed border-slate-200 mt-4">
                                    <p class="md:col-span-4 text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Documents obligatoires (Photo ou PDF)</p>
                                    
                                    <!-- Pièce d'Identité -->
                                    <div class="space-y-2">
                                        <label class="block text-[9px] font-bold text-slate-400 uppercase">Pièce d'Identité</label>
                                        <div id="btn-id_card" class="h-20 bg-white rounded-lg border flex items-center justify-center overflow-hidden cursor-pointer hover:bg-slate-50 transition-all" onclick="openDocCamera('id_card')">
                                            <img id="preview-id_card" class="hidden h-full w-full object-cover">
                                            <i id="icon-id_card" class="fa-solid fa-id-card text-slate-300 text-2xl"></i>
                                        </div>
                                        <input type="file" id="f-id_card" class="hidden" onchange="previewDocFile(event, 'id_card'); updateFileFeedback('f-id_card', 'btn-id_card')">
                                    </div>

                                    <!-- CV -->
                                    <div class="space-y-2">
                                        <label class="block text-[9px] font-bold text-slate-400 uppercase">Curriculum Vitae</label>
                                        <div id="btn-cv" class="h-20 bg-white rounded-lg border flex items-center justify-center overflow-hidden cursor-pointer hover:bg-slate-50 transition-all" onclick="openDocCamera('cv')">
                                            <img id="preview-cv" class="hidden h-full w-full object-cover">
                                            <i id="icon-cv" class="fa-solid fa-file-pdf text-slate-300 text-2xl"></i>
                                        </div>
                                        <input type="file" id="f-cv" class="hidden" onchange="previewDocFile(event, 'cv'); updateFileFeedback('f-cv', 'btn-cv')">
                                    </div>

                                    <!-- Diplôme -->
                                    <div class="space-y-2">
                                        <label class="block text-[9px] font-bold text-slate-400 uppercase">Dernier Diplôme</label>
                                        <div id="btn-diploma" class="h-20 bg-white rounded-lg border flex items-center justify-center overflow-hidden cursor-pointer hover:bg-slate-50 transition-all" onclick="openDocCamera('diploma')">
                                            <img id="preview-diploma" class="hidden h-full w-full object-cover">
                                            <i id="icon-diploma" class="fa-solid fa-graduation-cap text-slate-300 text-2xl"></i>
                                        </div>
                                        <input type="file" id="f-diploma" class="hidden" onchange="previewDocFile(event, 'diploma'); updateFileFeedback('f-diploma', 'btn-diploma')">
                                    </div>

                                    <!-- Attestation -->
                                    <div class="space-y-2">
                                        <label class="block text-[9px] font-bold text-slate-400 uppercase">Attestation / Autres</label>
                                        <div id="btn-attestation" class="h-20 bg-white rounded-lg border flex items-center justify-center overflow-hidden cursor-pointer hover:bg-slate-50 transition-all" onclick="openDocCamera('attestation')">
                                            <img id="preview-attestation" class="hidden h-full w-full object-cover">
                                            <i id="icon-attestation" class="fa-solid fa-file-invoice text-slate-300 text-2xl"></i>
                                        </div>
                                        <input type="file" id="f-attestation" class="hidden" onchange="previewDocFile(event, 'attestation'); updateFileFeedback('f-attestation', 'btn-attestation')">
                                    </div>
                                </div>



                                <button type="submit" class="md:col-span-3 w-full bg-slate-900 text-white py-4 rounded-xl font-bold uppercase hover:bg-slate-800 tracking-widest transition-all shadow-xl">CRÉER ET ENVOYER LES ACCÈS</button>
                            </form>
                        </div>
                    </section>



      <!-- VUE 7: RECRUTEMENT / ATS -->
                    <section id="view-recruitment" class="view-section">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                            <div>
                                <h2 class="text-2xl font-extrabold text-slate-800">Candidatures (Airtable)</h2>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Portail de recrutement et gestion</p>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <!-- Bouton Partager -->
                                <button onclick="copyFormLink()" class="flex items-center gap-2 p-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all shadow-md text-sm font-bold active:scale-95">
                                    <i class="fa-solid fa-share-nodes"></i> <span class="hidden sm:inline">Partager le lien</span>
                                </button>
                                
                                <!-- Bouton Modifier -->
                                <button onclick="openFormEditor()" class="flex items-center gap-2 p-2.5 bg-slate-800 text-white rounded-xl hover:bg-slate-900 transition-all shadow-md text-sm font-bold active:scale-95">
                                    <i class="fa-solid fa-pen-to-square"></i> <span class="hidden sm:inline">Modifier</span>
                                </button>

                                <!-- Votre bouton Actualiser original -->
                                <button onclick="fetchCandidates()" class="p-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-all text-slate-600 shadow-sm font-bold text-sm active:scale-95">
                                    <i class="fa-solid fa-rotate"></i>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left whitespace-nowrap">
                                    <thead class="bg-slate-900 text-white text-[10px] uppercase font-bold">
                                        <tr>
                                            <th class="px-6 py-5">Candidat</th>
                                            <th class="px-6 py-5">Poste visé</th>
                                            <th class="px-6 py-5 text-center">Statut Actuel</th>
                                            <th class="px-6 py-5 text-right">Dossier & Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="candidates-body" class="divide-y divide-slate-100">
                                        <!-- Rempli par JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>



                    <!-- VUE 4: LOGS -->
                    <section id="view-logs" class="view-section">
                        <div class="bg-white rounded-3xl shadow-xl border overflow-hidden">
                            <div class="p-8 border-b font-black text-slate-800 flex justify-between items-center uppercase text-sm">Journal d'Audit Système <button onclick="fetchLogs()" class="text-blue-600"><i class="fa-solid fa-rotate"></i></button></div>
                            <div class="overflow-x-auto"><table class="w-full text-left whitespace-nowrap"><thead class="bg-slate-900 text-white text-[10px] uppercase"><tr><th class="p-5">Date</th><th class="p-5">Agent</th><th class="p-5">Action</th><th class="p-5">Détails</th></tr></thead><tbody id="logs-body"></tbody></table></div>
                        </div>
                    </section>

                    <!-- VUE 5: MON PROFIL (STRUCTURE CORRIGÉE PLEINE LARGEUR) -->
    <section id="view-my-profile" class="view-section">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-8">Mon Espace Personnel</h2>

            <!-- WIDGET POINTAGE & ACTION -->
            <div class="bg-slate-900 rounded-3xl p-6 mb-8 text-white shadow-xl flex flex-col md:flex-row items-center justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-600 rounded-full blur-[80px] opacity-20 pointer-events-none"></div>
                
                <div class="z-10 mb-6 md:mb-0 text-center md:text-left">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">État Actuel</p>
                    <div class="flex items-center gap-3 justify-center md:justify-start">
                        <div id="clock-status-dot" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                        <h3 id="clock-status-text" class="text-2xl font-black">NON POINTÉ</h3>
                    </div>
                    <p id="clock-last-action" class="text-xs text-slate-500 mt-1 font-mono">Dernière action : Aucune</p>
                </div>

                <div class="flex gap-4 z-10 w-full md:w-auto">
                    <button onclick="handleClockInOut()" id="btn-clock" class="flex-1 md:flex-none bg-emerald-500 hover:bg-emerald-400 text-white px-8 py-4 rounded-2xl font-black uppercase transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-fingerprint"></i> <span>ENTRÉE</span>
                    </button>
                    <button onclick="openLeaveModal()" class="flex-1 md:flex-none bg-slate-800 hover:bg-slate-700 text-white px-6 py-4 rounded-2xl font-bold uppercase transition-all border border-slate-700 active:scale-95 text-xs">
                        <i class="fa-solid fa-plane-departure mr-2"></i> Demander un Congé
                    </button>
                </div>
            </div>


                        <!-- NOUVEAU WIDGET SOLDE CONGÉS -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-8 flex justify-between items-center">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Solde Congés Restant</p>
                    <h3 id="leave-balance-display" class="text-4xl font-black mt-2 text-indigo-600">--</h3>
                </div>
                <div class="p-3 bg-indigo-100 text-indigo-600 rounded-xl"><i class="fa-solid fa-calendar-check text-3xl"></i></div>
            </div>
            <!-- FIN NOUVEAU WIDGET SOLDE CONGÉS -->

            <!-- WIDGET POINTAGE & ACTION (Qui est déjà là) -->
            <div class="bg-slate-900 rounded-3xl p-6 mb-8 text-white shadow-xl flex flex-col md:flex-row items-center justify-between relative overflow-hidden">
                <!-- ... le reste du code du pointage ... -->
            </div>

            <!-- ZONE HAUTE : PHOTO (Gauche) + FORMULAIRE (Droite) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                
                <!-- COLONNE GAUCHE : PHOTO & IDENTITÉ -->
                <div class="space-y-6">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 text-center relative overflow-hidden h-full">
                        <div class="absolute top-0 left-0 w-full h-24 bg-blue-600/10"></div>
                        <div class="relative">
                            <div class="w-28 h-28 bg-white p-1 rounded-full mx-auto mb-4 shadow-lg overflow-hidden relative group">
                                <span id="emp-avatar" class="w-full h-full flex items-center justify-center text-3xl font-bold text-slate-300 bg-slate-50">?</span>
                                <img id="emp-photo-real" class="w-full h-full object-cover hidden">
                                <div onclick="triggerPhotoUpload()" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity"><i class="fa-solid fa-camera text-white"></i></div>
                            </div>
                            <h3 id="emp-name" class="font-bold text-xl text-slate-800">...</h3>
                            <p id="emp-job" class="text-sm text-blue-600 font-bold mb-4 uppercase">...</p>
                            <div class="bg-slate-50 rounded-2xl p-4 text-xs space-y-2 text-left border border-slate-100">
                                <div class="flex justify-between font-bold uppercase tracking-tighter"><span>Début :</span> <span id="emp-start-date" class="text-slate-800">--/--/----</span></div>
                                <div class="flex justify-between font-bold uppercase tracking-tighter"><span>Fin :</span> <span id="emp-end-date" class="text-slate-800">--/--/----</span></div>
                            </div>
                            <button onclick="downloadMyBadge()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl text-sm font-black mt-6 shadow-xl active:scale-95 transition-all"><i class="fa-solid fa-id-card mr-2"></i> MON BADGE D'ACCÈS</button>
                        </div>
                    </div>
                </div>

                <!-- COLONNE DROITE : FORMULAIRE -->
                <div class="md:col-span-2 space-y-6">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 h-full">
                        <div class="flex justify-between items-center mb-8"><h3 class="font-bold text-lg text-slate-800">Coordonnées</h3><button onclick="toggleEditMode()" class="text-blue-600 text-sm font-bold bg-blue-50 px-4 py-1.5 rounded-lg active:scale-95 transition-all">Modifier</button></div>
                        <form id="form-self-update" class="space-y-5">
                            <input type="file" id="emp-upload-photo" class="hidden" accept="image/*" onchange="previewPhoto(event)">
                            <div class="grid grid-cols-2 gap-6">
                                <div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Date de Naissance</label><input type="date" id="emp-dob" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none" disabled></div>
                                <div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Téléphone</label><input type="tel" id="emp-phone" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none" disabled></div>
                            </div>
                            <div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Email Personnel</label><input type="email" id="emp-email" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none" disabled></div>
                            <div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Adresse Résidentielle</label><textarea id="emp-address" rows="3" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl resize-none outline-none" disabled></textarea></div>
                            <div id="save-btn-container" class="hidden pt-6 flex justify-end gap-3"><button type="button" onclick="toggleEditMode()" class="px-6 py-3 font-bold text-slate-400 text-sm">Annuler</button><button type="button" onclick="saveMyProfile()" class="bg-blue-600 text-white px-10 py-3 rounded-xl font-black shadow-lg uppercase text-xs">Sauvegarder</button></div>
                        </form>
                    </div>
                </div>
            </div>





            

                <!-- BLOC SUIVI DEMANDES CONGÉS (Employé) -->
    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 mb-8">
        <h3 class="font-black text-xs uppercase text-slate-400 mb-6 flex items-center gap-2 tracking-widest">
            <i class="fa-solid fa-hourglass-half text-blue-500 text-lg"></i> Mes Demandes de Congés
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left whitespace-nowrap">
                <thead class="bg-slate-50/80 text-[10px] uppercase font-black text-slate-400">
                    <tr>
                        <th class="px-6 py-3">Période</th>
                        <th class="px-6 py-3">Type</th>
                        <th class="px-6 py-3">Motif</th>
                        <th class="px-6 py-3 text-right">Statut</th>
                    </tr>
                </thead>
                <tbody id="my-leave-requests-body">
                    <!-- Rempli par le JS -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- FIN BLOC SUIVI DEMANDES CONGÉS -->


            <!-- ZONE BASSE : DOCUMENTS & PAIE (PLEINE LARGEUR MAINTENANT) -->
            <div class="space-y-8">
                
                <!-- BLOC DOCUMENTS -->
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="font-black text-xs uppercase text-slate-400 mb-6 flex items-center gap-2 tracking-widest">
                        <i class="fa-solid fa-folder-open text-yellow-500 text-lg"></i> Mes Documents Administratifs
                    </h3>
                    <!-- Le conteneur ID doc-container sera rempli par le JS en mode grille -->
                    <div id="doc-container" class="w-full"></div>
                </div>















            <!-- Bloc Rapports avec Scroll -->
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 mb-8">
                <div class="flex justify-between items-center mb-4"> <!-- mb réduit -->
                    <h3 class="font-black text-xs uppercase text-slate-400 flex items-center gap-2 tracking-widest">
                        <i class="fa-solid fa-clock-rotate-left text-indigo-500 text-lg"></i> Mes Rapports d'Activité
                    </h3>
                    <button onclick="fetchAttendanceReport('PERSONAL')" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-all">
                        <i class="fa-solid fa-rotate mr-1"></i> Actualiser
                    </button>
                </div>
                
                <!-- ICI : On ajoute max-h-[300px] et custom-scroll -->
                <div id="personal-report-container" class="space-y-3 max-h-[300px] custom-scroll pr-2">
                    <p class="text-[10px] text-slate-400 italic">Cliquez sur actualiser pour voir vos rapports.</p>
                </div>
            </div>



                                        <!-- Bloc Paie avec Scroll -->
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-xs uppercase text-slate-400 flex items-center gap-2 tracking-widest">
                            <i class="fa-solid fa-file-invoice-dollar text-emerald-500 text-lg"></i> Mes Bulletins de Paie
                        </h3>
                        <span class="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-2 py-1 rounded">
                            Total : <span id="count-payroll">0</span>
                        </span>
                    </div>

                    <!-- ICI : Scroll vertical + Grille responsive -->
                    <div class="max-h-[350px] custom-scroll pr-2">
                        <div id="payroll-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Sera rempli par fetchPayrollData() -->
                            <div class="col-span-full text-center py-4 text-slate-400 italic text-xs">Recherche des bulletins...</div>
                        </div>
                    </div>
                </div>



            </div>
        </div>
    </section>




                    <!-- VUE 6: AIDE & INFOS -->
    <section id="view-help" class="view-section">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-8">Centre d'Information</h2>

            <!-- ZONE 1 : FLASH INFO / ANNONCE GÉNÉRALE -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-3xl p-8 text-white shadow-xl mb-10 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="bg-white/20 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/30">Note de service</span>
                        <span class="text-xs font-medium opacity-80"><i class="fa-regular fa-clock mr-1"></i> Mis à jour le 18/01/2026</span>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">Bienvenue sur le nouveau portail SIRH !</h3>
                    <p class="text-blue-100 text-sm leading-relaxed max-w-2xl">
                        Cette application est désormais votre outil unique pour la gestion de vos présences et de vos congés.
                        Pensez à bien <strong>activer la géolocalisation</strong> sur votre téléphone pour valider vos pointages.
                        Pour toute question technique, référez-vous aux guides ci-dessous.
                    </p>
                </div>
                <!-- Déco fond -->
                <i class="fa-solid fa-bullhorn absolute -right-6 -bottom-6 text-9xl opacity-10 rotate-[-20deg]"></i>
            </div>

            <!-- ZONE 2 : GUIDES D'UTILISATION (FAQ) -->
            <h3 class="font-black text-slate-700 uppercase text-sm tracking-widest mb-6">Guides Rapides</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                
                <!-- Carte 1 : Pointage -->
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-xl mb-4">
                        <i class="fa-solid fa-fingerprint"></i>
                    </div>
                    <h4 class="font-bold text-slate-800 mb-2">Comment pointer ?</h4>
                    <p class="text-sm text-slate-500 leading-relaxed mb-4">
                        Le pointage est obligatoire à l'arrivée et au départ.
                        <br>1. Allez sur "Mon Profil".
                        <br>2. Cliquez sur le gros bouton <strong>ENTRÉE</strong>.
                        <br>3. Autorisez la localisation si demandé.
                        <br><em>Note : Le bouton devient ROUGE quand vous êtes en poste.</em>
                    </p>
                </div>

                <!-- Carte 2 : Congés -->
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-xl mb-4">
                        <i class="fa-solid fa-plane-departure"></i>
                    </div>
                    <h4 class="font-bold text-slate-800 mb-2">Demander un congé</h4>
                    <p class="text-sm text-slate-500 leading-relaxed mb-4">
                        Les demandes doivent être faites 48h à l'avance.
                        <br>1. Sur "Mon Profil", cliquez sur "Demander Congé".
                        <br>2. Remplissez les dates et le motif.
                        <br>3. <strong>Joignez un justificatif</strong> (PDF ou Photo) si c'est une maladie.
                        <br>Vous recevrez la réponse de votre manager ici même.
                    </p>
                </div>

                <!-- Carte 3 : Documents -->
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center text-xl mb-4">
                        <i class="fa-solid fa-folder-open"></i>
                    </div>
                    <h4 class="font-bold text-slate-800 mb-2">Mes Documents</h4>
                    <p class="text-sm text-slate-500 leading-relaxed mb-4">
                        Votre contrat signé et vos pièces d'identité sont stockés dans la section "Mes Documents".
                        Vous pouvez cliquer sur l'icône <i class="fa-solid fa-file-arrow-up text-xs"></i> pour mettre à jour une pièce périmée (ex: nouveau passeport).
                    </p>
                </div>

                <!-- Carte 4 : Support -->
                <div class="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-sm text-white">
                    <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center text-xl mb-4">
                        <i class="fa-solid fa-headset"></i>
                    </div>
                    <h4 class="font-bold text-white mb-2">Besoin d'aide ?</h4>
                    <p class="text-sm text-slate-400 leading-relaxed mb-4">
                        Si vous rencontrez un bug ou si vous avez perdu vos accès, contactez le service IT ou RH.
                    </p>
                    <div class="bg-white/10 p-3 rounded-xl flex items-center gap-3">
                        <i class="fa-solid fa-envelope text-blue-400"></i>
                        <span class="font-mono text-xs">support-sirh@entreprise.com</span>
                    </div>
                </div>

            </div>
        </div>
    </section>
                </div>
            </main>
        </div>

        <!-- MODAL DOSSIER COMPLET -->
        <div id="folder-modal" class="fixed inset-0 bg-slate-900/90 hidden flex items-center justify-center z-[150] p-4 backdrop-blur-md">
    <!-- NOUVELLE LIGNE CORRIGÉE -->
    <div class="bg-white w-full max-w-4xl rounded-[2.5rem] shadow-2xl overflow-y-auto md:overflow-hidden flex flex-col md:flex-row h-[90vh] md:h-auto max-h-[95vh]">
            <div class="md:w-1/3 bg-slate-900 p-8 text-white flex flex-col items-center text-center">
                    <div class="w-32 h-32 rounded-3xl bg-slate-800 mb-6 overflow-hidden border-2 border-slate-700 shadow-xl"><img id="folder-photo" class="w-full h-full object-cover"></div>
                    <h3 id="folder-name" class="text-2xl font-black mb-1 uppercase tracking-tight">...</h3>
                    <p id="folder-id" class="text-blue-500 font-mono text-xs mb-6 uppercase tracking-widest">...</p>
                    <div class="w-full space-y-3 text-left bg-white/5 p-4 rounded-2xl border border-white/10 mb-4">
                        <div><p class="text-[10px] text-slate-500 font-bold uppercase">Poste Actuel</p><p id="folder-poste" class="text-sm font-bold">...</p></div>
                        <div><p class="text-[10px] text-slate-500 font-bold uppercase">Département</p><p id="folder-dept" class="text-sm font-bold">...</p></div>
                    </div>
                    <div class="w-full space-y-3 text-left bg-blue-500/10 p-4 rounded-2xl border border-blue-500/20">
                        <div><p class="text-[10px] text-blue-300 font-bold uppercase">Période Contrat</p><p class="text-xs font-bold"><span id="folder-start">--</span> ➔ <span id="folder-end">--</span></p></div>
                    </div>
                    <button onclick="closeFolderModal()" class="mt-8 w-full py-4 rounded-2xl bg-white/10 hover:bg-white/20 transition-all font-bold text-sm">FERMER LE DOSSIER</button>
                </div>
    <!-- REMPLACE PAR CELLE-CI -->
    <div class="flex-1 p-8 md:p-12 md:overflow-y-auto bg-slate-50 min-h-[400px]">
                <h4 class="text-slate-400 font-black text-xs uppercase tracking-widest mb-8 flex items-center gap-2"><div class="h-[1px] flex-1 bg-slate-200"></div> ARCHIVES NUMÉRIQUES <div class="h-[1px] flex-1 bg-slate-200"></div></h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10" id="folder-docs-grid"></div>
                    <h4 class="text-slate-400 font-black text-xs uppercase tracking-widest mb-6 flex items-center gap-2"><div class="h-[1px] flex-1 bg-slate-200"></div> CONTACTS & COORDONNÉES <div class="h-[1px] flex-1 bg-slate-200"></div></h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Email Personnel</p><p id="folder-email" class="font-bold text-slate-800 italic">...</p></div>
                        <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Téléphone Direct</p><p id="folder-phone" class="font-bold text-slate-800">...</p></div>
                        <div class="bg-white p-4 rounded-2xl border shadow-sm md:col-span-2"><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Adresse de Résidence</p><p id="folder-address" class="font-bold text-slate-800">...</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL STATUT -->
    <!-- MODAL ADMINISTRATION (GÉRER) -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-900/90 hidden flex items-center justify-center z-[110] p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl uppercase text-slate-800">Administration Employé</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-800"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <input type="hidden" id="edit-id-hidden">
            
            <form onsubmit="submitUpdate(event)" class="space-y-6">
                <!-- 1. STATUT & RÔLE -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Statut Actuel</label>
                        <select id="edit-statut" class="w-full p-3 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Actif">🟢 Actif</option>
                            <option value="Congé">🟡 En Congé</option>
                            <option value="Sortie">🔴 Sortie Définitive</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Rôle Système</label>
                        <select id="edit-role" class="w-full p-3 border rounded-xl font-bold bg-blue-50 text-blue-700 outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="EMPLOYEE">Employé</option>
                            <option value="MANAGER">Manager</option>
                            <option value="RH">RH</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                </div>

                <!-- 2. DÉPARTEMENT -->
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Département / Service</label>
                    <select id="edit-dept" class="w-full p-3 border rounded-xl font-medium bg-slate-50 outline-none">
                        <option value="IT & Tech">IT & Tech</option>
                        <option value="RH">Ressources Humaines</option>
                        <option value="Finance">Finance & Compta</option>
                        <option value="Marketing">Marketing & Vente</option>
                        <option value="Opérations">Opérations</option>
                        <option value="Sécurité">Sécurité</option>
                    </select>
                </div>

                <!-- 3. CONTRAT (Prolongation) -->
    <!-- 3. GESTION CONTRAT (Initialisation / Renouvellement) -->
    <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
        <p class="text-[10px] font-black text-orange-500 uppercase mb-3 flex items-center gap-2">
            <i class="fa-solid fa-file-contract"></i> Cycle de vie du Contrat
        </p>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Durée / Type</label>
                <select id="edit-type-contrat" class="w-full p-2 bg-white border rounded-lg text-sm font-bold text-slate-700">
                    <option value="365">CDI (1 an renouvel.)</option>
                    <option value="180">CDD (6 mois)</option>
                    <option value="90">Essai (3 mois)</option>
                </select>
            </div>
            <div>
                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Date de début (Effet)</label>
                <!-- Ici, on permet de choisir la date précise -->
                <input type="date" id="edit-start-date" class="w-full p-2 bg-white border rounded-lg text-sm font-bold text-slate-700">
            </div>
        </div>
        <div class="mt-3 flex items-start gap-2">
            <input type="checkbox" id="edit-init-check" class="mt-1 w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500">
            <label for="edit-init-check" class="text-[10px] text-slate-600 leading-tight">
                <strong>Forcer l'initialisation :</strong> Cocher cette case pour réinitialiser le contrat avec la date ci-dessus (Utiliser pour une <u>nouvelle embauche</u> ou un <u>renouvellement</u>).
            </label>
        </div>
    </div>







                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg uppercase tracking-widest hover:bg-slate-800 transition-all">
                    SAUVEGARDER LES MODIFICATIONS
                </button>
            </form>
        </div>
    </div>

        <!-- MODAL CONTRAT SIGNE -->

                                                                        <!-- MODAL SIGNATURE NUMÉRIQUE -->
        <div id="contract-modal" class="fixed inset-0 bg-slate-900/80 hidden flex items-center justify-center z-[110] p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl">
                <h3 class="font-black mb-2 text-xl text-center uppercase text-slate-800">Signature du Contrat</h3>
                <p class="text-slate-400 text-sm text-center mb-8">Signez avec votre doigt ou votre souris dans le cadre ci-dessous pour valider le document.</p>
                <input type="hidden" id="contract-id-hidden">
                
                <div class="flex flex-col items-center p-2 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 mb-8">
                    <!-- LE CADRE DE SIGNATURE -->
                    <canvas id="signature-pad" class="w-full h-48 bg-white rounded-xl border border-slate-200 cursor-crosshair shadow-inner"></canvas>
                    
                    <div class="flex justify-between w-full p-2">
                        <button type="button" onclick="clearSignature()" class="text-[10px] font-black text-red-500 uppercase hover:underline">
                            <i class="fa-solid fa-eraser mr-1"></i> Effacer
                        </button>
                        <span class="text-[9px] text-slate-400 italic font-medium">Signature électronique sécurisée</span>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="submitSignedContract()" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black shadow-lg uppercase text-xs tracking-widest transition-all hover:bg-blue-600 active:scale-95">
                        GÉNÉRER LE PDF SIGNÉ
                    </button>
                    <button onclick="closeContractModal()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold uppercase text-xs">Annuler</button>
                </div>
            </div>
        </div>



        <!-- MODAL DEMANDE CONGÉ -->
        <div id="leave-modal" class="fixed inset-0 bg-slate-900/80 hidden flex items-center justify-center z-[120] p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-xl uppercase text-slate-800">Demande d'Absence</h3>
                    <button onclick="document.getElementById('leave-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <form onsubmit="submitLeaveRequest(event)" class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Type d'absence</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="cursor-pointer"><input type="radio" name="leave_type" value="Congé Payé" class="peer sr-only" checked><div class="p-3 border rounded-xl text-center text-xs font-bold text-slate-500 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all">🏖️ Congé</div></label>
                            <label class="cursor-pointer"><input type="radio" name="leave_type" value="Maladie" class="peer sr-only"><div class="p-3 border rounded-xl text-center text-xs font-bold text-slate-500 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition-all">💊 Maladie</div></label>
                            <label class="cursor-pointer"><input type="radio" name="leave_type" value="Télétravail" class="peer sr-only"><div class="p-3 border rounded-xl text-center text-xs font-bold text-slate-500 peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-500 transition-all">🏠 Autres</div></label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Du (Inclus)</label><input type="date" id="leave-start" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-sm" required></div>
                        <div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Au (Inclus)</label><input type="date" id="leave-end" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-sm" required></div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Motif (Optionnel)</label>
                        <textarea id="leave-reason" rows="2" class="w-full p-3 bg-slate-50 border rounded-xl resize-none text-sm" placeholder="Précisions pour le manager..."></textarea>
                    </div>


                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Justificatif (Optionnel)</label>
                        <div class="flex gap-2">
                            <div id="leave-doc-preview" class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center border text-slate-400">
                                <i class="fa-solid fa-camera"></i>
                            </div>
                            <button type="button" onclick="openDocCamera('leave_justif')" class="flex-1 bg-slate-100 text-slate-600 text-[10px] font-bold py-2 rounded-lg border uppercase">Prendre Photo</button>
                            <button type="button" onclick="document.getElementById('f-leave_justif').click()" class="flex-1 bg-blue-50 text-blue-600 text-[10px] font-bold py-2 rounded-lg border border-blue-100 uppercase">Uploader</button>
                        </div>
                        <input type="file" id="f-leave_justif" class="hidden" onchange="previewDocFile(event, 'leave_justif')">
                    </div>
                                <div class="pt-4">
                        <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black uppercase tracking-widest hover:bg-slate-800 shadow-lg active:scale-95 transition-all">Envoyer la demande</button>
                    </div>
                </form>
            </div>
        </div>









    

                                                                        <!-- MODAL ENVOI FLASH (VERSION AVEC DURÉE) -->
    <div id="flash-modal" class="fixed inset-0 bg-slate-900/90 hidden flex items-center justify-center z-[160] p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl uppercase text-slate-800">Nouvelle Annonce</h3>
                <button onclick="document.getElementById('flash-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-800"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="submitFlashMessage(event)" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Urgence & Durée d'affichage</label>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="flash-input-type" class="p-3 border rounded-xl text-xs font-bold bg-slate-50 outline-none">
                            <option value="Info">ℹ️ Info</option>
                            <option value="Urgent">🚨 Urgent</option>
                            <option value="Maintenance">⚠️ Travaux</option>
                        </select>
                        <select id="flash-input-duration" class="p-3 border rounded-xl text-xs font-bold bg-blue-50 text-blue-700 outline-none">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60" selected>1 heure</option>
                            <option value="120">2 heures</option>
                            <option value="240">4 heures</option>
                            <option value="720">12 heures</option>
                            <option value="1440">1 jour (24h)</option>
                            <option value="2880">2 jours</option>
                            <option value="10080">1 semaine</option>
                        </select>
                                                    
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Message</label>
                    <textarea id="flash-input-msg" rows="4" class="w-full p-4 bg-slate-50 border rounded-xl outline-none font-medium text-sm" placeholder="Votre annonce..." required></textarea>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black uppercase tracking-widest hover:bg-blue-600 shadow-lg transition-all">PUBLIER MAINTENANT</button>
            </form>
        </div>
    </div>











        <script>


            let docBlobs = {
                id_card: null,
                cv: null,
                diploma: null,
                attestation: null,
                leave_justif: null
            };



    // ==========================================
    // CONFIGURATION DE PERSONNALISATION (SAAS)
    // ==========================================
    const SIRH_CONFIG = {
        company: {
            name: "SIRH-SECURE",
            logo: "https://cdn-icons-png.flaticon.com/128/13594/13594876.png",
            supportEmail: "rh@entreprise.com"
        },
        theme: {
            primary: "#0f172a",   // Couleur Sidebar
            accent: "#2563eb",    // Couleur Boutons / Éléments actifs
            fontFamily: "'Plus Jakarta Sans', sans-serif", // Choix de police
            baseFontSize: "16px" // Taille de base (14px ou 16px recommandé)
        },

        // 3. PARAMÈTRES GPS MULTI-SIÈGES
        // Note : Cette liste pourra être remplie dynamiquement par Airtable plus tard
        gps: {
            enabled: true,         // Activer la vérification GPS ?
            strictMode: true,      // Bloquer le pointage si hors zone ?
            
            // Liste des sièges autorisés
            offices: []
        },

        // 4. MODULES ACTIFS
        features: {
            recruitment: true,
            payroll: true,
            auditLogs: true
        },

        // 5. SERVEUR (BASE API)
        apiBaseUrl: "https://mon-api-rh.onrender.com/api"
    };

    // --- GÉNÉRATION AUTOMATIQUE DES LIENS ---
    // (On utilise SIRH_CONFIG.apiBaseUrl pour ne rien changer en bas)
    const URL_LOGIN = `${SIRH_CONFIG.apiBaseUrl}/login`; 
    const URL_READ = `${SIRH_CONFIG.apiBaseUrl}/read`; 
    const URL_WRITE_POST = `${SIRH_CONFIG.apiBaseUrl}/write`; 
    const URL_UPDATE = `${SIRH_CONFIG.apiBaseUrl}/update`; 
    const URL_READ_LOGS = `${SIRH_CONFIG.apiBaseUrl}/read-logs`; 
    const URL_GATEKEEPER = `${SIRH_CONFIG.apiBaseUrl}/gatekeeper`; 
    const URL_BADGE_GEN = `${SIRH_CONFIG.apiBaseUrl}/badge`; 
    const URL_EMPLOYEE_UPDATE = `${SIRH_CONFIG.apiBaseUrl}/emp-update`;
    const URL_CONTRACT_GENERATE = `${SIRH_CONFIG.apiBaseUrl}/contract-gen`;
    const URL_UPLOAD_SIGNED_CONTRACT = `${SIRH_CONFIG.apiBaseUrl}/contract-upload`;
    const URL_LEAVE_REQUEST = `${SIRH_CONFIG.apiBaseUrl}/leave`;  
    const URL_CLOCK_ACTION = `${SIRH_CONFIG.apiBaseUrl}/clock`;
    const URL_READ_LEAVES = `${SIRH_CONFIG.apiBaseUrl}/read-leaves`;
    const URL_LEAVE_ACTION = `${SIRH_CONFIG.apiBaseUrl}/leave-action`;
    const URL_READ_CANDIDATES = `${SIRH_CONFIG.apiBaseUrl}/read-candidates`; 
    const URL_CANDIDATE_ACTION = `${SIRH_CONFIG.apiBaseUrl}/candidate-action`;
    const URL_READ_PAYROLL = `${SIRH_CONFIG.apiBaseUrl}/read-payroll`;
    const URL_READ_FLASH = `${SIRH_CONFIG.apiBaseUrl}/read-flash`;
    const URL_WRITE_FLASH = `${SIRH_CONFIG.apiBaseUrl}/write-flash`;
    const URL_READ_REPORT = `${SIRH_CONFIG.apiBaseUrl}/read-report`;
    const URL_GET_CONFIG = `${SIRH_CONFIG.apiBaseUrl}/read-config`;


            const SCAN_KEY = "SIGD_SECURE_2025"; 
            const URL_REDIRECT_FAILURE = "https://google.com";

            // SON DE NOTIFICATION (Bip professionnel)
            const NOTIF_SOUND = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
            let currentView = 'dash'; 
            let allLeaves = []; // Pour stocker tous les congés et les comparer
            let myPayrolls = [];
            let currentFilter = 'all';
    
            // ÉTAPE 1 : Mémoire des derniers chargements (pour économiser les crédits Make)
            let lastFetchTimes = {
                global: 0,      // Pour la config GPS
                employees: 0,   // Pour la liste de base
                leaves: 0,      // Pour les congés
                candidates: 0,  // Pour le recrutement
                payroll: 0,     // Pour la paie
                flash: 0        // Pour les annonces
            };

            // On définit un délai de "fraîcheur" de 5 minutes (300 000 millisecondes)
            // L'app ne demandera pas de mise à jour au serveur avant ce délai, sauf si on l'y force.
            const REFRESH_THRESHOLD = 300000;




            // Variable globale qui stockera les infos du bureau
            let companyConfig = {
                latitude: null,      
                longitude: null,     
                radius: 100,         // Rayon par défaut (mètres)
                geo_required: false  // Force le GPS ou non
            };

            let currentUser = null, employees = [], videoStream = null, capturedBlob = null, contractBlob = null, contractStream = null, signaturePad = null;
         
            
            let offsetSuivant = null; // Mémorise le marque-page pour le lot suivant
            let currentPage = 1;
            const ITEMS_PER_PAGE = 10; // Nombre d'employés par page



            window.addEventListener('DOMContentLoaded', () => {
                applyBranding(); 
                const session = localStorage.getItem('sirh_user_session');
                const loader = document.getElementById('initial-loader');

                if(session) {
                    try {
                        const u = JSON.parse(session);
                        if(u && u.nom) {
                            console.log("Restauration session : " + u.nom);
                            // On connecte l'utilisateur
                            setSession(u.nom, u.role, u.id);
                            
                                            // Dans window.addEventListener('DOMContentLoaded', ...)
            
            // ... (après setSession) ...
                                
                                // On laisse le loader 1 seconde (1000ms) pour faire "Pro"
                                setTimeout(() => {
                                    const loader = document.getElementById('initial-loader');
                                    loader.style.opacity = '0';
                                    loader.style.transform = 'scale(1.1)'; // Petit effet de zoom en disparaissant
                                    setTimeout(() => loader.classList.add('hidden'), 700);
                                }, 1200);

                            
                        } else {
                            throw new Error("Session invalide");
                        }
                    } catch(e) { 
                        // Si erreur de lecture, on nettoie et on montre le login
                        localStorage.removeItem('sirh_user_session');
                        loader.classList.add('hidden');
                    }
                } else {
                    // Pas de session, on montre immédiatement le login
                    loader.classList.add('hidden');
                }
            });









            document.getElementById('current-date').innerText = new Date().toLocaleDateString('fr-FR');


                    let chartStatusInstance = null;
                    let chartDeptInstance = null;

            // Fonction mathématique pour calculer la distance entre deux points GPS
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Rayon de la terre en mètres
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Résultat en mètres
            }


            
                                                                                                                                            async function downloadMyBadge() {
        // 1. Sécurité : Vérifier que la liste n'est pas vide
        if (!employees || employees.length === 0) {
            return Swal.fire('Patientez', 'Le système charge vos données...', 'info');
        }

        // 2. LOGIQUE DE RECHERCHE IDENTIQUE À loadMyProfile (qui fonctionne chez toi)
        const cleanUser = currentUser.nom.toLowerCase().replace(/[\.-_]/g, ' ').trim();

        let myData = employees.find(e => {
            const cleanEmp = e.nom.toLowerCase().replace(/[\.-_]/g, ' ').trim();
            return cleanEmp.includes(cleanUser) || cleanUser.includes(cleanEmp);
        });

        // 3. Fallback par ID au cas où
        if (!myData && currentUser.id) {
            myData = employees.find(e => String(e.id) === String(currentUser.id));
        }

        // 4. Si on ne trouve toujours rien
        if (!myData) {
            console.error("Badge Error: Impossible de trouver cet l'employé", currentUser.nom);
            return Swal.fire('Erreur', 'Impossible de localiser votre fiche employé pour générer le badge.', 'error');
        }

        // 5. Lancement de la génération
        const token = localStorage.getItem('sirh_token');
        Swal.fire({ 
            title: 'Génération du badge...', 
            text: 'Veuillez patienter',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false 
        });

        try {
            // On formate la photo pour qu'elle soit visible sur le badge
            const photoUrl = myData.photo ? formatGoogleLink(myData.photo) : '';

            // Construction de l'URL vers ton API de badge
            const url = `${URL_BADGE_GEN}?id=${encodeURIComponent(myData.id)}&nom=${encodeURIComponent(myData.nom)}&poste=${encodeURIComponent(myData.poste)}&photo=${encodeURIComponent(photoUrl)}&agent=${encodeURIComponent(currentUser.nom)}&token=${token}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error("Erreur serveur");

            const htmlContent = await response.text();
            Swal.close();

            // Ouverture de la fenêtre d'impression
            const w = window.open('', '_blank', 'width=450,height=700');
            if (w) {
                w.document.open();
                w.document.write(htmlContent);
                w.document.close();
            } else {
                Swal.fire('Pop-up bloqué', 'Veuillez autoriser les fenêtres surgissantes pour voir votre badge.', 'warning');
            }

        } catch (error) {
            console.error(error);
            Swal.fire('Erreur', 'Une erreur technique est survenue.', 'error');
        }
    }











    async function requestNotificationPermission() {
        if (!("Notification" in window)) {
            console.log("Ce navigateur ne supporte pas les notifications.");
            return;
        }

        if (Notification.permission !== "granted") {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                console.log("Permission notifications accordée !");
            }
        }
    }














    








async function secureFetch(url, options = {}) {
    // 0. SÉCURITÉ RÉSEAU IMMÉDIATE
    if (!navigator.onLine) {
        throw new Error("Vous êtes hors ligne. Vérifiez votre connexion internet.");
    }

    const token = localStorage.getItem('sirh_token');
    const headers = options.headers || {};
    
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    // --- CORRECTION ICI : ON PASSE DE 60000 à 120000 (2 minutes) ---
    // Cela laisse le temps à Render/Make de se réveiller sans planter
    const TIMEOUT_MS = 120000; 
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS); 

    try {
        // 2. APPEL RÉSEAU
        const response = await fetch(url, { 
            ...options, 
            headers, 
            signal: controller.signal 
        });

        clearTimeout(timeoutId); 

        // 3. GESTION DES ERREURS HTTP
        if (!response.ok) {
            let errorMessage = `Erreur serveur (${response.status})`;
            let specificMessage = null; 

            try {
                const errData = await response.json();
                if (errData.error) {
                    errorMessage = errData.error;
                    specificMessage = errData.error; 
                }
            } catch (e) { }

            if (response.status === 401 || response.status === 403) {
                if (specificMessage) {
                    throw new Error(`AUTH_ERROR_SPECIFIC:${specificMessage}`);
                }
                throw new Error("Session expirée. Veuillez vous reconnecter.");
            }
            
            throw new Error(errorMessage);
        }

        return response;

    } catch (error) {
        // 4. GESTION DES ERREURS TECHNIQUES
        if (error.name === 'AbortError') {
            // Message plus clair pour l'utilisateur
            throw new Error("Le serveur démarre (Délai > 2min). Veuillez réessayer dans 30 secondes.");
        }
        if (error.message.includes('Failed to fetch')) {
            throw new Error("Erreur de connexion. Vérifiez votre accès internet.");
        }
        throw error; 
    }
}












    async function handleLogin(e) { 
                e.preventDefault(); 
                // Déverrouille l'audio pour mobile
                NOTIF_SOUND.play().then(() => { NOTIF_SOUND.pause(); NOTIF_SOUND.currentTime = 0; }).catch(() => {});
                
                // On tente quand même, même si le navigateur dit hors ligne (parfois il se trompe)
                // if(!navigator.onLine) ... <-- SUPPRIMÉ
                
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                const btn = document.getElementById('btn-login');
                const originalBtnText = btn.innerHTML; 
                
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Connexion...'; 
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); 

                try {
                    const response = await fetch(`${URL_LOGIN}?u=${encodeURIComponent(u.toLowerCase())}&p=${encodeURIComponent(p)}`, { signal: controller.signal });
                    clearTimeout(timeoutId); 
                    
                    const d = await response.json();
                    
                    if(d.status === "success") { 
                        if(d.token) localStorage.setItem('sirh_token', d.token);
                        let r = d.role || "EMPLOYEE"; if(Array.isArray(r)) r = r[0]; 
                        
                        const userData = { nom: d.nom || u, role: String(r).toUpperCase(), id: d.id };
                        localStorage.setItem('sirh_user_session', JSON.stringify(userData));

                        const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 2000});
                        Toast.fire({icon: 'success', title: 'Bienvenue ' + userData.nom});
                        
                    await setSession(userData.nom, userData.role, userData.id); 
                    } else { 
                        Swal.fire('Refusé', 'Identifiant ou mot de passe incorrect', 'error'); 
                    }
                } catch (error) {
                    // C'est ICI qu'on gère vraiment l'erreur de connexion
                    console.error(error);
                    if (error.name === 'AbortError') { 
                        Swal.fire('Délai dépassé', 'Le serveur met du temps à répondre. Vérifiez votre connexion.', 'warning'); 
                    } else if (!navigator.onLine) {
                        Swal.fire('Hors Ligne', 'Vous semblez déconnecté d\'internet.', 'error');
                    } else { 
                        Swal.fire('Erreur Système', 'Impossible de contacter le serveur. Réessayez.', 'error'); 
                    }
                } finally {
                    btn.innerHTML = originalBtnText; btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }











async function setSession(n, r, id) {
    currentUser = { nom: n, role: r, id: id };
    applyBranding();
    
    // 1. Cacher le login, mais GARDER le loader affiché et actif
    document.getElementById('login-screen').classList.add('hidden');
    const loader = document.getElementById('initial-loader');
    const appLayout = document.getElementById('app-layout');
    
    if (loader) {
        loader.classList.remove('hidden');
        loader.style.opacity = '1';
    }

    // 2. Préparer l'identité en arrière-plan (invisible sous le loader)
    document.getElementById('name-display').innerText = n; 
    document.getElementById('role-display').innerText = r; 
    document.getElementById('avatar-display').innerText = n[0]; 
    // Dans la fonction setSession, assurez-vous d'avoir ceci :

                                                // Dans la fonction setSession :
    


    // Continuez avec le reste (document.body.className = ...)

    document.body.className = "text-slate-900 overflow-hidden h-screen w-screen role-" + r.toLowerCase(); 

    // 3. Injecter les SKELETONS immédiatement pour l'état initial de l'app
    const skeletonRow = `<tr class="border-b"><td class="p-4 flex gap-3 items-center"><div class="w-10 h-10 rounded-full skeleton"></div><div class="space-y-2"><div class="h-3 w-24 rounded skeleton"></div></div></td><td class="p-4"><div class="h-3 w-32 rounded skeleton"></div></td><td class="p-4"><div class="h-6 w-16 rounded-lg skeleton"></div></td><td class="p-4"></td></tr>`;
    ['full-body', 'dashboard-body'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = skeletonRow.repeat(6);
    });

    // 4. CHARGEMENT RÉEL DES DONNÉES
    // L'exécution s'arrête ici tant que fetchData/Make n'a pas répondu. 
    // La barre de chargement (animée par CSS) continue donc de tourner.
    try {
        await refreshAllData(true); 
        // Petit délai de confort pour laisser le navigateur dessiner les tableaux
        await new Promise(resolve => setTimeout(resolve, 500)); 
    } catch (e) {
        console.warn("Erreur chargement:", e);
    }

    // Vue par défaut (toujours masquée par le loader)
    if (r === 'EMPLOYEE') { 
        document.getElementById('nav-admin-section').style.display = 'none';
        document.getElementById('global-search-container').style.display = 'none';
        switchView('my-profile'); 
    } else { 
        switchView('dash'); 
    }

    // 5. RÉVÉLATION (L'App est prête, on l'affiche et on retire le loader)
    appLayout.classList.remove('hidden');
    
    setTimeout(() => {
        appLayout.classList.add('ready'); // Déclenche le fondu enchaîné CSS
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.classList.add('hidden');
                // On rétablit le fond clair standard une fois le chargement fini
                document.body.style.backgroundColor = "#f1f5f9";
            }, 800); // Temps du fondu de sortie
        }
    }, 100);

    requestNotificationPermission();
    initDarkMode();
    syncClockInterface(); 
}











// --- AJOUTE BIEN CETTE FONCTION POUR LE SCAN MANUEL ---
async function triggerManualContractUpload(employeeId) {
    const { value: file } = await Swal.fire({
        title: 'Contrat scanné / Physique',
        text: 'Sélectionnez le PDF ou prenez une photo du contrat signé manuellement.',
        input: 'file',
        inputAttributes: {
            'accept': 'application/pdf,image/*',
            'aria-label': 'Uploader le contrat'
        },
        showCancelButton: true,
        confirmButtonText: 'Envoyer le document',
        confirmButtonColor: '#10b981',
        cancelButtonText: 'Annuler'
    });

    if (file) {
        Swal.fire({
            title: 'Envoi en cours...',
            text: 'Le fichier est en cours d\'archivage...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const fd = new FormData();
        fd.append('id', employeeId);
        fd.append('contract_file', file);
        fd.append('mode', 'manual_scan');
        fd.append('agent', currentUser.nom);

        try {
            const response = await fetch(URL_UPLOAD_SIGNED_CONTRACT, {
                method: 'POST',
                body: fd
            });

            if (response.ok) {
                Swal.fire('Succès !', 'Contrat scanné enregistré.', 'success');
                refreshAllData();
            } else {
                throw new Error("Erreur serveur lors de l'upload");
            }
        } catch (error) {
            Swal.fire('Échec', error.message, 'error');
        }
    }
}


async function fetchCompanyConfig() {
    try {
        // On suppose que tu as créé une route Make qui renvoie la liste des zones
        // Si tu l'as mise dans ton URL_READ global, adapte l'URL
        const response = await secureFetch(`${URL_GET_CONFIG}?agent=${encodeURIComponent(currentUser.nom)}&type=zones`);
        const data = await response.json();

        // Si on reçoit une liste (Array) de zones
        if (Array.isArray(data) && data.length > 0) {
            console.log("📍 Zones chargées depuis le serveur :", data.length);
            
            // On écrase la config vide par celle du serveur
            SIRH_CONFIG.gps.offices = data.map(z => ({
                name: z.Nom || z.name || "Zone Inconnue", // Adapte selon tes noms de colonnes Airtable/Make
                lat: parseFloat(z.Latitude || z.lat),
                lon: parseFloat(z.Longitude || z.lon),
                radius: parseInt(z.Rayon || z.radius) || 50
            }));
            
            console.log("✅ Configuration GPS mise à jour :", SIRH_CONFIG.gps.offices);
        }
    } catch (e) {
        console.warn("⚠️ Impossible de charger les zones GPS (Utilisation secours ou vide)", e);
        // Optionnel : Tu peux définir une zone de secours ici en dur si le réseau échoue
    }
}


    async function refreshAllData(force = false) {
        const now = Date.now();
        const icon = document.getElementById('refresh-icon'); 
        if(icon) icon.classList.add('fa-spin');

        if(force) {
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false});
            Toast.fire({icon: 'info', title: 'Actualisation...'});
        }

        try {
            const tasks = [];

            // 1. GPS & Flash (inchangé)
            if (force || (now - lastFetchTimes.global > 3600000)) {
                tasks.push(fetchCompanyConfig().catch(e => console.warn("GPS ignoré", e)));
            }
            tasks.push(fetchFlashMessage().catch(e => console.warn("Flash ignoré", e)));

            // --- CORRECTION MAJEURE ICI ---
            // Avant, on ne chargeait pas si on était sur 'my-profile'.
            // Maintenant, si la liste 'employees' est vide, ON FORCE LE CHARGEMENT.
            // C'est ça qui va déclencher le Webhook pour l'employé.
            if (force || employees.length === 0 || (now - lastFetchTimes.employees > REFRESH_THRESHOLD)) {
                // On attend que les données soient là avant de continuer
                await fetchData(force); 
                lastFetchTimes.employees = now;
            }

            // 3. Autres chargements spécifiques (inchangé)
            if (currentView === 'recruitment') tasks.push(fetchCandidates());
            if (currentView === 'logs') tasks.push(fetchLogs());
            if (currentView === 'my-profile') {
                loadMyProfile(); // On recharge l'affichage local
                tasks.push(fetchPayrollData()); // On va chercher les bulletins
            }
            if (currentUser.role !== 'EMPLOYEE') {
                tasks.push(fetchLeaveRequests());
                fetchEmployeeLeaveBalances(); // <--- AJOUTE L'APPEL ICI !

            }
            
            else {
                    // AJOUTE CET APPEL ICI : L'employé doit aussi charger ses propres demandes
                    tasks.push(fetchLeaveRequests()); 
                }

            await Promise.all(tasks);
            
            // Mise à jour finale de l'interface
            if (currentView === 'dash') renderCharts();

            if(force) {
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 2000});
                Toast.fire({icon: 'success', title: 'Données à jour !'});
            }

        } catch (error) {
            console.error("Erreur Sync:", error);
        } finally {
            if(icon) setTimeout(() => icon.classList.remove('fa-spin'), 500);
        }
    }












    async function triggerGlobalPush(title, message) {
        // 1. SON (Ordi et Mobile déverrouillé)
        NOTIF_SOUND.play().catch(e => console.log("Audio en attente d'interaction"));

        // 2. VIBRATION (Android uniquement, iOS ne l'autorise pas en JS web)
        if ("vibrate" in navigator) {
            navigator.vibrate([200, 100, 200]);
        }

        // 3. NOTIFICATION (Méthode PWA Mobile)
        if (Notification.permission === "granted") {
            // On vérifie si on est dans la PWA (Service Worker)
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                const reg = await navigator.serviceWorker.ready;
                reg.showNotification(title, {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/9322/9322127.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/9322/9322127.png',
                    vibrate: [200, 100, 200],
                    tag: 'flash-info', // Évite de cumuler 50 notifications
                    renotify: true
                });
            } else {
                // Fallback pour ordinateur
                new Notification(title, { body: message });
            }
        }
    }






    async function fetchData(forceUpdate = false) {
        console.log("🚀 fetchData lancée. Force:", forceUpdate, "Role:", currentUser.role);

        const CACHE_KEY = 'sirh_data_v1';
        
        // 1. On construit l'URL
        let fetchUrl = `${URL_READ}?agent=${encodeURIComponent(currentUser.nom)}`;

        // Si c'est un employé, on ajoute son ID pour aider Make à filtrer (optionnel mais recommandé)
        if (currentUser.role === 'EMPLOYEE') {
            fetchUrl += `&target_id=${encodeURIComponent(currentUser.id)}`;
        }

        try {
            console.log("📞 Appel API vers :", fetchUrl);
            
            // 2. Appel Réseau
            const r = await secureFetch(fetchUrl);
            const d = await r.json();

            console.log("✅ Réponse reçue :", d.length, "enregistrements");

            // 3. Mapping (Nettoyage des données)
            employees = d.map(x => {
                const getRawLink = (l) => {
                    if (!l) return '';
                    if (Array.isArray(l) && l.length > 0) return l[0].url || l[0];
                    if (typeof l === 'object' && l.url) return l.url;
                    return String(l);
                };  

                return { 
                    id: x.employee_id || x.id, 
                    nom: x.nom || x.Nom, 
                    date: x.date_embauche || x.date, 
                    poste: x.poste || x.Poste, 
                    dept: x['département'] || x.departement || "Non défini", 
                    Solde_Conges: parseFloat(x.Solde_Conges) || 0,// on utilise le nom exact
                    limit: x.type_contrat || 365, 
                    photo: x.photo || x.Photo || '', 
                    statut: x.Statut || 'Actif', 
                    email: x.email, 
                    telephone: x.telephone || x['téléphone'], 
                    adresse: x.adresse, 
                    date_naissance: x.date_naissance, 
                    role: x.role || x.Role || 'EMPLOYEE',
                    doc: getRawLink(x.contrat_pdf || x.doc),
                    contract_status: x.contract_status || 'Non signé',
                    cv_link: getRawLink(x.cv_link),
                    id_card_link: getRawLink(x.id_card_link),
                    diploma_link: getRawLink(x.diploma_link),
                    attestation_link: getRawLink(x.attestation_link || x.attestation),
                    lm_link: getRawLink(x.lm_link),
                };
            });

            // 4. Sauvegarde Cache
            localStorage.setItem(CACHE_KEY, JSON.stringify(employees));
            localStorage.setItem(CACHE_KEY + '_time', Date.now());

            // 5. Mise à jour Interface
            renderData();
            renderCharts();

            // 6. Si Manager, on charge les congés
            if (currentUser.role !== 'EMPLOYEE') {
                fetchLeaveRequests();
            }

        } catch (e) {
            console.error("❌ ERREUR FETCH:", e);
            
            // En cas d'erreur, on essaie quand même d'afficher le cache si dispo
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                console.log("⚠️ Utilisation du cache de secours");
                employees = JSON.parse(cached);
                renderData();
                loadMyProfile();
            } else {
                Swal.fire('Erreur Connexion', 'Impossible de charger vos informations.', 'error');
            }
        }
    }
            











    function renderData() { 
        const b = document.getElementById('full-body'); 
        const d = document.getElementById('dashboard-body'); 
        b.innerHTML = ''; 
        d.innerHTML = ''; 
        
        let total = 0, alertes = 0, actifs = 0; 

        // --- 1. CALCUL DES STATS (Sur TOUT l'effectif) ---
        employees.forEach(e => { 
            total++; 
            const rawStatus = (e.statut || 'Actif').toLowerCase().trim();
            const isSortie = rawStatus.includes('sortie'); 
            
            if (rawStatus === 'actif') actifs++; 
            
            let dL = 999, isU = false, isExpired = false;
            
            if(e.date && !isSortie) { 
                let sD = parseDateSmart(e.date); 
                let eD = new Date(sD); 
                eD.setDate(eD.getDate() + (parseInt(e.limit) || 365));
                dL = Math.ceil((eD - new Date()) / 86400000); 

                if (dL < 0) { isExpired = true; alertes++; } 
                else if (dL <= 15) { isU = true; alertes++; }

                if(isExpired || isU) {
                    d.innerHTML += `<tr class="bg-white border-b"><td class="p-4 text-sm font-bold text-slate-700">${escapeHTML(e.nom)}</td><td class="p-4 text-xs text-slate-500">${escapeHTML(e.poste)}</td><td class="p-4 ${isExpired ? 'text-red-600' : 'text-orange-600'} font-bold text-xs uppercase">${isExpired ? 'Expiré' : dL + ' jours'}</td><td class="p-4 rh-only text-right"><button class="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold" onclick="openEditModal('${escapeHTML(e.id)}')">GÉRER</button></td></tr>`; 
                }
            }
        }); 

        // --- 2. FILTRAGE POUR L'AFFICHAGE ---
        let filteredEmployees = employees;
        
        if (typeof currentFilter !== 'undefined' && currentFilter !== 'all') {
            filteredEmployees = employees.filter(e => {
                const safeStatut = (e.statut || "").toLowerCase();
                const safeDept = (e.dept || "").toLowerCase();
                const search = currentFilter.toLowerCase();
                
                // Logique de correspondance (exacte ou partielle)
                return safeStatut.includes(search) || safeDept.includes(search);
            });
        }

        // --- 3. PAGINATION SUR LA LISTE FILTRÉE ---
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);

        paginatedEmployees.forEach(e => {
            const rawStatus = (e.statut || 'Actif').toLowerCase().trim();
            let dL = 999, isU = false, isExpired = false;
            const isSortie = rawStatus.includes('sortie');
            const isConges = rawStatus.includes('cong');
            
            if(e.date && !isSortie) {
                let sD = parseDateSmart(e.date); 
                let eD = new Date(sD); 
                eD.setDate(eD.getDate() + (parseInt(e.limit) || 365));
                dL = Math.ceil((eD - new Date()) / 86400000); 
                if (dL < 0) isExpired = true;
                else if (dL <= 15) isU = true;
            }

            let bdgClass = "bg-green-100 text-green-700";
            let bdgLabel = e.statut || 'Actif';

            if(isSortie) { 
                bdgClass = "bg-slate-100 text-slate-500"; 
                bdgLabel = "SORTIE"; 
            } else if(isExpired) { 
                bdgClass = "bg-red-100 text-red-700 font-bold border border-red-200"; 
                bdgLabel = `EXPIRÉ`; 
            } else if(isU) { 
                bdgClass = "bg-orange-100 text-orange-700 animate-pulse font-bold"; 
                bdgLabel = `FIN: ${dL}j`; 
            } else if(isConges) { 
                bdgClass = "bg-blue-100 text-blue-700"; 
                bdgLabel = "CONGÉ"; 
            }

            const av = e.photo && e.photo.length > 10 ? `<img src="${formatGoogleLink(e.photo)}" loading="lazy" decoding="async" class="w-10 h-10 rounded-full object-cover bg-slate-200 border border-slate-200">` : `<div class="w-10 h-10 bg-gradient-to-br from-slate-100 to-slate-200 border border-slate-200 rounded-full flex items-center justify-center text-xs font-black text-slate-500">${escapeHTML(e.nom).substring(0,2).toUpperCase()}</div>`;
            
            const sStr = String(e.contract_status || '').toLowerCase().trim(); 
            const isSigned = (sStr === 'signé' || sStr === 'signe');
            
            const safeId = escapeHTML(e.id);
    


 const contractActions = `
<div class="flex items-center justify-end gap-2">
    <!-- DOSSIER COMPLET -->
    <button onclick="openFullFolder('${safeId}')" title="Dossier Complet" class="p-2 bg-yellow-50 text-yellow-600 rounded-lg hover:bg-yellow-500 hover:text-white transition-all"><i class="fa-solid fa-folder-open"></i></button>
    
    <div class="h-4 w-[1px] bg-slate-200 mx-1"></div>

    ${!isSigned ? `
        <!-- 1. GÉNÉRER LE BROUILLON (Le bouton qui manquait) -->
        <button onclick="generateDraftContract('${safeId}')" title="Générer le brouillon PDF" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
            <i class="fa-solid fa-file-contract"></i>
        </button>

        <!-- 2. OPTION A : SIGNATURE ÉLECTRONIQUE (AUTO) -->
        <button onclick="openContractModal('${safeId}')" title="Signature sur écran" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all">
            <i class="fa-solid fa-pen-nib"></i>
        </button>

        <!-- 3. OPTION B : SCAN / UPLOAD MANUEL -->
        <button onclick="triggerManualContractUpload('${safeId}')" title="Uploader un contrat scanné" class="p-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-600 hover:text-white transition-all">
            <i class="fa-solid fa-file-arrow-up"></i>
        </button>
    ` : `
        <span class="text-[10px] font-black text-emerald-500 uppercase bg-emerald-50 px-2 py-1 rounded">Signé</span>
    `}

    <div class="h-4 w-[1px] bg-slate-200 mx-1"></div>
    
    <!-- BADGE ET MODIFICATION -->
    <button onclick="printBadge('${safeId}')" class="text-slate-400 hover:text-blue-600 transition-all"><i class="fa-solid fa-print"></i></button>
    <button onclick="openEditModal('${safeId}')" class="text-slate-400 hover:text-slate-800 transition-all"><i class="fa-solid fa-pen"></i></button>
</div>`;



            
            b.innerHTML+=`<tr class="border-b hover:bg-slate-50 transition-colors"><td class="p-4 flex gap-3 items-center min-w-[200px]">${av}<div><div class="font-bold text-sm text-slate-800 uppercase">${escapeHTML(e.nom)}</div><div class="text-[10px] text-slate-400 font-mono tracking-tighter">${safeId}</div></div></td><td class="p-4 text-xs font-medium text-slate-500">${escapeHTML(e.poste)}</td><td class="p-4"><span class="px-3 py-1 border rounded-lg text-[10px] font-black uppercase ${bdgClass}">${escapeHTML(bdgLabel)}</span></td><td class="p-4 rh-only">${contractActions}</td></tr>`; 
        });

        // Mises à jour UI
        document.getElementById('stat-total').innerText = total; 
        document.getElementById('stat-alert').innerText = alertes; 
        document.getElementById('stat-active').innerText = actifs;

        // Mise à jour pagination avec la liste FILTRÉE
        const totalPages = Math.ceil(filteredEmployees.length / ITEMS_PER_PAGE);
        document.querySelectorAll('.page-info-global').forEach(el => { el.innerText = `PAGE ${currentPage} / ${totalPages || 1}`; });
        document.querySelectorAll('.btn-prev-global').forEach(btn => { btn.disabled = currentPage === 1; btn.classList.toggle('opacity-30', currentPage === 1); });
        document.querySelectorAll('.btn-next-global').forEach(btn => { btn.disabled = currentPage >= totalPages; btn.classList.toggle('opacity-30', currentPage >= totalPages); });
    }











    // 1. LA FONCTION DE CHOIX (PICKER)
async function openAttendancePicker() {
    Swal.fire({
        title: 'Rapport de Présence',
        text: 'Quelle période souhaitez-vous consulter ?',
        icon: 'question',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: '🕒 Aujourd\'hui',
        denyButtonText: '📅 Mensuel (Cumul)',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#4f46e5',
        denyButtonColor: '#0f172a',
    }).then((result) => {
        if (result.isConfirmed) {
            fetchAttendanceReport('GLOBAL', 'today');
        } else if (result.isDenied) {
            fetchAttendanceReport('GLOBAL', 'monthly');
        }
    });
}














// 2. LA FONCTION DE RÉCUPÉRATION (FETCH) - VERSION FINALE CORRIGÉE
async function fetchAttendanceReport(mode = 'PERSONAL', period = 'monthly') {
    const container = document.getElementById('personal-report-container');
    
    if (mode === 'GLOBAL') {
        Swal.fire({ title: 'Chargement...', text: 'Récupération des données en cours', didOpen: () => Swal.showLoading() });
    } else {
        if(container) container.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-circle-notch fa-spin text-indigo-500"></i></div>';
    }

    try {
        const url = `${URL_READ_REPORT}?agent=${encodeURIComponent(currentUser.nom)}&requester_id=${encodeURIComponent(currentUser.id)}&mode=${mode}&period=${period}`;
        const r = await secureFetch(url);
        const rawReports = await r.json();

        // --- DEBUT : NORMALISATION DES DONNÉES POUR L'EXPORT ET L'AFFICHAGE ---
        const cleanReports = rawReports.map(rep => {
            // Récupère la valeur du nom (gère les listes)
            let nomRaw = rep.nom || rep['nom (from Employé)'] || rep.Employé || 'Inconnu';
            let nomAffiche = Array.isArray(nomRaw) ? nomRaw[0] : nomRaw;

            // Retourne un objet avec des clés simples et sans accents
            return {
                mois: rep.mois || rep['Mois/Année'] || '-',
                nom: nomAffiche,
                jours: rep.jours || rep['Jours de présence'] || 0,
                heures: rep.heures || rep['Total Heures'] || 0,
                statut: rep.Statut || 'Clôturé',
                // Pour le rapport "Today" :
                heure_arrivee: rep.heure || rep.Heure || '--:--',
                zone: rep.zone || rep.Zone || 'Bureau'
            };
        });
        // --- FIN : NORMALISATION ---
        
        if (mode === 'GLOBAL') {
            let tableHtml = '';
            
            if (period === 'today') {
                // --- RAPPORT JOURNALIER ---
                const totalActifs = employees.filter(e => e.statut === 'Actif').length;
                const presents = cleanReports.length; // <-- UTILISE cleanReports
                const taux = totalActifs > 0 ? Math.round((presents / totalActifs) * 100) : 0;

                tableHtml = `
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <div class="text-center sm:text-left">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Taux de présence (Actifs)</p>
                            <h3 class="text-2xl font-black text-indigo-600">${presents} / ${totalActifs} <span class="text-sm text-slate-400">Présents</span></h3>
                        </div>
                        <div class="w-16 h-16 rounded-full border-4 border-indigo-100 flex items-center justify-center font-black text-indigo-600 bg-white shadow-sm">${taux}%</div>
                        <button onclick="downloadReportCSV('${period}')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase shadow hover:bg-emerald-700 transition-all flex items-center gap-2"><i class="fa-solid fa-file-csv"></i> Excel</button>
                    </div>
                    <div class="overflow-x-auto max-h-[50vh]">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="bg-slate-100 text-[10px] uppercase font-black text-slate-500 sticky top-0">
                                <tr><th class="p-3">Employé</th><th class="p-3 text-center">Arrivée</th><th class="p-3 text-center">Zone</th><th class="p-3 text-right">Statut</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 text-xs">
                `;

                // UTILISE cleanReports ICI
                cleanReports.forEach(item => {
                    let hAffiche = item.heure_arrivee.match(/(\d{2}:\d{2})/) ? item.heure_arrivee.match(/(\d{2}:\d{2})/)[1] : item.heure_arrivee;

                    tableHtml += `
                        <tr>
                            <td class="p-3 font-bold text-slate-700">${item.nom}</td>
                            <td class="p-3 text-center font-mono text-blue-600">${hAffiche}</td>
                            <td class="p-3 text-center text-slate-500">${item.zone}</td>
                            <td class="p-3 text-right"><span class="bg-emerald-50 text-emerald-600 px-2 py-1 rounded font-bold text-[9px]">PRÉSENT</span></td>
                        </tr>
                    `;
                });
                
                if(cleanReports.length === 0) tableHtml += `<tr><td colspan="4" class="p-10 text-center text-slate-400 italic">Aucun pointage aujourd'hui.</td></tr>`;

            } else {
                // --- RAPPORT MENSUEL ---
                tableHtml = `
                    <div class="flex justify-end mb-4">
                        <button onclick="downloadReportCSV('${period}')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase shadow hover:bg-emerald-700 transition-all flex items-center gap-2"><i class="fa-solid fa-file-csv"></i> Télécharger Cumul</button>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh]">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="bg-slate-100 text-[10px] uppercase font-black text-slate-500 sticky top-0">
                                <tr><th class="p-3">Mois</th><th class="p-3">Employé</th><th class="p-3 text-center">Jours Prés.</th><th class="p-3 text-center">Heures Tot.</th><th class="p-3 text-right">Statut</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 text-xs">
                `;

                // UTILISE cleanReports ICI
                cleanReports.forEach(item => {
                    tableHtml += `
                        <tr>
                            <td class="p-3 font-bold text-slate-700">${item.mois}</td>
                            <td class="p-3 font-medium">${item.nom}</td>
                            <td class="p-3 text-center font-bold text-slate-800">${item.jours}</td>
                            <td class="p-3 text-center font-mono text-blue-600">${item.heures}h</td>
                            <td class="p-3 text-right"><span class="bg-emerald-50 text-emerald-600 px-2 py-1 rounded font-bold text-[9px]">Clôturé</span></td>
                        </tr>`;
                });
                if(cleanReports.length === 0) tableHtml += `<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Aucune donnée mensuelle trouvée.</td></tr>`;
            }

            tableHtml += `</tbody></table></div>`;
            Swal.fire({
                title: period === 'today' ? 'Pointages du Jour' : 'Rapport Mensuel',
                html: tableHtml,
                width: '850px',
                confirmButtonText: 'Fermer',
                confirmButtonColor: '#0f172a'
            });
            currentReportData = cleanReports; // <-- ENREGISTRE LES DONNÉES NORMALISÉES
        } else {
            // Mode Personnel (Mon Profil)
            renderPersonalReport(cleanReports, container); // <-- UTILISE cleanReports
        }
    } catch (e) {
        console.error("Erreur rapport:", e);
        Swal.fire('Erreur', "Impossible de charger les données du serveur.", 'error');
    }
}


















function renderPersonalReport(reports, container) {
    if (!container) return;
    if (!reports || reports.length === 0) {
        container.innerHTML = '<p class="text-xs text-slate-400 italic p-4 text-center">Aucun rapport disponible.</p>';
        return;
    }
    
    // --- TRI LONG TERME : On inverse l'ordre (le dernier arrivé en premier) ---
    // Si 'reports' vient d'Airtable, c'est souvent du plus ancien au plus récent.
    // On fait un reverse() simple pour afficher le dernier mois en haut.
    const sortedReports = [...reports].reverse(); 

    container.innerHTML = '';
    
    sortedReports.forEach(item => {
        // ... (Le reste de votre code d'affichage reste identique) ...
        // Utilisez 'item' ici
        let mois = item.mois || item['Mois/Année'] || '-';
        let heures = item.heures || item['Total Heures'] || 0;
        let jours = item.jours || item['Jours de présence'] || 0;
        const letter = mois !== '-' ? mois.charAt(0) : '?';
        
        container.innerHTML += `
            <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-100 rounded-xl hover:bg-white transition-colors">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-lg shadow-sm border border-indigo-200">${letter}</div>
                    <div><h4 class="font-bold text-slate-800 text-sm capitalize">${mois}</h4><p class="text-[10px] text-slate-500 font-medium">Cumul validé</p></div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-black text-slate-800">${heures}h <span class="text-[10px] text-slate-400 font-normal">/ ${jours}j</span></p>
                    <span class="text-[9px] font-bold text-emerald-500 uppercase bg-emerald-50 px-2 py-0.5 rounded">Validé</span>
                </div>
            </div>
        `;
    });
}













 async function triggerManualContractUpload(employeeId) {
    const { value: file } = await Swal.fire({
        title: 'Contrat scanné / Physique',
        text: 'Sélectionnez le PDF ou prenez une photo du contrat signé manuellement.',
        input: 'file',
        inputAttributes: {
            'accept': 'application/pdf,image/*',
            'aria-label': 'Uploader le contrat'
        },
        showCancelButton: true,
        confirmButtonText: 'Envoyer le document',
        confirmButtonColor: '#10b981',
        cancelButtonText: 'Annuler'
    });

    if (file) {
        Swal.fire({
            title: 'Envoi en cours...',
            text: 'Le fichier est en cours d\'archivage dans Airtable',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // Préparation du FormData
        const fd = new FormData();
        fd.append('id', employeeId);
        fd.append('contract_file', file); // Le fichier binaire
        fd.append('mode', 'manual_scan');
        fd.append('agent', currentUser.nom);

        try {
            // UTILISATION DE secureFetch POUR ENVOYER LE TOKEN
            const response = await secureFetch(URL_UPLOAD_SIGNED_CONTRACT, {
                method: 'POST',
                body: fd 
                // Note : On ne définit PAS de headers ici, 
                // secureFetch s'en occupe et le navigateur gère le "multipart/form-data"
            });

            if (response.ok) {
                Swal.fire('Succès !', 'Le contrat scanné a été enregistré avec succès.', 'success');
                refreshAllData(); 
            } else {
                // Si on arrive ici, secureFetch a déjà levé une erreur normalement
                throw new Error("Le serveur a répondu avec une erreur.");
            }
        } catch (error) {
            console.error("Erreur Upload:", error);
            Swal.fire('Échec', "Impossible d'envoyer le fichier : " + error.message, 'error');
        }
    }
}









            function openLeaveModal() {
                document.getElementById('leave-modal').classList.remove('hidden');
                document.getElementById('leave-start').valueAsDate = new Date();
                document.getElementById('leave-end').valueAsDate = new Date();
            }







                    async function submitLeaveRequest(e) {
                e.preventDefault();
                
                const fd = new FormData();
                fd.append('employee_id', currentUser.id);
                fd.append('nom', currentUser.nom);
                fd.append('type', document.querySelector('input[name="leave_type"]:checked').value);
                fd.append('date_debut', document.getElementById('leave-start').value);
                fd.append('date_fin', document.getElementById('leave-end').value);
                fd.append('motif', document.getElementById('leave-reason').value);
                fd.append('date_demande', new Date().toISOString());
                fd.append('agent', currentUser.nom);

                // Ajout du justificatif s'il a été pris en photo ou uploadé
                if (docBlobs.leave_justif) {
                    fd.append('justificatif', docBlobs.leave_justif, 'justificatif_conge.jpg');
                }

                Swal.fire({ title: 'Envoi...', text: 'Traitement de votre demande', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

                try {
                    const response = await secureFetch(URL_LEAVE_REQUEST, { method: 'POST', body: fd });
                    if (response.ok) {
                        document.getElementById('leave-modal').classList.add('hidden');
                        e.target.reset();
                        docBlobs.leave_justif = null;
                        document.getElementById('leave-doc-preview').innerHTML = '<i class="fa-solid fa-camera"></i>';
                        Swal.fire('Succès', 'Votre demande de congé a été envoyée.', 'success');
                    }
                } catch (error) { 
                    Swal.fire('Erreur', "Échec de l'envoi : " + error.message, 'error'); 
                }
            }








            function updateClockUI(isIn) {
                const btn = document.getElementById('btn-clock');
                const dot = document.getElementById('clock-status-dot');
                const text = document.getElementById('clock-status-text');
                if(!btn) return; 
                if (isIn) {
                    btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-400');
                    btn.classList.add('bg-red-500', 'hover:bg-red-400');
                    btn.innerHTML = '<i class="fa-solid fa-person-walking-arrow-right"></i> <span>SORTIE</span>';
                    dot.classList.remove('bg-red-500'); dot.classList.add('bg-emerald-500', 'shadow-emerald-500/50');
                    text.innerText = "EN POSTE"; text.classList.add('text-emerald-500'); text.classList.remove('text-slate-800');
                } else {
                    btn.classList.remove('bg-red-500', 'hover:bg-red-400');
                    btn.classList.add('bg-emerald-500', 'hover:bg-emerald-400');
                    btn.innerHTML = '<i class="fa-solid fa-fingerprint"></i> <span>ENTRÉE</span>';
                    dot.classList.remove('bg-emerald-500'); dot.classList.add('bg-red-500', 'shadow-red-500/50');
                    text.innerText = "NON POINTÉ"; text.classList.remove('text-emerald-500'); text.classList.add('text-slate-800');
                }
            }



            










function syncClockInterface() {
    const userId = currentUser.id;
    const today = new Date().toLocaleDateString('fr-CA');
    const lastActionDate = localStorage.getItem(`clock_date_${userId}`);
    
    // Si on change de jour, on remet l'affichage à zéro visuellement
    if (lastActionDate !== today) {
        localStorage.setItem(`clock_status_${userId}`, 'OUT');
        updateClockUI(false);
    } else {
        // Sinon on affiche l'état stocké (IN ou OUT)
        const currentStatus = localStorage.getItem(`clock_status_${userId}`) || 'OUT';
        updateClockUI(currentStatus === 'IN');
    }
}










            

















async function handleClockInOut() {
    const userId = currentUser.id;
    const today = new Date().toLocaleDateString('fr-CA');
    
    // --- 1. NETTOYAGE INTELLIGENT DU JOUR ---
    const lastActionDate = localStorage.getItem(`clock_date_${userId}`);
    
    if (lastActionDate !== today) {
        // C'est un nouveau jour, on remet tout à zéro
        localStorage.setItem(`clock_date_${userId}`, today);
        localStorage.setItem(`clock_status_${userId}`, 'OUT');
        localStorage.setItem(`clock_in_done_${userId}`, 'false');
        localStorage.setItem(`clock_out_done_${userId}`, 'false');
        updateClockUI(false); 
    }

    // --- 2. DÉCISION BASÉE SUR LE STATUT ACTUEL (Plus fiable) ---
    // Si le téléphone pense qu'on est OUT, on tente d'entrer.
    // Si le téléphone pense qu'on est IN, on tente de sortir.
    const currentStatus = localStorage.getItem(`clock_status_${userId}`) || 'OUT';
    const action = (currentStatus === 'OUT') ? 'CLOCK_IN' : 'CLOCK_OUT';

    // Petite sécurité pour éviter de re-pointer si la journée est finie
    const outDone = localStorage.getItem(`clock_out_done_${userId}`) === 'true';
    if (action === 'CLOCK_IN' && outDone && currentStatus === 'OUT') {
         return Swal.fire('Journée terminée', 'Vous avez déjà fait votre sortie aujourd\'hui.', 'info');
    }

    // --- 3. DÉBUT DU POINTAGE ---
    Swal.fire({ 
        title: 'Vérification...', 
        text: 'Analyse GPS et Serveur...', 
        didOpen: () => Swal.showLoading(), 
        allowOutsideClick: false 
    });

    try {
        // Récupération IP & GPS (Code standard)
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResponse.json();
        const userIp = ipData.ip;

        const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        });

        // Vérification Zone
        let validatedZone = "Hors Zone";
        let isInside = false;
        let dist = 0;

        SIRH_CONFIG.gps.offices.forEach(office => {
            const d = getDistance(pos.coords.latitude, pos.coords.longitude, office.lat, office.lon);
            if (d <= office.radius) { 
                isInside = true; 
                dist = Math.round(d); 
                validatedZone = office.name; 
            }
        });
        
        if (SIRH_CONFIG.gps.strictMode && !isInside) {
            return Swal.fire({icon: 'error', title: 'Hors Zone', text: 'Rapprochez-vous du bureau.'});
        }

        // --- 4. ENVOI AU SERVEUR ---
        const payload = {
            id: userId,
            nom: currentUser.nom,
            action: action, // On envoie l'action déterminée
            time: new Date().toISOString(),
            gps: `${pos.coords.latitude},${pos.coords.longitude}`,
            distance_bureau: dist,
            zone: validatedZone,
            ip: userIp,
            agent: currentUser.nom
        };

        const response = await secureFetch(URL_CLOCK_ACTION, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
        });

        if (response.ok) {
            // SUCCÈS STANDARD
            const nowStr = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
            
            if (action === 'CLOCK_IN') {
                localStorage.setItem(`clock_status_${userId}`, 'IN');
                localStorage.setItem(`clock_in_done_${userId}`, 'true');
                updateClockUI(true); // Passe au ROUGE (Sortie)
            } else {
                localStorage.setItem(`clock_status_${userId}`, 'OUT');
                localStorage.setItem(`clock_out_done_${userId}`, 'true');
                updateClockUI(false); // Passe au VERT (Entrée)
            }
            
            document.getElementById('clock-last-action').innerText = `Validé : ${action==='CLOCK_IN'?'Entrée':'Sortie'} à ${nowStr}`;
            Swal.fire('Succès', 'Pointage enregistré avec succès.', 'success');
        }

    } catch (e) { 
        // --- 5. L'INTELLIGENCE ARTIFICIELLE DE RÉPARATION ---
        // C'est ici que ça se joue. On analyse l'erreur du serveur.
        
        const errorMsg = e.message || "";

        // Si Make/Airtable dit "Refusé" ou si le message d'erreur contient des indices de doublon
        // (Adaptez les mots clés selon vos messages d'erreur Make exacts)
        const isDuplicateError = errorMsg.includes("déjà") || errorMsg.includes("Refus") || errorMsg.includes("exist");

        if (isDuplicateError) {
            // LE SERVEUR DIT QU'ON EST DÉJÀ DANS L'ÉTAT VOULU
            // Donc le téléphone se trompait. On corrige le téléphone.

            if (action === 'CLOCK_IN') {
                // On a essayé d'entrer, mais le serveur dit "Déjà fait". 
                // Conclusion : On est DÉJÀ À L'INTÉRIEUR.
                localStorage.setItem(`clock_status_${userId}`, 'IN');
                localStorage.setItem(`clock_in_done_${userId}`, 'true');
                updateClockUI(true); // On force l'affichage "EN POSTE"
                
                Swal.fire({
                    icon: 'warning',
                    title: 'Synchronisation',
                    text: 'Le serveur indique que vous êtes déjà pointé. Votre interface a été corrigée. Vous pouvez maintenant pointer la Sortie.',
                    confirmButtonText: 'Compris'
                });

            } else if (action === 'CLOCK_OUT') {
                // On a essayé de sortir, mais erreur (rare, mais possible si double clic).
                localStorage.setItem(`clock_status_${userId}`, 'OUT');
                localStorage.setItem(`clock_out_done_${userId}`, 'true');
                updateClockUI(false);
                Swal.fire('Info', 'Sortie déjà enregistrée.', 'info');
            }

        } else if (errorMsg.startsWith("AUTH_ERROR_SPECIFIC:")) {
            // Autres erreurs spécifiques de Make
            Swal.fire('Refusé', errorMsg.replace("AUTH_ERROR_SPECIFIC:", ""), 'warning');
        } else {
            // Erreur technique vraie (Réseau, Timeout)
            Swal.fire('Erreur Technique', errorMsg, 'error');
        }
    }
}







            





    function openFullFolder(id) {
        const e = employees.find(x => x.id === id); if(!e) return;
        
        document.getElementById('folder-photo').src = formatGoogleLink(e.photo) || 'https://via.placeholder.com/150';
        document.getElementById('folder-name').innerText = e.nom; 
        document.getElementById('folder-id').innerText = "IDENTIFIANT : " + e.id;
        document.getElementById('folder-poste').innerText = e.poste; 
        document.getElementById('folder-dept').innerText = e.dept;
        document.getElementById('folder-email').innerText = e.email || "Non renseigné"; 
        document.getElementById('folder-phone').innerText = e.telephone || "Non renseigné";
        document.getElementById('folder-address').innerText = e.adresse || "Non renseignée";
        
        if(e.date) { 
            let sD = parseDateSmart(e.date); 
            document.getElementById('folder-start').innerText = sD.toLocaleDateString('fr-FR'); 
            let eD = new Date(sD); eD.setDate(eD.getDate() + (parseInt(e.limit) || 365)); 
            document.getElementById('folder-end').innerText = eD.toLocaleDateString('fr-FR'); 
        }
        
        const grid = document.getElementById('folder-docs-grid'); 
        grid.innerHTML = '';

        const docs = [ 
            { label: 'Contrat Actuel', link: e.doc, icon: 'fa-file-signature', color: 'blue', key: 'contrat' }, 
            { label: 'Curriculum Vitae', link: e.cv_link, icon: 'fa-file-pdf', color: 'indigo', key: 'cv' }, 
            { label: 'Lettre Motivation', link: e.lm_link, icon: 'fa-envelope-open-text', color: 'pink', key: 'lm' },
            { label: 'Pièce d\'Identité', link: e.id_card_link, icon: 'fa-id-card', color: 'slate', key: 'id_card' }, 
            { label: 'Diplômes/Certifs', link: e.diploma_link, icon: 'fa-graduation-cap', color: 'emerald', key: 'diploma' },
            { label: 'Attestations / Autres', link: e.attestation_link, icon: 'fa-file-invoice', color: 'orange', key: 'attestation' } 
        ];

        docs.forEach(doc => { 
            const hasLink = doc.link && doc.link.length > 5; 
            // --- CORRECTION : Protection contre les guillemets simples dans le label ---
            const safeLabel = doc.label.replace(/'/g, "\\'");

            grid.innerHTML += `
                <div class="p-4 rounded-2xl border ${hasLink ? 'bg-white shadow-sm border-slate-200' : 'bg-slate-100 opacity-50'} flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-xl bg-${doc.color}-50 text-${doc.color}-600"><i class="fa-solid ${doc.icon}"></i></div>
                        <p class="text-xs font-bold text-slate-700">${doc.label}</p>
                    </div>
                    <div class="flex gap-2">
                        ${hasLink ? `<button onclick="viewDocument('${doc.link}', '${safeLabel}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Consulter"><i class="fa-solid fa-eye"></i></button>` : ''}
                        
                        <button onclick="updateSingleDoc('${doc.key}', '${e.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </div>
                </div>`; 
        });         
        
        document.getElementById('folder-modal').classList.remove('hidden');
    }









            
            
            
            function closeFolderModal() { document.getElementById('folder-modal').classList.add('hidden'); }
    
            





    function formatGoogleLink(link) {
        // 1. Sécurité : si vide
        if (!link || link === '#' || link === 'null') {
            return 'https://ui-avatars.com/api/?background=cbd5e1&color=fff&size=128';
        }

        // 2. Nettoyage : On récupère la chaîne de caractères, peu importe si c'est dans un tableau ou non
        let url = link;
        if (Array.isArray(link) && link.length > 0) url = link[0].url || link[0];
        else if (typeof link === 'object' && link.url) url = link.url;
        
        url = String(url);

        // 3. EXTRACTION DE L'ID GOOGLE DRIVE
        // Ça marche pour :
        // - https://drive.google.com/file/d/L_ID_EST_ICI/view
        // - https://drive.google.com/open?id=L_ID_EST_ICI
        const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);

        if (idMatch && idMatch[1]) {
            // C'est l'URL magique qui transforme un lien Drive en vraie image affichable
            return `https://lh3.googleusercontent.com/d/${idMatch[1]}`;
        }

        // Si ce n'est pas du Drive, on renvoie l'url telle quelle (cas ou c'est déjà hébergé ailleurs)
        return url;
    }















    // Nouvelle fonction helper pour extraire juste l'ID (nécessaire pour la preview)
    function getDriveId(link) {
        if (!link) return null;
        const str = String(link);
        const match = str.match(/\/d\/([a-zA-Z0-9_-]+)/) || str.match(/id=([a-zA-Z0-9_-]+)/);
        return match ? match[1] : null;
    }









    function loadMyProfile() {
        console.log("🔍 --- DÉBUT DEBUG PROFIL ---");
        console.log("👤 Utilisateur connecté :", currentUser);
        console.log("📋 Données reçues (Employees) :", employees);

        // 1. Sécurité : Si la liste est vide
        if (!employees || employees.length === 0) {
            console.warn("⚠️ Liste vide. En attente du chargement...");
            return;
        }

        let myData = null;

        // --- TENTATIVE 1 : LE COUP DE POKER (Si 1 seul résultat, on le prend) ---
        // Si Make a renvoyé un seul résultat (filtrage ID), c'est forcément le bon.
        if (employees.length === 1) {
            console.log("✅ Une seule fiche trouvée, sélection automatique.");
            myData = employees[0];
        } 
        
        // --- TENTATIVE 2 : PAR ID (Le plus fiable) ---
        if (!myData) {
            // On compare l'ID stocké avec l'ID du tableau (en texte pour éviter les bugs de type)
            myData = employees.find(e => String(e.id) === String(currentUser.id));
            // AJOUTE CETTE LIGNE DANS loadMyProfile pour voir la donnée brute
            console.log("DEBUG: Solde brut reçu :", myData.Solde_Conges, myData.solde_conges);
            if(myData) console.log("✅ Trouvé par ID exact.");
        }

        // --- TENTATIVE 3 : PAR NOM (Si l'ID échoue, ex: RecordID vs Matricule) ---
        if (!myData) {
            // Nettoyage des noms (minuscule, sans accents, sans espaces inutiles)
            const normalize = (s) => String(s || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const searchName = normalize(currentUser.nom);
            
            myData = employees.find(e => {
                const empName = normalize(e.nom);
                return empName.includes(searchName) || searchName.includes(empName);
            });
            if(myData) console.log("✅ Trouvé par correspondance de Nom.");
        }

        // --- RÉSULTAT FINAL ---
        if (!myData) {
            console.error("❌ ÉCHEC TOTAL : Impossible de lier l'utilisateur aux données.");
            console.log("👉 Vérifiez que l'ID ou le Nom correspond entre le Login et Airtable.");
            // Pour éviter l'écran blanc, on affiche quand même le premier si dispo (mode dégradé)
            if(employees.length > 0) {
                console.warn("⚠️ Affichage forcé du premier élément disponible.");
                myData = employees[0];
            } else {
                return;
            }
        }
        
        // --- REMPLISSAGE DE L'INTERFACE ---
        console.log("📝 Remplissage avec :", myData.nom);

        document.getElementById('emp-name').innerText = myData.nom || "Utilisateur"; 
        document.getElementById('emp-job').innerText = myData.poste || "Poste non défini";
        
        // Sidebar
        const nameDisplay = document.getElementById('name-display');
        const avatarDisplay = document.getElementById('avatar-display');
        if (nameDisplay) nameDisplay.innerText = myData.nom || currentUser.nom;
        if (avatarDisplay) avatarDisplay.innerText = (myData.nom || currentUser.nom).charAt(0).toUpperCase();
        
        // Photo
        const photoEl = document.getElementById('emp-photo-real');
        const avatarEl = document.getElementById('emp-avatar');
        
        if(myData.photo && myData.photo.length > 10) { 
            photoEl.src = formatGoogleLink(myData.photo); 
            photoEl.classList.remove('hidden'); 
            avatarEl.classList.add('hidden'); 
        } else {
            photoEl.classList.add('hidden'); 
            avatarEl.classList.remove('hidden');
            avatarEl.innerText = (myData.nom || "U").charAt(0).toUpperCase();
        }

        // Dates
        if(myData.date) { 
            let sD = parseDateSmart(myData.date); 
            document.getElementById('emp-start-date').innerText = sD.toLocaleDateString('fr-FR'); 
            let eD = new Date(sD); 
            eD.setDate(eD.getDate() + (parseInt(myData.limit) || 365)); 
            document.getElementById('emp-end-date').innerText = eD.toLocaleDateString('fr-FR'); 
        }

        // Formulaires
        document.getElementById('emp-email').value = myData.email || ""; 
        document.getElementById('emp-phone').value = myData.telephone || ""; 
        document.getElementById('emp-address').value = myData.adresse || ""; 
        document.getElementById('emp-dob').value = convertToInputDate(myData.date_naissance); 
        
        // Documents
        const dC = document.getElementById('doc-container'); 
        if (dC) {
            dC.innerHTML = '';
            const allDocs = [ 
                { label: 'Contrat Actuel', link: myData.doc, icon: 'fa-file-signature', color: 'blue', key: 'contrat' }, 
                { label: 'Curriculum Vitae', link: myData.cv_link, icon: 'fa-file-pdf', color: 'indigo', key: 'cv' }, 
                { label: 'Lettre Motivation', link: myData.lm_link, icon: 'fa-envelope-open-text', color: 'pink', key: 'lm' },
                { label: 'Pièce d\'Identité', link: myData.id_card_link, icon: 'fa-id-card', color: 'slate', key: 'id_card' }, 
                { label: 'Diplômes/Certifs', link: myData.diploma_link, icon: 'fa-graduation-cap', color: 'emerald', key: 'diploma' },
                { label: 'Attestations', link: myData.attestation_link, icon: 'fa-file-invoice', color: 'orange', key: 'attestation' } 
            ];

            const VISIBLE_LIMIT = 4;
            let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">'; 

            allDocs.forEach((doc, index) => {
                const hasLink = doc.link && doc.link.length > 5;
                const safeLabel = doc.label.replace(/'/g, "\\'");
                const hiddenClass = index >= VISIBLE_LIMIT ? 'hidden more-docs' : '';

                gridHtml += `
                    <div class="${hiddenClass} flex flex-col justify-between p-4 border border-slate-100 bg-white rounded-2xl hover:shadow-md transition-all group h-full">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-${doc.color}-50 text-${doc.color}-600 p-3 rounded-xl shrink-0">
                                <i class="fa-solid ${doc.icon} text-lg"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p class="text-xs font-bold text-slate-700 truncate" title="${doc.label}">${doc.label}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wide">Document</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-auto">
                            ${hasLink ? `
                            <button onclick="viewDocument('${doc.link}', '${safeLabel}')" class="flex-1 py-2 text-[10px] font-bold uppercase bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all">
                                <i class="fa-solid fa-eye mr-1"></i> Voir
                            </button>` : `
                            <div class="flex-1 py-2 text-[10px] font-bold uppercase bg-slate-50 text-slate-300 rounded-lg text-center cursor-not-allowed">
                                Vide
                            </div>`}
                            ${doc.key === 'id_card' ? `<button onclick="updateSingleDoc('${doc.key}', '${myData.id}')" class="w-10 flex items-center justify-center bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-800 hover:text-white transition-all"><i class="fa-solid fa-pen"></i></button>` : ''}
                        </div>
                    </div>`;
            });
            gridHtml += '</div>';
            if (allDocs.length > VISIBLE_LIMIT) {
                gridHtml += `<div class="text-center mt-4 pt-2 border-t border-slate-50"><button onclick="toggleMoreDocs(this)" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-full text-xs font-bold text-slate-500 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm"><i class="fa-solid fa-circle-plus"></i> Voir plus</button></div>`;
            }
            dC.innerHTML = gridHtml;

                            // --- NOUVEAU : AFFICHAGE DU SOLDE DE CONGÉS ---
                    const leaveBalanceEl = document.getElementById('leave-balance-display');
                    const solde = parseFloat(myData.Solde_Conges || myData.solde_conges) || 0; 
                    
                    if(leaveBalanceEl) {
                        leaveBalanceEl.innerText = `${solde} jours`;
                        
                        // Logique de couleur rapide (Feedback visuel)
                        if (solde <= 5) {
                            leaveBalanceEl.classList.remove('text-indigo-600');
                            leaveBalanceEl.classList.add('text-orange-600');
                        } else {
                            leaveBalanceEl.classList.remove('text-orange-600');
                            leaveBalanceEl.classList.add('text-indigo-600');
                        }
                    }
                } // La fonction loadMyProfile se termine ici

        }
    








async function fetchEmployeeLeaveBalances() {
    const body = document.getElementById('manager-leave-body');
    if (!body || currentUser.role === 'EMPLOYEE') return;

    body.innerHTML = '<tr><td colspan="4" class="p-6 text-center italic text-slate-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Chargement des soldes...</td></tr>';

    try {
        // On réutilise fetchAllData qui charge déjà la liste des employés
        // (En s'assurant que Make renvoie bien le Solde_Conges)
        await fetchData(true); 
        
        body.innerHTML = '';
        
        employees.forEach(emp => {
            // Seuls les actifs nous intéressent ici
            if (emp.statut !== 'Actif') return; 

            // Récupération des valeurs (s'assurer du nom de la colonne venant de Make)
            const solde = parseFloat(emp.Solde_Conges || emp.solde_conges) || 0; 
            const status = emp.Statut_Conge_Actuel || 'Aucune'; // A créer dans Airtable

            let colorClass = 'text-emerald-600';
            if (solde < 5) colorClass = 'text-red-600 font-bold';
            else if (solde < 10) colorClass = 'text-orange-600';
            
            // Logique de demande en cours (on réutilise le statut existant)
            const activeLeaveDot = allLeaves.some(l => l.nom === emp.nom && l.statut === 'en attente') 
                                 ? '<span class="w-2 h-2 rounded-full bg-yellow-500 mr-2 inline-block"></span> En attente'
                                 : 'Aucune';


            body.innerHTML += `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-8 py-3 text-sm font-bold text-slate-800">${emp.nom}</td>
                    <td class="px-8 py-3 text-xs text-slate-500">${emp.dept}</td>
                    <td class="px-8 py-3 text-center text-[10px] font-black">${activeLeaveDot}</td>
                    <td class="px-8 py-3 text-right text-sm font-black ${colorClass}">${solde} jours</td>
                </tr>
            `;
        });

    } catch (e) {
        console.error("Erreur chargement soldes :", e);
        body.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-red-500">Erreur de connexion au solde des congés.</td></tr>';
    }
}







// Variable pour gérer l'actualisation automatique du chat
let chatIntervalId = null;

function switchView(v) { 
    // --- MODIFICATION : On mémorise la vue active ---
    currentView = v;
    console.log("Vue active :", currentView);

    // 1. Arrêt des caméras (Nettoyage)
    if(videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
    if(contractStream) { contractStream.getTracks().forEach(t => t.stop()); contractStream = null; }
    
    // --- NOUVEAU : Nettoyage du Chat ---
    // Si on change de page, on arrête de rafraîchir les messages en arrière-plan
    if (chatIntervalId) {
        clearInterval(chatIntervalId);
        chatIntervalId = null;
    }

    // 2. Masquer TOUTES les sections
    document.querySelectorAll('.view-section').forEach(section => {
        section.classList.remove('active');
    });

    // 3. Afficher la section demandée
    const target = document.getElementById('view-' + v);
    if(target) target.classList.add('active');

    // 4. Gestion des boutons du menu (Style actif)
    document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('bg-blue-600', 'text-white');
        // On remet le style par défaut
    });
    
    // On active le bouton cliqué (celui qui a switchView('v') dans son onclick)
    const activeBtn = document.querySelector(`button[onclick="switchView('${v}')"]`);
    if(activeBtn) activeBtn.classList.add('bg-blue-600', 'text-white');

    // --- CORRECTION MAJEURE ICI : RESET DU SCROLL ---
    // On force le conteneur principal à remonter tout en haut
    const mainContainer = document.getElementById('main-scroll-container');
    if(mainContainer) {
        mainContainer.scrollTo(0, 0); // Remonte instantanément
    }
    window.scrollTo(0, 0); // Sécurité pour le body aussi

    // 5. Logique spécifique par vue
    const searchContainer = document.getElementById('global-search-container');
    if(v === 'employees' || v === 'logs') { 
        if(currentUser && currentUser.role !== 'EMPLOYEE') { 
            searchContainer.style.visibility = 'visible'; 
            searchContainer.style.opacity = '1'; 
        }
    } else { 
        searchContainer.style.visibility = 'hidden'; 
        searchContainer.style.opacity = '0'; 
    }
    
    if(v === 'add-new') { 
        const form = document.getElementById('form-onboarding');
        if(form) form.reset(); // Sécurité si le formulaire n'est pas encore chargé
        resetCamera(); 
    }

    // --- NOUVEAU : Logique spécifique pour le CHAT ---
    if (v === 'chat') {
        fetchMessages(); // Chargement immédiat
        chatIntervalId = setInterval(fetchMessages, 5000); // Actualisation toutes les 5s
        // Scroll automatique vers le bas
        setTimeout(() => {
            const c = document.getElementById('chat-messages');
            if(c) c.scrollTop = c.scrollHeight;
        }, 500);
    }
    
    // --- CORRECTION : Chargement automatique des données selon l'onglet ---
    if(v === 'logs') fetchLogs(); 
    if(v === 'recruitment') fetchCandidates();
    if(v === 'my-profile') {
        loadMyProfile(); 
        fetchPayrollData();
        fetchLeaveRequests(); 
    }

    // 6. Fermer sidebar sur mobile
    if(window.innerWidth < 768) { 
        const sb = document.getElementById('sidebar'); 
        if(!sb.classList.contains('-translate-x-full')) toggleSidebar(); 
    }
}






            function toggleSidebar(){const sb=document.getElementById('sidebar'), o=document.getElementById('sidebar-overlay'); if(sb.classList.contains('-translate-x-full')){sb.classList.remove('-translate-x-full');o.classList.remove('hidden');}else{sb.classList.add('-translate-x-full');o.classList.add('hidden');}}
        


            function filterTable(){const t=document.getElementById('search-input').value.toLowerCase(); const s=document.querySelector('.view-section.active'); if(s)s.querySelectorAll('tbody tr').forEach(r=>{r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'})}
        
        
        
            function parseDateSmart(d){if(!d)return new Date();if(!isNaN(d)&&!String(d).includes('/'))return new Date((d-25569)*86400000);if(String(d).includes('/')){const p=d.split('/'); return new Date(p[2],p[1]-1,p[0]);}return new Date(d);}
            
            
            function convertToInputDate(dStr){if(!dStr) return ""; if(dStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dStr; if(dStr.includes('/')){const p=dStr.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;} return "";}
            
    





                            // --- OUVRIR LA MODALE D'ADMINISTRATION ---
    function openEditModal(id) {
        const e = employees.find(x => x.id === id);
        if (e) {
            // 1. Afficher la modale
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-id-hidden').value = id;
            
            // 2. Pré-remplir les champs standards
            document.getElementById('edit-statut').value = e.statut || 'Actif';
            
            const roleSelect = document.getElementById('edit-role');
            if(roleSelect) roleSelect.value = e.role || 'EMPLOYEE';
            
            const deptSelect = document.getElementById('edit-dept');
            if(deptSelect) deptSelect.value = e.dept || 'IT & Tech';

            const typeSelect = document.getElementById('edit-type-contrat');
            if(typeSelect) typeSelect.value = e.limit || '365';
            
            // 3. Pré-remplir la DATE DE DÉBUT DE CONTRAT (Nouveau)
            const dateInput = document.getElementById('edit-start-date');
            if (dateInput) {
                // Si l'employé a une date, on la met au format YYYY-MM-DD
                // Sinon, on met la date d'aujourd'hui par défaut
                if (e.date) {
                    dateInput.value = convertToInputDate(e.date);
                } else {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }

            // 4. Réinitialiser la case à cocher "Forcer l'initialisation"
            const initCheck = document.getElementById('edit-init-check');
            if(initCheck) initCheck.checked = false;
        }
    }















    async function submitUpdate(e) {
        e.preventDefault(); 
        const id = document.getElementById('edit-id-hidden').value;
        
        // Récupération des valeurs
        const statut = document.getElementById('edit-statut').value;
        const role = document.getElementById('edit-role') ? document.getElementById('edit-role').value : 'EMPLOYEE';
        const dept = document.getElementById('edit-dept') ? document.getElementById('edit-dept').value : '';
        const typeContrat = document.getElementById('edit-type-contrat').value;
        
        // NOUVEAU : Récupération Date & Checkbox
        const newStartDate = document.getElementById('edit-start-date').value;
        const forceInit = document.getElementById('edit-init-check').checked;

        Swal.fire({title: 'Mise à jour...', text: 'Synchronisation...', didOpen: () => Swal.showLoading()}); 

        let urlParams = `id=${id}&agent=${encodeURIComponent(currentUser.nom)}`;
        urlParams += `&statut=${encodeURIComponent(statut)}`;
        urlParams += `&role=${encodeURIComponent(role)}`;
        urlParams += `&dept=${encodeURIComponent(dept)}`;
        urlParams += `&limit=${typeContrat}`;
        
        // On envoie la date et le booléen
        urlParams += `&start_date=${newStartDate}`;
        urlParams += `&force_init=${forceInit ? 'true' : 'false'}`;

        try {
            const response = await secureFetch(`${URL_UPDATE}?${urlParams}`);
            if(response.ok) {
                closeEditModal(); 
                Swal.fire('Succès', 'Contrat et dossier mis à jour', 'success'); 

                        fetchData(true); // On met à jour la liste des employés

            } else {
                throw new Error("Erreur serveur");
            }
        } catch(e) { 
            Swal.fire('Erreur', e.message, 'error'); 
        }
    }


















   








        
        
            function closeEditModal(){document.getElementById('edit-modal').classList.add('hidden');}
            
        async function printBadge(id) {
                const e = employees.find(x => x.id === id); 
                if(!e) return; 
                
                // On récupère le token
                const token = localStorage.getItem('sirh_token');
                
                Swal.fire({title:'Génération...', didOpen:()=>Swal.showLoading()});

                try {
                    // On construit l'URL
                    const url = `${URL_BADGE_GEN}?id=${encodeURIComponent(id)}&nom=${encodeURIComponent(e.nom)}&poste=${encodeURIComponent(e.poste)}&photo=${encodeURIComponent(formatGoogleLink(e.photo)||'')}&agent=${encodeURIComponent(currentUser.nom)}&token=${token}`;

                    // AU LIEU DE FAIRE window.open(url)...
                    // On va chercher le contenu (le code HTML du badge)
                    const response = await fetch(url);
                    
                    if (!response.ok) throw new Error("Erreur génération");

                    // On récupère le texte HTML
                    const htmlContent = await response.text();

                    // On ferme le loader
                    Swal.close();

                    // On ouvre une fenêtre vide
                    const w = window.open('', '_blank', 'width=400,height=600');
                    
                    // On écrit le HTML dedans manuellement
                    w.document.open();
                    w.document.write(htmlContent);
                    w.document.close();

                    // Petit délai pour laisser les images charger avant d'imprimer (si le HTML contient un script d'impression auto, ça marchera aussi)
                    w.onload = function() {
                        // Optionnel : forcer l'impression si le HTML ne le fait pas déjà
                        // w.print();
                    };

                } catch (error) {
                    console.error(error);
                    Swal.fire('Erreur', 'Impossible de générer le badge : ' + error.message, 'error');
                }
            }
            
            async function startCameraFeed(){try{videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});const v=document.getElementById('video-stream');v.srcObject=videoStream;v.classList.remove('hidden');document.getElementById('captured-image').classList.add('hidden');document.getElementById('btn-capture').classList.remove('hidden');document.getElementById('initial-controls').classList.add('hidden');document.getElementById('photo-placeholder').classList.add('hidden');}catch(e){Swal.fire('Erreur', 'Caméra bloquée', 'error');}}
            function handleFileUpload(e){const f=e.target.files[0];if(f){capturedBlob=f;const i=document.getElementById('captured-image');i.src=URL.createObjectURL(f);i.classList.remove('hidden');document.getElementById('video-stream').classList.add('hidden');document.getElementById('initial-controls').classList.add('hidden');document.getElementById('btn-retake').classList.remove('hidden');document.getElementById('photo-placeholder').classList.add('hidden');}}
            
            function takeSnapshot(){
                const v=document.getElementById('video-stream'),c=document.getElementById('camera-canvas');
                c.width=v.videoWidth;c.height=v.videoHeight;
                c.getContext('2d').drawImage(v,0,0);
                c.toBlob(b=>{
                    capturedBlob=b;
                    const i=document.getElementById('captured-image');
                    i.src=URL.createObjectURL(b);
                    i.classList.remove('hidden');
                    v.classList.add('hidden');
                    document.getElementById('btn-capture').classList.add('hidden');
                    document.getElementById('btn-retake').classList.remove('hidden');
                    if(videoStream){ videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
                },'image/jpeg',0.8);
            }       
        
            function resetCamera(){document.getElementById('captured-image').classList.add('hidden');document.getElementById('btn-retake').classList.add('hidden');document.getElementById('btn-capture').classList.add('hidden');document.getElementById('video-stream').classList.add('hidden');document.getElementById('initial-controls').classList.remove('hidden');document.getElementById('file-upload').value='';document.getElementById('photo-placeholder').classList.remove('hidden');capturedBlob=null;if(videoStream){videoStream.getTracks().forEach(t=>t.stop());videoStream=null;}}
            function triggerPhotoUpload(){document.getElementById('emp-upload-photo').click();}
            function previewPhoto(e){const f=e.target.files[0];if(f){const r=new FileReader();r.onload=function(ev){document.getElementById('emp-photo-real').src=ev.target.result;document.getElementById('emp-photo-real').classList.remove('hidden');document.getElementById('emp-avatar').classList.add('hidden');document.getElementById('save-btn-container').classList.remove('hidden');};r.readAsDataURL(f);}}
            
            
            function toggleEditMode(){const ids=['emp-email','emp-phone','emp-address','emp-dob'], btn=document.getElementById('save-btn-container'), dis=document.getElementById('emp-email').disabled; ids.forEach(i=>{const el=document.getElementById(i); el.disabled=!dis; if(!dis)el.classList.add('bg-white','ring-2','ring-blue-100'); else el.classList.remove('bg-white','ring-2','ring-blue-100');}); if(dis){btn.classList.remove('hidden');document.getElementById('emp-email').focus();}else{btn.classList.add('hidden');loadMyProfile();}}
                                                                    



    async function saveMyProfile() {
        Swal.fire({ title: 'Sauvegarde...', didOpen: () => Swal.showLoading() });

        // --- CORRECTION : Recherche sécurisée du Matricule ---
        // On nettoie les noms (enlève points, espaces) pour comparer "sena.broda" et "Sena Broda"
        const normalize = (s) => s ? s.toLowerCase().replace(/[\.\s_-]/g, '') : '';
        const searchNom = normalize(currentUser.nom);

        const myData = employees.find(e => 
            normalize(e.nom) === searchNom || 
            normalize(e.nom).includes(searchNom) || 
            searchNom.includes(normalize(e.nom))
        );

        // Si on trouve l'employé dans la liste, on prend son Matricule (myData.id)
        // Sinon on garde l'ID de secours
        const idToSend = (myData && myData.id) ? myData.id : currentUser.id;
        
        // Log pour vérifier dans ta console (F12) avant l'envoi
        console.log("Tentative d'envoi pour l'ID :", idToSend);

        const fd = new FormData();
        fd.append('id', idToSend); // Envoie le Matricule au lieu du Record ID
        fd.append('email', document.getElementById('emp-email').value);
        fd.append('phone', document.getElementById('emp-phone').value);
        fd.append('address', document.getElementById('emp-address').value);
        fd.append('dob', document.getElementById('emp-dob').value);
        fd.append('agent', currentUser.nom);
        fd.append('doc_type', 'text_update'); 

        const pI = document.getElementById('emp-upload-photo');
        if (pI.files[0]) {
            fd.append('new_photo', pI.files[0]); 
        }

        try {
            const response = await secureFetch(URL_EMPLOYEE_UPDATE, { 
                method: 'POST', 
                body: fd 
            });
            
            if (response.ok) {
                Swal.fire('Succès', 'Votre profil a été mis à jour', 'success');
                toggleEditMode(); 
                fetchData(true); // On met à jour ses infos
            } else {
                throw new Error("Erreur serveur (" + response.status + ")");
            }
        } catch (e) {
            Swal.fire('Erreur', 'Échec de l\'enregistrement : ' + e.message, 'error');
        }
    }


                                        async function handleOnboarding(e) {
                e.preventDefault();
                console.log("Tentative de création de profil...");

                // 1. Vérification de la photo de profil (Obligatoire)
                if (!capturedBlob) {
                    return Swal.fire('Attention', 'La photo de profil est obligatoire pour créer un compte.', 'warning');
                }

                const fd = new FormData();

                try {
                    // 2. Récupération sécurisée des champs texte
                    // On vérifie que les éléments existent avant de lire .value
                    const getVal = (id) => {
                        const el = document.getElementById(id);
                        return el ? el.value : "";
                    };

                    fd.append('nom', getVal('f-nom'));
                    fd.append('email', getVal('f-email'));
                    fd.append('telephone', getVal('f-phone'));
                    fd.append('dob', getVal('f-dob'));
                    fd.append('adresse', getVal('f-address'));
                    fd.append('date', getVal('f-date'));
                    fd.append('poste', getVal('f-poste'));
                    fd.append('dept', getVal('f-dept'));
                    fd.append('limit', getVal('f-limit'));
                    fd.append('role', getVal('f-role'));
                    fd.append('agent', currentUser ? currentUser.nom : "Système");

                    // 3. Ajout de la photo de profil (Obligatoire)
                    fd.append('photo', capturedBlob, 'photo_profil.jpg');

                    // 4. Ajout des documents KYC (Optionnels)
                    // IMPORTANT : On vérifie s'ils existent AVANT de les ajouter
                    if (docBlobs.id_card) fd.append('id_card', docBlobs.id_card, 'piece_identite.jpg');
                    if (docBlobs.cv) fd.append('cv', docBlobs.cv, 'cv.jpg');
                    if (docBlobs.diploma) fd.append('diploma', docBlobs.diploma, 'diplome.jpg');
                    if (docBlobs.attestation) fd.append('attestation', docBlobs.attestation, 'attestation.jpg');

                    // 5. Affichage du chargement
                    Swal.fire({
                        title: 'Création du dossier...',
                        text: 'Envoi des informations et des documents au serveur sécurisé',
                        didOpen: () => Swal.showLoading(),
                        allowOutsideClick: false
                    });

                    // 6. Envoi au serveur Render
                    const response = await secureFetch(URL_WRITE_POST, {
                        method: 'POST',
                        body: fd
                    });

                    if (response.ok) {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Profil créé !',
                            text: 'Le collaborateur a été ajouté et ses accès ont été envoyés par email.',
                            confirmButtonColor: '#2563eb'
                        });
                        
                        fetchData(true); // On force uniquement la mise à jour de la liste des employés

                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Erreur serveur");
                    }

                } catch (error) {
                    console.error("Erreur lors de l'onboarding:", error);
                    Swal.fire('Échec', "Impossible de créer le profil : " + error.message, 'error');
                }
            }












            function startScanner(){
                let scannerInstance = null;
                Swal.fire({
                    title:'SCANNER', html:'<div id="reader"></div>',
                    didOpen:()=>{
                        scannerInstance = new Html5Qrcode("reader");
                        scannerInstance.start({facingMode:"environment"},{fps:10},d=>{
                            scannerInstance.stop().then(() => {
                                let id=d; try{id=new URL(d).searchParams.get("id")}catch(e){} 
                                secureFetch(`${URL_GATEKEEPER}?id=${encodeURIComponent(id)}&key=${SCAN_KEY}&agent=${encodeURIComponent(currentUser.nom)}`)
                                .then(r=>r.json()).then(d=>{
                                    if(d.status==="valid") Swal.fire('ACCÈS OK',d.nom,'success'); 
                                    else {Swal.fire({icon:'error',title:'REFUSÉ'}).then(()=>location.href=URL_REDIRECT_FAILURE);}
                                });
                            });
                        });
                    },
                    willClose: () => { if(scannerInstance) { scannerInstance.stop().catch(err => console.log("Stop Qr")); } }
                }); 
            }
            








                                                                        async function fetchLogs() {
                const tbody = document.getElementById('logs-body');
                tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center italic text-slate-400">Chargement...</td></tr>';
                try {
                    const res = await secureFetch(`${URL_READ_LOGS}?agent=${encodeURIComponent(currentUser.nom)}`); 
                    const raw = await res.json();
                    tbody.innerHTML = '';
                    [...raw].reverse().forEach(log => {
                        let date, agent, action, details;
                        if (Array.isArray(log)) { date=log[0]; agent=log[1]; action=log[2]; details=log[4]; } 
                        else { date=log.date||log.Timestamp||log.created_at; agent=log.agent||'Système'; action=log.action||'-'; details=log.détails||log.details||'-'; }
                        const dF = date ? new Date(date).toLocaleString('fr-FR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
                        
                        // UTILISATION DE escapeHTML ICI
                        tbody.innerHTML += `<tr class="border-b"><td class="p-4 text-xs font-mono">${dF}</td><td class="p-4 font-bold text-slate-700">${escapeHTML(agent)}</td><td class="p-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[10px] font-black">${escapeHTML(action)}</span></td><td class="p-4 text-xs text-slate-500">${escapeHTML(details)}</td></tr>`;
                    });
                } catch(e) { tbody.innerHTML = `<tr><td colspan="4" class="text-red-500 p-4 font-bold text-center">${escapeHTML(e.message)}</td></tr>`; }
            }



                                                                                        // Fonction pour ouvrir n'importe quel doc en mode lecture (PDF, IMG, Word...)
    function viewDocument(url, title) {
        if (!url || url === '#' || url === 'null') {
            return Swal.fire('Oups', 'Aucun document disponible.', 'info');
        }

        // 1. On extrait l'ID Google Drive
        const str = String(url);
        const match = str.match(/\/d\/([a-zA-Z0-9_-]+)/) || str.match(/id=([a-zA-Z0-9_-]+)/);
        
        let finalUrl = url;

        // 2. Si c'est du Drive, on force le mode "PREVIEW" (Liseuse)
        if (match && match[1]) {
            finalUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
        }

        // 3. On ouvre une belle modale
        Swal.fire({
            title: `<span class="text-sm font-bold uppercase text-slate-500">${title || 'Document'}</span>`,
            html: `
                <div class="rounded-xl overflow-hidden border border-slate-200 bg-slate-100" style="height: 75vh;">
                    <iframe src="${finalUrl}" width="100%" height="100%" style="border:none;" allow="autoplay"></iframe>
                </div>
                <div class="mt-2 text-right">
                    <a href="${url}" target="_blank" class="text-xs font-bold text-blue-600 hover:underline">
                        <i class="fa-solid fa-external-link-alt"></i> Ouvrir dans une nouvelle fenêtre
                    </a>
                </div>
            `,
            width: '90%', // Largeur quasi plein écran
            showConfirmButton: true,
            confirmButtonText: 'Fermer',
            confirmButtonColor: '#0f172a',
            padding: '1rem'
        });
    }



            
            function generateDraftContract(id) { 
                const e = employees.find(x => x.id === id); if(!e) return; 
                const token = localStorage.getItem('sirh_token');
                window.open(`${URL_CONTRACT_GENERATE}?id=${encodeURIComponent(id)}&nom=${encodeURIComponent(e.nom)}&poste=${encodeURIComponent(e.poste)}&date=${encodeURIComponent(e.date)}&agent=${encodeURIComponent(currentUser.nom)}&token=${token}`, '_blank'); 
            }
            

            









                function openContractModal(id) {
                    document.getElementById('contract-id-hidden').value = id;
                    document.getElementById('contract-modal').classList.remove('hidden');
                    
                    // Initialisation du pad de signature sur le canvas
                    const canvas = document.getElementById('signature-pad');
                    signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgba(255, 255, 255, 0)', // Fond transparent
                        penColor: 'rgb(0, 0, 0)' // Encre noire
                    });

                    // Cette partie est CRUCIALE pour que la signature soit précise sur mobile (Retina display)
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePad.clear(); // On vide le cadre au cas où
                }








        
        
            function closeContractModal() { if(contractStream) contractStream.getTracks().forEach(t => t.stop()); document.getElementById('contract-modal').classList.add('hidden'); }
            async function startContractCamera() { try { contractStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); const v = document.getElementById('contract-video'); v.srcObject = contractStream; v.classList.remove('hidden'); document.getElementById('contract-img-preview').classList.add('hidden'); document.getElementById('contract-icon').classList.add('hidden'); document.getElementById('btn-contract-capture').classList.remove('hidden'); } catch(e) { Swal.fire('Erreur', 'Caméra inaccessible', 'error'); } }
            
            function takeContractSnapshot() { 
                const v = document.getElementById('contract-video'); const c = document.createElement('canvas'); 
                c.width = v.videoWidth; c.height = v.videoHeight; c.getContext('2d').drawImage(v, 0, 0); 
                c.toBlob(blob => { 
                    contractBlob = blob; const img = document.getElementById('contract-img-preview'); 
                    img.src = URL.createObjectURL(blob); img.classList.remove('hidden'); v.classList.add('hidden'); 
                    document.getElementById('btn-contract-capture').classList.add('hidden'); 
                    if(contractStream) { contractStream.getTracks().forEach(t => t.stop()); contractStream = null; }
                }, 'image/jpeg', 0.8); 
            }
            
            function previewContractFile(e) { const file = e.target.files[0]; if(!file) return; contractBlob = file; if(file.type.includes('image')) { const img = document.getElementById('contract-img-preview'); img.src = URL.createObjectURL(file); img.classList.remove('hidden'); document.getElementById('contract-icon').classList.add('hidden'); } }
            function resetContractCamera() { contractBlob = null; document.getElementById('contract-img-preview').classList.add('hidden'); document.getElementById('contract-video').classList.add('hidden'); document.getElementById('contract-icon').classList.remove('hidden'); document.getElementById('btn-contract-capture').classList.add('hidden'); if(contractStream) contractStream.getTracks().forEach(t => t.stop()); }
            

            



    async function submitFlashMessage(e) {
        e.preventDefault();
        
        const msgInput = document.getElementById('flash-input-msg');
        const typeInput = document.getElementById('flash-input-type');
        const durationInput = document.getElementById('flash-input-duration');

        if(!msgInput || !durationInput) return;

        const msg = msgInput.value;
        const type = typeInput ? typeInput.value : "Info";
        const durationMinutes = parseFloat(durationInput.value);
        
        const now = new Date();
        // CALCUL : Maintenant + (Minutes choisies * 60 000 ms)
        const expirationDate = new Date(now.getTime() + (durationMinutes * 60000));

        Swal.fire({ title: 'Publication...', didOpen: () => Swal.showLoading() });

        try {
            const response = await secureFetch(URL_WRITE_FLASH, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: msg,
                    type: type,
                    sender: currentUser.nom,
                    date: now.toISOString(),
                    date_expiration: expirationDate.toISOString(),
                    agent: currentUser.nom
                })
            });

            if (response.ok) {
                document.getElementById('flash-modal').classList.add('hidden');
                const timeStr = expirationDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                Swal.fire('Succès !', `L'alerte est publiée. Elle expirera à ${timeStr}`, 'success');
                // On rafraîchit l'affichage pour voir le message immédiatement
                setTimeout(() => fetchFlashMessage(), 1000);
            }
        } catch (e) {
            console.error("Erreur envoi flash:", e);
            Swal.fire('Erreur', "Le serveur n'a pas reçu l'info. Vérifie ta connexion.", 'error');
        }
    }










    async function submitSignedContract() { 
        // On vérifie si l'employé a dessiné quelque chose
        if (!signaturePad || signaturePad.isEmpty()) { 
            return Swal.fire('Attention', 'Veuillez apposer votre signature avant de valider.', 'warning'); 
        }

        const id = document.getElementById('contract-id-hidden').value; 
        
        // MAGIE : On transforme le dessin en texte Base64
        const signatureBase64 = signaturePad.toDataURL(); 

        Swal.fire({ 
            title: 'Signature en cours...', 
            text: 'Incrustation de votre signature dans le contrat PDF', 
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false
        }); 

        try { 
            // On envoie le texte de la signature à ton Webhook au lieu du fichier
            const r = await secureFetch(URL_UPLOAD_SIGNED_CONTRACT, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: id, 
                    signature: signatureBase64, // C'est cette variable que Make utilisera
                    agent: currentUser.nom 
                }) 
            }); 
            
            if (r.ok) { 
                Swal.fire('Succès', 'Le contrat a été signé numériquement et archivé avec succès.', 'success'); 
                closeContractModal(); 
                refreshAllData(); 
            } 
        } catch (e) { 
            console.error(e);
            Swal.fire('Erreur', "Échec technique lors de la signature : " + e.message, 'error'); 
        } 
    }





    function showLeaveDetail(encodedNom, encodedType, debut, fin, encodedMotif, encodedLink) {
        // 1. DÉCODAGE DES DONNÉES
        const nom = decodeURIComponent(encodedNom || "");
        const type = decodeURIComponent(encodedType || "Congé");
        const motif = decodeURIComponent(encodedMotif || "Aucun motif précisé");

        // 2. Gestion du lien document
        let docLink = null;
        if (encodedLink && encodedLink !== 'null' && encodedLink !== 'undefined') {
            docLink = decodeURIComponent(encodedLink);
        }

        let documentHtml = '';
        
        // On récupère l'ID Drive pour construire le mode "Preview"
        const driveId = typeof getDriveId === 'function' ? getDriveId(docLink) : null;

        if (driveId) {
            // C'est un lien Google Drive valide -> ON AFFICHE LA PREVIEW (Compacte)
            const previewUrl = `https://drive.google.com/file/d/${driveId}/preview`;
            
            documentHtml = `
                <div class="mt-4 pt-3 border-t border-slate-100 animate-fadeIn">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2 flex justify-between items-center">
                        <span>Aperçu</span>
                        <a href="${docLink}" target="_blank" class="text-blue-600 hover:underline cursor-pointer"><i class="fa-solid fa-expand mr-1"></i>Ouvrir</a>
                    </p>
                    
                    <!-- ZONE DE PREVIEW RÉDUITE (Hauteur 180px) -->
                    <div class="rounded-xl overflow-hidden border border-slate-200 shadow-sm bg-slate-100 relative group h-[180px]">
                        <iframe src="${previewUrl}" width="100%" height="100%" style="border:none;" allow="autoplay"></iframe>
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 pointer-events-none transition-all"></div>
                    </div>
                </div>
            `;
        } 
        else if (docLink && docLink.length > 5) {
            // Lien existe mais pas Google Drive (Compacte)
            documentHtml = `
                <div class="mt-4 pt-3 border-t border-slate-100">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Justificatif</p>
                    <div class="text-center">
                        <!-- Image réduite (max-h-40) -->
                        <img src="${docLink}" class="max-h-40 rounded-lg mx-auto border shadow-sm cursor-pointer hover:scale-105 transition-transform" 
                            onclick="Swal.fire({imageUrl: '${docLink}', showConfirmButton: false, width: '90vw'})" 
                            alt="Justificatif" 
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        
                        <a href="${docLink}" target="_blank" style="display:none" class="flex items-center gap-2 p-2 border rounded-lg bg-slate-50 hover:bg-slate-100 justify-center">
                            <i class="fa-solid fa-paperclip text-slate-400 text-xs"></i>
                            <span class="text-xs font-bold text-slate-700">Voir le fichier</span>
                        </a>
                    </div>
                </div>
            `;
        } 
        else {
            // Aucun document (Compacte)
            documentHtml = `
                <div class="mt-4 pt-3 border-t border-slate-100">
                    <div class="flex items-center gap-2 p-2 rounded-lg border border-dashed border-slate-200 text-slate-400 bg-slate-50/50">
                        <i class="fa-solid fa-file-circle-xmark text-xs"></i>
                        <span class="text-[10px] font-bold">Aucun document</span>
                    </div>
                </div>
            `;
        }

        // Affichage de la modale (Configuration Compacte)
        Swal.fire({
            html: `
                <div class="text-left font-sans">
                    <!-- Header plus serré -->
                    <div class="flex justify-between items-start mb-4 border-b border-slate-100 pb-3">
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Collaborateur</p>
                            <h3 class="font-extrabold text-base text-slate-800 leading-tight">${nom}</h3>
                        </div>
                        <div class="bg-blue-50 text-blue-700 px-2.5 py-1 rounded-md text-[9px] font-black uppercase tracking-wide border border-blue-100">
                            ${type}
                        </div>
                    </div>

                    <!-- Dates plus serrées -->
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-3">
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-0.5">Du (Matin)</p>
                                <p class="font-bold text-xs text-slate-700">${debut}</p>
                            </div>
                            <div class="pl-2">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-0.5">Au (Soir)</p>
                                <p class="font-bold text-xs text-slate-700">${fin}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Motif plus serré -->
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Motif</p>
                        <div class="bg-white p-3 rounded-xl text-xs text-slate-700 border border-slate-200 italic shadow-sm leading-relaxed">
                            "${motif}"
                        </div>
                    </div>
                    
                    ${documentHtml}
                </div>
            `,
            showConfirmButton: true,
            confirmButtonText: 'Fermer',
            confirmButtonColor: '#0f172a',
            width: 480, // Largeur réduite (était 600)
            padding: '1.25rem', // Padding réduit
            customClass: {
                popup: 'rounded-[1.5rem]'
            }
        });
    }














    function handleLogout() {
                if(videoStream) videoStream.getTracks().forEach(t => t.stop());
                if(contractStream) contractStream.getTracks().forEach(t => t.stop());
                
                // NETTOYAGE COMPLET
                localStorage.removeItem('sirh_token');
                localStorage.removeItem('sirh_user_session'); // Supprime l'identité sauvegardée
                
                location.reload();
            }





            async function syncOfflineData() {
                const queue = JSON.parse(localStorage.getItem('sirh_offline_queue') || '[]');
                
                if (queue.length === 0) return; // Rien à faire

                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false});
                Toast.fire({icon: 'info', title: `Synchronisation de ${queue.length} pointage(s)...`});

                const remainingQueue = [];

                for (const item of queue) {
                    try {
                        // On tente d'envoyer
                        await secureFetch(URL_CLOCK_ACTION, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(item) 
                        });
                    } catch (e) {
                        console.error("Echec synchro item", item, e);
                        remainingQueue.push(item); // Si ça rate encore, on le garde pour la prochaine fois
                    }
                }

                // Mise à jour de la file d'attente (on ne garde que les échecs)
                localStorage.setItem('sirh_offline_queue', JSON.stringify(remainingQueue));

                if (remainingQueue.length === 0) {
                    Toast.fire({icon: 'success', title: 'Tous les pointages ont été synchronisés !'});
                    document.getElementById('clock-last-action').innerText = "Dernière action : " + new Date().toLocaleTimeString() + " (Synchronisé)";
                } else {
                    Toast.fire({icon: 'warning', title: `Reste ${remainingQueue.length} pointage(s) à envoyer.`});
                }
            }






            window.addEventListener('offline', () => { Swal.fire({ icon: 'warning', title: 'Connexion Perdue', text: 'Mode hors ligne.', toast: true, position: 'top-end', showConfirmButton: false, timer: 5000 }); document.body.classList.add('offline-mode'); });
        
        
        
        
                                                                                        // --- GESTION INTELLIGENTE DU RÉSEAU ---
            window.addEventListener('online', () => { 
                // 1. On ferme les alertes SweetAlert s'il y en a (comme "Pas de connexion")
                Swal.close();
                
                // 2. On affiche un petit toast vert
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
                Toast.fire({ icon: 'success', title: 'Connexion Rétablie', text: 'Vous êtes de nouveau en ligne.' }); 
                
                // 3. On enlève le mode visuel hors ligne
                document.body.classList.remove('offline-mode'); 
                
                // 4. On synchronise les pointages en attente
                syncOfflineData();

                // 5. On rafraîchit les données visuelles
                if(currentUser) refreshAllData();
            });
        
       


    





async function fetchLeaveRequests() {
    // CORRECTION 1 : On ne bloque plus les employés ici !
    if (!currentUser) return; 

    const body = document.getElementById('leave-requests-body');       // Tableau Manager
    const section = document.getElementById('manager-leave-section');  // Section Manager
    const myBody = document.getElementById('my-leave-requests-body');  // Tableau Personnel

    // Fonction de nettoyage interne
    const normalize = (s) => String(s || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

    try {
        const r = await secureFetch(`${URL_READ_LEAVES}?agent=${encodeURIComponent(currentUser.nom)}`);
        const rawLeaves = await r.json();

        // Mapping des données
        allLeaves = rawLeaves.map(l => {
            const clean = (v) => Array.isArray(v) ? v[0] : v;
            const rawNom = clean(l.Employees_nom || l.nom || l['Employé']);
            
            return {
                id: l.record_id || l.id || '',
                nom: rawNom ? String(rawNom).trim() : null,
                nomIndex: normalize(rawNom),
                statut: normalize(clean(l.Statut || l.statut)),
                type: normalize(clean(l.Type || l.type)),
                debut: clean(l['Date Début'] || l['Date de début'] || l.debut) ? parseDateSmart(clean(l['Date Début'] || l['Date de début'] || l.debut)) : null,
                fin: clean(l['Date Fin'] || l['Date de fin'] || l.fin) ? parseDateSmart(clean(l['Date Fin'] || l['Date de fin'] || l.fin)) : null,
                motif: clean(l.motif || l.Motif || "Aucun motif"),
                doc: clean(l.justificatif_link || l.Justificatif || l.doc || null)
            };
        });

        // ============================================================
        // PARTIE 1 : TABLEAU DE VALIDATION (POUR MANAGER / ADMIN / RH)
        // ============================================================
        if (currentUser.role !== 'EMPLOYEE') {
            const pending = allLeaves.filter(l => l.statut === 'en attente');

            if (body && section) {
                body.innerHTML = '';
                if (pending.length > 0) {
                    section.classList.remove('hidden');
                    pending.forEach(l => {
                        const safeNom = encodeURIComponent(l.nom || 'Inconnu');
                        const safeType = encodeURIComponent(l.type || 'Congé');
                        const dStart = l.debut ? l.debut.toLocaleDateString() : '?';
                        const dEnd = l.fin ? l.fin.toLocaleDateString() : '?';
                        const diffTime = Math.abs(l.fin.getTime() - l.debut.getTime());
                        const daysDifference = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        const safeMotif = encodeURIComponent(l.motif);
                        const safeDoc = l.doc ? encodeURIComponent(l.doc) : '';

                        body.innerHTML += `
                            <tr class="border-b hover:bg-slate-50 transition-colors">
                                <td class="px-8 py-4">
                                    <div class="font-bold text-sm text-slate-700">${l.nom || 'Inconnu'}</div>
                                    <div class="text-[10px] text-slate-400 font-normal uppercase">${l.type || 'Congé'}</div>
                                </td>
                                <td class="px-8 py-4 text-xs text-slate-500">${dStart} ➔ ${dEnd}</td>
                                <td class="px-8 py-4 text-right flex justify-end items-center gap-2">
                                    <button onclick="showLeaveDetail('${safeNom}', '${safeType}', '${dStart}', '${dEnd}', '${safeMotif}', '${safeDoc}')" 
                                            class="p-2 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-sm mr-2">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>
                                    <button onclick="processLeave('${l.id}', 'Validé', ${daysDifference})" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-md shadow-emerald-200">OUI</button>
                                    <button onclick="processLeave('${l.id}', 'Refusé', 0)" class="bg-white text-red-500 border border-red-100 px-4 py-2 rounded-xl text-[10px] font-black uppercase">NON</button>
                                </td>
                            </tr>`;
                    });
                } else {
                    section.classList.add('hidden');
                }
            }
        }

        // ============================================================
        // PARTIE 2 : HISTORIQUE PERSONNEL (POUR TOUT LE MONDE)
        // ============================================================
        // CORRECTION 2 : Cette partie s'exécute maintenant car on a retiré le return au début
        if (myBody) {
            myBody.innerHTML = '';
            
            // On filtre les demandes qui appartiennent à l'utilisateur connecté
            // Utilisation de normalize pour éviter les erreurs d'espaces/majuscules
            const myNameNormalized = normalize(currentUser.nom);
            const myRequests = allLeaves.filter(l => l.nomIndex === myNameNormalized);

            if (myRequests.length === 0) {
                myBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">Aucune demande soumise.</td></tr>';
            } else {
                // On trie par date (plus récent en haut)
                myRequests.sort((a, b) => b.debut - a.debut);

                myRequests.forEach(r => {
                    const dStart = r.debut ? r.debut.toLocaleDateString() : '?';
                    const dEnd = r.fin ? r.fin.toLocaleDateString() : '?';
                    
                    let statusClass = 'bg-slate-100 text-slate-600';
                    let statusText = r.statut.toUpperCase();

                    if (r.statut.includes('attente')) {
                        statusClass = 'bg-yellow-50 text-yellow-700 border border-yellow-100';
                        statusText = '⏳ EN ATTENTE';
                    } else if (r.statut.includes('valid')) {
                        statusClass = 'bg-emerald-50 text-emerald-700 border border-emerald-100';
                        statusText = '✅ APPROUVÉ';
                    } else if (r.statut.includes('refus')) {
                        statusClass = 'bg-red-50 text-red-700 border border-red-100';
                        statusText = '❌ REFUSÉ';
                    }

                    myBody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition-colors border-b last:border-0">
                            <td class="px-6 py-4 text-xs font-bold text-slate-700">${dStart} <span class="text-slate-400 mx-1">au</span> ${dEnd}</td>
                            <td class="px-6 py-4 text-xs font-medium text-slate-500 capitalize">${r.type}</td>
                            <td class="px-6 py-4 text-xs text-slate-400 italic">${r.motif.substring(0, 25) + (r.motif.length > 25 ? '...' : '')}</td>
                            <td class="px-6 py-4 text-right">
                                <span class="px-2.5 py-1.5 rounded-lg text-[10px] font-black ${statusClass}">${statusText}</span>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        // Mise à jour des graphiques si nécessaire
        renderCharts();

    } catch (e) {
        console.error("Erreur fetchLeaveRequests:", e);
        if(myBody) myBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">Erreur de chargement des congés.</td></tr>';
    }
}



















    function renderCharts() {
        if (!employees || employees.length === 0) return;

        // 1. ÉLIMINATION DES DOUBLONS D'EMPLOYÉS (par matricule unique)
        const uniqueEmployees = [];
        const seenIds = new Set();
        employees.forEach(emp => {
            if (!seenIds.has(emp.id)) {
                seenIds.add(emp.id);
                uniqueEmployees.push(emp);
            }
        });

        let counts = { 'Actif': 0, 'Congé': 0, 'Sortie': 0 };
        const today = new Date();
        today.setHours(0, 0, 0, 0); 

        const normalize = (s) => String(s || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

        console.log("--- DÉBUT CALCUL GRAPHIQUE (PRIORITÉ CUMULÉE) ---");

        uniqueEmployees.forEach(emp => {
            const empNomIndex = normalize(emp.nom);
            const empStatutProfil = normalize(emp.statut);

            // A. PRIORITÉ SORTIE : Si marqué Sortie dans le profil Airtable
            if (empStatutProfil.includes('sortie')) {
                counts['Sortie']++;
                return;
            }

            // B. SOURCE 1 : Vérification dans la table CONGES (Validé + Dates)
            const aUnCongeValideEnTable = allLeaves.some(leave => {
                if (!leave.nomIndex || !leave.debut || !leave.fin) return false;
                
                // Comparaison STRICTE du nom pour éviter de confondre Josue Dominique et Dominique
                const matchNomStrict = (leave.nomIndex === empNomIndex);
                const estValide = (leave.statut === "valide");
                const estDansDates = (today >= leave.debut && today <= leave.fin);
                const nEstPasTele = (!leave.type.includes("teletravail"));

                return matchNomStrict && estValide && estDansDates && nEstPasTele;
            });

            // C. SOURCE 2 : Vérification du statut manuel "Congé" dans la fiche employé
            const estEnCongeDansProfil = empStatutProfil.includes('conge');

            // D. SYNTHÈSE : Si l'un des deux est Vrai, on le compte en congé
            if (aUnCongeValideEnTable || estEnCongeDansProfil) {
                console.info(`[CONGÉ] ${emp.nom} comptabilisé.`);
                counts['Congé']++;
            } else {
                counts['Actif']++;
            }
        });

        // --- SYNCHRONISATION DES CHIFFRES DU DASHBOARD ---
        if(document.getElementById('stat-total')) document.getElementById('stat-total').innerText = uniqueEmployees.length;
        if(document.getElementById('stat-active')) document.getElementById('stat-active').innerText = counts['Actif'];

        // --- RENDU CHART.JS (STATUT) ---
        if (chartStatusInstance) chartStatusInstance.destroy();
        const ctxStatus = document.getElementById('chartStatus').getContext('2d');
        chartStatusInstance = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Actif', 'Congé', 'Sortie'],
                datasets: [{
                    data: [counts['Actif'], counts['Congé'], counts['Sortie']],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], 
                    borderWidth: 0
                }]
            },
            options: { 
                plugins: { legend: { position: 'bottom' } }, 
                cutout: '70%',
                animation: { duration: 800 }
            }
        });

        // --- RENDU CHART.JS (DÉPARTEMENT) ---
        const deptCounts = {};
        uniqueEmployees.forEach(e => { 
            const d = e.dept || 'Inconnu';
            deptCounts[d] = (deptCounts[d] || 0) + 1; 
        });
        if (chartDeptInstance) chartDeptInstance.destroy();
        const ctxDept = document.getElementById('chartDept').getContext('2d');
        chartDeptInstance = new Chart(ctxDept, {
            type: 'bar',
            data: {
                labels: Object.keys(deptCounts),
                datasets: [{ label: 'Collaborateurs', data: Object.values(deptCounts), backgroundColor: '#6366f1', borderRadius: 8 }]
            },
            options: { 
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } }, 
                plugins: { legend: { display: false } } 
            }
        });
    }

    









    

    async function fetchFlashMessage() {
        const container = document.getElementById('flash-container');
        if (!container) return;

        try {
            const r = await secureFetch(`${URL_READ_FLASH}?agent=${encodeURIComponent(currentUser.nom)}`);
            let messages = await r.json();
            if (!Array.isArray(messages)) messages = messages ? [messages] : [];

            const lastNotifId = localStorage.getItem('last_flash_id');
            let latestId = null;

            container.innerHTML = '';
            const now = new Date().getTime();
            const normalize = (s) => String(s || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

            messages.forEach((data, index) => {
                const msgText = data.Message || data.message;
                const msgSender = data.Sender || data.sender;
                const msgType = data.Type || data.type || 'Info';
                const msgDate = data.Date || data.date;
                const msgId = msgDate + msgSender; // Identifiant unique basé sur date et auteur

                if (!msgText || normalize(msgSender) === normalize(currentUser.nom)) return;

                // --- LOGIQUE PUSH NOTIFICATION ---
                // Si c'est le message le plus récent et qu'on ne l'a pas encore notifié
                if (index === 0) {
                    latestId = msgId;
                    if (lastNotifId !== msgId) {
                        triggerGlobalPush(`NOUVELLE ANNONCE : ${msgType}`, msgText);
                        localStorage.setItem('last_flash_id', msgId);
                    }
                }

                // ... (Ici tu gardes ton code de design de la bannière existant) ...
                const styles = {
                    'Info': { bg: 'bg-gradient-to-r from-blue-600 to-indigo-600', icon: 'fa-circle-info' },
                    'Urgent': { bg: 'bg-gradient-to-r from-red-600 to-rose-600', icon: 'fa-triangle-exclamation' },
                    'Maintenance': { bg: 'bg-gradient-to-r from-yellow-500 to-orange-500', icon: 'fa-screwdriver-wrench' }
                };
                const st = styles[msgType] || styles['Info'];
                const msgKey = `flash_closed_${msgId}`;
                if (sessionStorage.getItem(msgKey)) return;

                container.innerHTML += `
                    <div id="flash-msg-${index}" class="${st.bg} rounded-2xl p-4 text-white shadow-lg relative overflow-hidden mb-3">
                        <div class="relative z-10 flex items-start gap-4">
                            <div class="p-3 bg-white/20 rounded-xl"><i class="fa-solid ${st.icon} text-xl animate-pulse"></i></div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <p class="text-[9px] font-black uppercase opacity-80">${msgType} • PAR ${msgSender.toUpperCase()}</p>
                                    <button onclick="closeSpecificFlash('${msgKey}', 'flash-msg-${index}')"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <p class="font-bold text-sm">${msgText}</p>
                            </div>
                        </div>
                    </div>`;
            });
        } catch (e) { console.warn(e); }
    }






    // Fonction pour afficher les documents cachés
    function toggleMoreDocs(btn) {
        // Affiche tous les éléments cachés
        document.querySelectorAll('.more-docs').forEach(el => {
            el.classList.remove('hidden');
            el.classList.add('animate-fadeIn'); // Petit effet d'apparition
        });
        // Supprime le bouton après le clic
        btn.parentElement.remove();
    }








    // Nouvelle fonction intermédiaire pour décoder les données sécurisées
    function showLeaveDetailFromSafeData(safeNom, type, debut, fin, safeMotif, safeDocLink) {
        const nom = decodeURIComponent(safeNom);
        const motif = decodeURIComponent(safeMotif);
        const docLink = safeDocLink ? decodeURIComponent(safeDocLink) : null;
        
        // Appel de la vraie fonction d'affichage
        showLeaveDetail(nom, type, debut, fin, motif, docLink);
    }







async function processLeave(recordId, decision, daysToDeduct = 0) {
    // daysToDeduct est maintenant le nombre de jours calculé entre début et fin

    // 1. Demander confirmation à l'utilisateur
    const confirmation = await Swal.fire({
        title: decision === 'Validé' ? `Approuver ${daysToDeduct} jours de congé ?` : 'Refuser ce congé ?',
        // On affiche directement le nombre de jours dans le texte :
        text: decision === 'Validé' ? `La déduction de ${daysToDeduct} jours sera appliquée au solde de l'employé.` : "L'employé sera informé de cette décision.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Oui, confirmer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: decision === 'Validé' ? '#10b981' : '#ef4444'
    });

    if (confirmation.isConfirmed) {
        // 2. Afficher un chargement
        Swal.fire({ 
            title: 'Traitement en cours...', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
        });

        // NOUVEAU : On définit la déduction à daysToDeduct pour l'envoi à Make
        const finalDaysDeduct = (decision === 'Validé') ? daysToDeduct : 0;

        try {
            // 3. Envoyer l'ordre au serveur Render -> Make
            const response = await secureFetch(URL_LEAVE_ACTION, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: recordId, 
                    decision: decision, 
                    days_deduct: finalDaysDeduct, // <--- ENVOI AUTOMATIQUE DU NOMBRE
                    agent: currentUser.nom 
                })
            });

            if (response.ok) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Terminé',
                    text: `La demande a été marquée comme ${decision.toLowerCase()} et ${finalDaysDeduct} jours ont été déduits.`,
                    timer: 3000
                });
                // 4. On actualise tout pour voir le nouveau solde
                refreshAllData(true); 
            } else {
                throw new Error("Erreur du serveur");
            }
        } catch (e) {
            console.error("Erreur action congé:", e);
            Swal.fire('Erreur', "Impossible de valider l'action : " + e.message, 'error');
        }
    }
}



















    // Fonction pour choisir entre Caméra et Fichier via une alerte
    function openDocCamera(target) {
        Swal.fire({
            title: 'Source du document',
            text: "Voulez-vous prendre une photo ou choisir un fichier ?",
            showCancelButton: true,
            confirmButtonText: '📸 Caméra',
            cancelButtonText: '📁 Fichier',
            confirmButtonColor: '#2563eb'
        }).then((result) => {
            if (result.isConfirmed) {
                startGenericCamera(target);
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                document.getElementById('f-' + target).click();
            }
        });
    }

    // Démarre la caméra pour n'importe quel doc
    async function startGenericCamera(target) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            Swal.fire({
                title: 'Capture',
                html: `<video id="temp-video" autoplay playsinline class="w-full rounded-xl"></video>`,
                confirmButtonText: 'CAPTURER',
                showCancelButton: true,
                didOpen: () => { document.getElementById('temp-video').srcObject = stream; }
            }).then((result) => {
                if (result.isConfirmed) {
                    const video = document.getElementById('temp-video');
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    canvas.toBlob(blob => {
                        saveDoc(target, blob);
                        stream.getTracks().forEach(t => t.stop());
                    }, 'image/jpeg', 0.8);
                } else {
                    stream.getTracks().forEach(t => t.stop());
                }
            });
        } catch (e) { Swal.fire('Erreur', 'Caméra inaccessible', 'error'); }
    }

    // Aperçu et stockage du fichier (qu'il vienne du PC ou de la Caméra)
    function previewDocFile(event, target) {
        const file = event.target.files[0];
        if (file) saveDoc(target, file);
    }

    function saveDoc(target, fileOrBlob) {
        docBlobs[target] = fileOrBlob;
        const preview = document.getElementById('preview-' + target);
        const icon = document.getElementById('icon-' + target);
        
        if(preview) { // Si on est dans le formulaire onboarding
            preview.src = URL.createObjectURL(fileOrBlob);
            preview.classList.remove('hidden');
            if(icon) icon.classList.add('hidden');
        } else if(target === 'leave_justif') { // Si on est dans les congés
            document.getElementById('leave-doc-preview').innerHTML = '<i class="fa-solid fa-check text-emerald-500"></i>';
        }
    }




    async function updateSingleDoc(docKey, employeeId) {
        const { value: file } = await Swal.fire({
            title: 'Mettre à jour le document',
            input: 'file',
            inputAttributes: { 'accept': 'image/*,application/pdf' },
            showCancelButton: true,
            confirmButtonText: 'Uploader',
            cancelButtonColor: '#ef4444',
            confirmButtonColor: '#2563eb'
        });

        if (file) {
            Swal.fire({ title: 'Envoi...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            const fd = new FormData();
            fd.append('id', employeeId);
            fd.append('agent', currentUser.nom);
            fd.append('new_photo', file); // On utilise le même champ binaire que ton scénario
            fd.append('doc_type', docKey); // <--- C'est ça qui ne sera plus "undefined" !

            try {
                const r = await secureFetch(URL_EMPLOYEE_UPDATE, { method: 'POST', body: fd });
                if (r.ok) {
                    Swal.fire('Succès', 'Document mis à jour', 'success');
                    refreshAllData();
                }
            } catch (e) { Swal.fire('Erreur', e.message, 'error'); }
        }
    }










    async function fetchCandidates() {
    const body = document.getElementById('candidates-body');
    body.innerHTML = '<tr><td colspan="4" class="p-8 text-center"><i class="fa-solid fa-circle-notch fa-spin text-blue-600 text-2xl"></i><p class="text-xs text-slate-400 mt-2 font-bold uppercase">Chargement des talents...</p></td></tr>';

    try {
        const r = await secureFetch(`${URL_READ_CANDIDATES}?agent=${encodeURIComponent(currentUser.nom)}`);
        let rawData = await r.json();
        
        let candidates = [];
        if (Array.isArray(rawData)) {
            candidates = rawData;
        } else if (typeof rawData === 'object' && rawData !== null) {
            if (rawData.nom || rawData.record_id || rawData.id) {
                candidates = [rawData];
            } else if (rawData.items && Array.isArray(rawData.items)) {
                candidates = rawData.items;
            } else if (rawData.data && Array.isArray(rawData.data)) {
                candidates = rawData.data;
            }
        }

        body.innerHTML = '';

        if (candidates.length === 0) {
            body.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400 font-bold bg-slate-50 rounded-xl border border-dashed border-slate-200">Aucune candidature en attente</td></tr>';
            return;
        }

        candidates.forEach(c => {
            const safeNom = encodeURIComponent(c.nom || "Inconnu");

            const getAttachmentUrl = (attachment) => {
                if (!attachment) return null;
                if (Array.isArray(attachment) && attachment.length > 0) return attachment[0].url;
                if (typeof attachment === 'string' && attachment.startsWith('http')) return attachment;
                return null;
            };

            const cvLink = getAttachmentUrl(c.cv_link);
            const lMLink = getAttachmentUrl(c.lm_link);
            const dipLink = getAttachmentUrl(c.diploma_link);
            const attLink = getAttachmentUrl(c.attestation_link);
            const idCardLink = getAttachmentUrl(c.id_card_link);

            const safeCv = cvLink ? encodeURIComponent(cvLink) : '';
            const safeLm = lMLink ? encodeURIComponent(lMLink) : '';
            const safeDip = dipLink ? encodeURIComponent(dipLink) : '';
            const safeAtt = attLink ? encodeURIComponent(attLink) : '';
            const safeIdCard = idCardLink ? encodeURIComponent(idCardLink) : '';

            // --- CORRECTION DE LA LOGIQUE DE STATUT ---
            let stRaw = c.statut || 'Nouveau';
            let stLogic = stRaw.toString().toLowerCase().trim(); // On transforme en minuscules pour la comparaison
            
            let badgeClass = 'bg-slate-100 text-slate-600';
            
            if(stLogic.includes('entretien')) badgeClass = 'bg-blue-100 text-blue-700';
            else if(stLogic.includes('embauché') || stLogic.includes('validé')) badgeClass = 'bg-emerald-100 text-emerald-700';
            else if(stLogic.includes('refus')) badgeClass = 'bg-red-50 text-red-500';
            else if(stLogic.includes('nouveau')) badgeClass = 'bg-yellow-50 text-yellow-700';

            const btnDocs = `
                <button onclick="showCandidateDocs('${safeNom}', '${c.poste || 'Candidat'}', '${safeCv}', '${safeLm}', '${safeDip}', '${safeAtt}', '${safeIdCard}')" 
                        class="p-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:text-blue-600 hover:border-blue-200 shadow-sm transition-all mr-2" title="Ouvrir le dossier">
                    <i class="fa-solid fa-folder-open"></i>
                </button>
            `;

            let actionButtons = '';
            // On utilise stLogic (minuscules) pour les tests IF
            if (stLogic === 'nouveau' || !c.statut) {
                actionButtons = `
                    ${btnDocs}
                    <button onclick="handleCandidateAction('${c.record_id}', 'VALIDER_POUR_ENTRETIEN')" class="bg-blue-600 text-white hover:bg-blue-700 px-3 py-2 rounded-lg text-[10px] font-bold uppercase shadow-md shadow-blue-200 transition-all mr-2"><i class="fa-solid fa-calendar-check mr-1"></i> Entretien</button>
                    <button onclick="handleCandidateAction('${c.record_id}', 'REFUS_IMMEDIAT')" class="bg-white border border-red-100 text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg text-[10px] font-bold uppercase transition-all"><i class="fa-solid fa-xmark mr-1"></i> Refus</button>
                `;
            } else if (stLogic === 'entretien') {
                actionButtons = `
                    ${btnDocs}
                    <button onclick="handleCandidateAction('${c.record_id}', 'ACCEPTER_EMBAUCHE')" class="bg-emerald-500 text-white hover:bg-emerald-600 px-3 py-2 rounded-lg text-[10px] font-bold uppercase shadow-md shadow-emerald-200 transition-all mr-2"><i class="fa-solid fa-user-plus mr-1"></i> Embaucher</button>
                    <button onclick="handleCandidateAction('${c.record_id}', 'REFUS_APRES_ENTRETIEN')" class="bg-white border border-orange-100 text-orange-500 hover:bg-orange px-3 py-2 rounded-lg text-[10px] font-bold uppercase transition-all"><i class="fa-solid fa-thumbs-down mr-1"></i> Refus</button>
                `;
            } else {
                actionButtons = `${btnDocs} <span class="text-[10px] font-bold text-slate-300 italic">Dossier Traité</span>`;
            }

            body.innerHTML += `
            <tr class="border-b hover:bg-slate-50 transition-colors group">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">${c.nom ? c.nom.charAt(0) : '?'}</div>
                        <div>
                            <div class="font-bold text-sm text-slate-800">${c.nom}</div>
                            <div class="text-[10px] text-slate-400 font-mono">${c.email}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 text-xs font-bold text-slate-600 uppercase tracking-tight">${c.poste || 'Non précisé'}</td>
                <td class="px-6 py-4 text-center">
                    <span class="${badgeClass} px-2.5 py-1 rounded-md text-[10px] font-black uppercase tracking-wide border border-black/5 shadow-sm">${stRaw}</span>
                </td>
                <td class="px-6 py-4 text-right flex justify-end items-center">
                    ${actionButtons}
                </td>
            </tr>`;
        });

    } catch (e) {
        console.error("Erreur Candidats:", e);
        body.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-red-500 font-bold text-sm bg-red-50 rounded-xl border border-red-100">Erreur de chargement : ${e.message}</td></tr>`;
    }
}








    // Fonction DESIGN FINAL (Airtable Compatible + Scroll Vertical autorisé, Horizontal banni)
function showCandidateDocs(safeNom, poste, cv, lm, dip, att, idCard) {
    const nom = decodeURIComponent(safeNom);
    
    const docs = [
        { id: 'cv', label: 'CV', url: cv ? decodeURIComponent(cv) : null, icon: 'fa-file-user', color: 'blue' },
        { id: 'lm', label: 'Lettre Motiv.', url: lm ? decodeURIComponent(lm) : null, icon: 'fa-envelope-open-text', color: 'pink' },
        { id: 'id_card', label: 'Pièce Identité', url: idCard ? decodeURIComponent(idCard) : null, icon: 'fa-id-card', color: 'purple' },
        { id: 'dip', label: 'Diplôme', url: dip ? decodeURIComponent(dip) : null, icon: 'fa-graduation-cap', color: 'emerald' },
        { id: 'att', label: 'Attestation', url: att ? decodeURIComponent(att) : null, icon: 'fa-file-invoice', color: 'orange' }
    ];

    // --- COLONNE GAUCHE (Menu) ---
    let buttonsHtml = '<div class="flex flex-col gap-2 overflow-y-auto pr-1 custom-scroll" style="max-height: 350px;">';
    let firstDocUrl = null;
    let hasDocs = false;

    docs.forEach(d => {
        if (d.url && d.url !== 'null' && d.url.length > 5) {
            hasDocs = true;
            if (!firstDocUrl) firstDocUrl = d.url; 
            
            buttonsHtml += `
                <button onclick="changePreview('${d.url}', this)" 
                    class="doc-btn w-full flex items-center gap-2 p-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition-all text-left group shadow-sm">
                    <div class="w-8 h-8 shrink-0 rounded-lg bg-${d.color}-50 flex items-center justify-center text-${d.color}-600 group-hover:scale-110 transition-transform">
                        <i class="fa-solid ${d.icon} text-sm"></i>
                    </div>
                    <div class="overflow-hidden flex-1 min-w-0">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-wide truncate">DOC</p>
                        <p class="text-xs font-bold text-slate-700 truncate">${d.label}</p>
                    </div>
                </button>
            `;
        }
    });
    buttonsHtml += '</div>';

    if (!hasDocs) {
        buttonsHtml = `<div class="p-4 bg-slate-50 border border-dashed border-slate-300 rounded-xl text-center text-slate-400 text-xs italic">Aucun document</div>`;
    }

    // --- LOGIQUE D'AFFICHAGE ---
    window.changePreview = function(url, btn) {
        // 1. Style des boutons
        document.querySelectorAll('.doc-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50/50');
            b.classList.add('bg-white', 'border-slate-200');
        });
        if(btn) {
            btn.classList.remove('bg-white', 'border-slate-200');
            btn.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50/50');
        }

        const viewerFrame = document.getElementById('doc-viewer-frame');
        const viewerImg = document.getElementById('doc-viewer-img');
        const extLink = document.getElementById('external-link-btn');
        const container = document.getElementById('preview-container');

        if(extLink) extLink.href = url;

        // 2. Détection IMAGE vs AUTRE (PDF)
        // On considère comme image : les extensions classiques OU les liens Airtable hébergeant des images
        // Les liens Airtable ressemblent souvent à v5.airtableusercontent...
        const isImageExtension = url.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i);
        const isAirtableImage = url.includes('airtableusercontent') && !url.toLowerCase().includes('.pdf');
        
        // SÉCURITÉ : Google Drive ID
        const driveMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
        let finalUrl = url;
        
        if (driveMatch) {
            // Conversion Drive -> Image directe
            finalUrl = `https://lh3.googleusercontent.com/d/${driveMatch[1]}`;
            viewerFrame.classList.add('hidden');
            viewerImg.classList.remove('hidden');
            viewerImg.src = finalUrl;
        } 
        else if (isImageExtension || isAirtableImage) {
            // C'EST UNE IMAGE (Airtable ou autre)
            viewerFrame.classList.add('hidden');
            viewerImg.classList.remove('hidden');
            viewerImg.src = url;
            
            // Réglage du conteneur pour le scroll
            container.classList.remove('overflow-hidden');
            container.classList.add('overflow-y-auto', 'overflow-x-hidden');
        } 
        else {
            // C'EST UN PDF (ou autre fichier) -> IFRAME
            viewerImg.classList.add('hidden');
            viewerFrame.classList.remove('hidden');
            
            // Ajustement URL Drive pour PDF
            if(url.includes('drive.google.com') && url.includes('/view')) finalUrl = url.replace('/view', '/preview');
            
            viewerFrame.src = finalUrl;
            
            // Pour l'iframe, on laisse le conteneur hidden car l'iframe a son propre scroll
            container.classList.add('overflow-hidden');
            container.classList.remove('overflow-y-auto');
        }
    };

    // --- HTML SWEETALERT ---
    Swal.fire({
        title: null, 
        html: `
            <div class="flex flex-col md:flex-row h-[500px] gap-4 text-left">
                
                <!-- GAUCHE : MENU (25%) -->
                <div class="w-full md:w-[25%] flex flex-col h-full border-r border-slate-100 pr-2">
                    <div class="mb-4">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Candidat</p>
                        <h2 class="text-xl font-extrabold text-slate-800 leading-tight mb-1 truncate">${nom}</h2>
                        <span class="inline-block bg-blue-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wide">
                            ${poste}
                        </span>
                    </div>
                    
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Fichiers</p>
                    ${buttonsHtml}

                    <div class="mt-auto pt-2">
                        <button onclick="Swal.close()" class="w-full py-2.5 rounded-xl bg-slate-100 text-slate-600 font-bold text-xs hover:bg-slate-200 transition-colors uppercase">
                            Fermer
                        </button>
                    </div>
                </div>

                <!-- DROITE : APERÇU (75%) -->
                <!-- 
                     id="preview-container" : C'est lui qui gère le scroll.
                     overflow-x-hidden : TUE le scroll horizontal.
                     overflow-y-auto : ACTIVE le scroll vertical si l'image est grande.
                -->
                <div id="preview-container" class="w-full md:w-[75%] h-full bg-slate-900 rounded-xl border border-slate-200 relative flex flex-col items-center shadow-inner overflow-x-hidden overflow-y-auto custom-scroll">
                    
                    ${hasDocs ? `
                        <div class="absolute top-3 right-3 z-10 sticky">
                            <a id="external-link-btn" href="${firstDocUrl || '#'}" target="_blank" class="bg-white/90 backdrop-blur text-slate-700 px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-sm border hover:text-blue-600 transition-all flex items-center gap-1">
                                <i class="fa-solid fa-up-right-from-square"></i> Ouvrir
                            </a>
                        </div>
                        
                        <!-- IFRAME (PDF) : Prend 100% hauteur -->
                        <iframe id="doc-viewer-frame" src="" class="w-full h-full bg-white hidden" frameborder="0"></iframe>
                        
                        <!-- IMG : Largeur 100% (w-full) et Hauteur Auto (h-auto) 
                             Cela force l'image à toucher les bords gauche/droite (pas de scroll H)
                             mais à s'allonger vers le bas (scroll V) -->
                        <img id="doc-viewer-img" class="w-full h-auto min-h-full bg-black/5 hidden object-top">

                    ` : `
                        <div class="w-full h-full flex flex-col items-center justify-center text-slate-500">
                            <i class="fa-solid fa-file-circle-xmark text-5xl opacity-20 mb-3"></i>
                            <p class="text-xs font-medium">Aucun aperçu</p>
                        </div>
                    `}
                </div>
            </div>
        `,
        width: '1000px',
        showConfirmButton: false, 
        showCloseButton: false,
        padding: '1.5rem',
        customClass: { popup: 'rounded-[1.5rem]', htmlContainer: '!m-0' },
        didOpen: () => {
            const firstBtn = document.querySelector('.doc-btn');
            if(firstBtn) {
                const onclickStr = firstBtn.getAttribute('onclick');
                const url = onclickStr.split("'")[1];
                window.changePreview(url, firstBtn);
            }
        }
    });
}



















    function convertToInputDate(dStr){
        if(!dStr) return ""; 
        // Si c'est déjà au format YYYY-MM-DD
        if(dStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dStr; 
        // Si c'est au format DD/MM/YYYY
        if(dStr.includes('/')){
            const p=dStr.split('/'); 
            return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
        } 
        return "";
    }



    
async function handleCandidateAction(id, action) {
    const conf = {
        'VALIDER_POUR_ENTRETIEN': { t: 'Inviter en entretien ?', c: '#2563eb', txt: "Un email d'invitation sera envoyé automatiquement." },
        'REFUS_IMMEDIAT': { t: 'Refuser la candidature ?', c: '#ef4444', txt: "Un email de refus immédiat sera envoyé." },
        'ACCEPTER_EMBAUCHE': { t: 'Confirmer l\'embauche ?', c: '#10b981', txt: 'Cela créera le profil employé et enverra les accès.' },
        'REFUS_APRES_ENTRETIEN': { t: 'Refuser après entretien ?', c: '#f97316', txt: "Un email de refus personnalisé sera envoyé." }
    }[action];

    const res = await Swal.fire({ 
        title: conf.t, 
        text: conf.txt, 
        icon: 'question', 
        showCancelButton: true, 
        confirmButtonColor: conf.c, 
        confirmButtonText: 'Oui, confirmer',
        cancelButtonText: 'Annuler'
    });
    
    if (res.isConfirmed) {
        // Affichage du loader persistant
        Swal.fire({ 
            title: 'Action en cours...', 
            text: 'Mise à jour du dossier et envoi des notifications...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading() 
        });

      try {
    const response = await secureFetch(URL_CANDIDATE_ACTION, {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id: id, action: action, agent: currentUser.nom })
    });

    // 1. On récupère le texte/JSON envoyé par Make
    const result = await response.json();

    // 2. On vérifie si Make a envoyé le message de succès réel
    if (result && result.status === "success") {
        Swal.fire('Succès', 'Action effectuée avec succès.', 'success');
        fetchCandidates(); 
        if(action === 'ACCEPTER_EMBAUCHE') fetchData(true);
    } else {
        // Si Make n'a pas de crédits, result.status ne sera pas "success"
        // ou le JSON sera vide.
        throw new Error("Le serveur n'a pas confirmé l'action (Crédits épuisés ?)");
    }

} catch(e) { 
    // Ici, on affiche l'erreur réelle
    Swal.fire('Échec du traitement', e.message, 'error'); 
}
    }
}








                                                        function changePage(direction) {
                const totalPages = Math.ceil(employees.length / ITEMS_PER_PAGE);
                const newPage = currentPage + direction;
                
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderData();
                    
                    // --- CORRECTION DU SCROLL ---
                    // On remonte doucement vers le haut du tableau, pas tout en haut de la page
                    // Cela garde le focus visuel sur les données
                    const tableSection = document.getElementById('view-employees');
                    if(tableSection) {
                        tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }











            // --- SÉCURITÉ XSS (NETTOYAGE DES DONNÉES) ---
            function escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return String(str).replace(/[&<>'"]/g, 
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag]));
            }



        
        




    // --- FEEDBACK FICHIER ---
    function updateFileFeedback(inputId, labelId) {
        const input = document.getElementById(inputId);
        const label = document.getElementById(labelId); // Le bouton ou le conteneur visuel
        const file = input.files[0];

        if (file) {
            // Change le style pour dire "C'est bon !"
            if (label) {
                // Sauvegarde le texte original si pas déjà fait
                if (!label.dataset.originalText) label.dataset.originalText = label.innerHTML;
                
                // Affiche le nom et une icône verte
                label.innerHTML = `<i class="fa-solid fa-check-circle text-emerald-500 mr-2"></i> <span class="text-emerald-700 font-bold text-[10px] truncate">${file.name}</span>`;
                label.classList.add('bg-emerald-50', 'border-emerald-200');
                label.classList.remove('bg-white', 'bg-blue-50', 'text-slate-600', 'text-blue-600');
            }
        }
    }











            // --- GESTION INTELLIGENTE DU RÉSEAU ---
            window.addEventListener('online', () => { 
                // 1. On ferme les alertes SweetAlert s'il y en a (comme "Pas de connexion")
                Swal.close();
                
                // 2. On affiche un petit toast vert
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
                Toast.fire({ icon: 'success', title: 'Connexion Rétablie', text: 'Vous êtes de nouveau en ligne.' }); 
                
                // 3. On enlève le mode visuel hors ligne
                document.body.classList.remove('offline-mode'); 
                
                // 4. Optionnel : On peut retenter de charger les données si on est connecté
                if(currentUser) refreshAllData();
            });

            window.addEventListener('offline', () => { 
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 5000});
                Toast.fire({ icon: 'warning', title: 'Connexion Perdue', text: 'Mode hors ligne activé.' }); 
                document.body.classList.add('offline-mode'); 
            });


            function clearSignature() {
                if (signaturePad) signaturePad.clear();
            }                                                   




    function closeFlashBanner() {
        const banner = document.getElementById('flash-banner');
        if(banner.dataset.key) {
            sessionStorage.setItem(banner.dataset.key, 'true'); // Mémorise la fermeture pour la session
        }
        banner.classList.add('hidden');
    }

    function openFlashModal() {
        document.getElementById('flash-modal').classList.remove('hidden');
        document.getElementById('flash-input-msg').value = '';
    }
    

























    // Nouvelle fonction pour fermer UN SEUL message de la pile
    function closeSpecificFlash(storageKey, elementId) {
        sessionStorage.setItem(storageKey, 'true');
        const el = document.getElementById(elementId);
        if (el) {
            el.style.opacity = '0';
            el.style.transform = 'translateX(20px)';
            setTimeout(() => el.remove(), 500);
        }
    }







                                                async function fetchPayrollData() {
    const container = document.getElementById('payroll-container');
    const countLabel = document.getElementById('count-payroll'); // Nouveau compteur
    if (!container || !currentUser) return;

    try {
        const r = await secureFetch(`${URL_READ_PAYROLL}?employee_id=${encodeURIComponent(currentUser.id)}&agent=${encodeURIComponent(currentUser.nom)}`);
        const payrolls = await r.json();
        
        container.innerHTML = '';
        if(countLabel) countLabel.innerText = payrolls.length || 0;

        if (!payrolls || payrolls.length === 0) {
            container.innerHTML = '<p class="col-span-full text-[10px] text-slate-400 italic text-center py-10">Aucun bulletin disponible</p>';
            return;
        }

        // --- TRI LONG TERME : Du plus récent au plus ancien ---
        // On suppose qu'il y a une Année et un Mois, ou une date de création
        // On convertit mois/année en date pour trier
        const monthMap = { 'Janvier':1, 'Février':2, 'Mars':3, 'Avril':4, 'Mai':5, 'Juin':6, 'Juillet':7, 'Août':8, 'Septembre':9, 'Octobre':10, 'Novembre':11, 'Décembre':12 };
        
        payrolls.sort((a, b) => {
            const yA = parseInt(a.Année) || 0; const yB = parseInt(b.Année) || 0;
            const mA = monthMap[a.Mois] || 0; const mB = monthMap[b.Mois] || 0;
            if (yA !== yB) return yB - yA; // Année décroissante
            return mB - mA; // Mois décroissant
        });

        payrolls.forEach(p => {
            const montant = p.Salaire_Net ? new Intl.NumberFormat('fr-FR').format(p.Salaire_Net) + ' FCFA' : '--';
            const titre = `${p.Mois} ${p.Année}`;
            
            container.innerHTML += `
                <div class="flex flex-col justify-between p-4 border border-slate-100 bg-slate-50 rounded-xl hover:bg-white hover:border-blue-200 hover:shadow-md transition-all group">
                    <div class="flex items-start justify-between mb-3">
                        <div class="bg-white border border-slate-100 text-emerald-600 p-2.5 rounded-xl shadow-sm">
                            <i class="fa-solid fa-file-invoice text-xl"></i>
                        </div>
                        <button onclick="viewDocument('${p.Fiche_PDF}', 'Bulletin ${titre}')" class="text-slate-300 hover:text-blue-600 transition-colors">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-700 mb-1">${titre}</p>
                        <p class="text-[10px] text-emerald-600 font-black uppercase tracking-wide bg-emerald-50 inline-block px-2 py-1 rounded">${montant}</p>
                    </div>
                </div>
            `;
        });
    } catch (e) {
        console.warn("Erreur bulletins:", e);
        container.innerHTML = '<p class="col-span-full text-[10px] text-red-400 italic text-center py-4">Erreur de chargement</p>';
    }
}








    function exportToCSV() {
        if (employees.length === 0) {
            return Swal.fire('Erreur', 'Aucune donnée à exporter', 'warning');
        }

        // 1. Définir les colonnes à exporter
        const headers = ["Matricule", "Nom Complet", "Poste", "Departement", "Statut", "Email", "Telephone", "Date Embauche", "Duree Contrat"];
        
        // 2. Préparer les données
        let csvContent = headers.join(";") + "\n"; // Utilisation du point-virgule pour Excel France

        employees.forEach(e => {
            const row = [
                e.id,
                e.nom,
                e.poste,
                e.dept,
                e.statut,
                e.email || "",
                e.telephone || "",
                e.date || "",
                e.limit
            ];
            
            // Nettoyage des données pour éviter les bugs de virgules/guillemets
            const cleanRow = row.map(val => `"${String(val).replace(/"/g, '""')}"`);
            csvContent += cleanRow.join(";") + "\n";
        });

        // 3. Créer le fichier et le télécharger
        // Utilisation du BOM UTF-8 (\ufeff) pour que Excel affiche bien les accents (é, à, etc.)
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        const dateStr = new Date().toLocaleDateString().replace(/\//g, "-");
        
        link.setAttribute("href", url);
        link.setAttribute("download", `Rapport_Effectif_${dateStr}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
        Toast.fire({ icon: 'success', title: 'Exportation réussie !' });
    }





    // --- LOGIQUE DARK MODE ---

    // 1. Initialisation (au chargement)
    function initDarkMode() {
        const isDark = localStorage.getItem('sirh_dark_mode') === 'true';
        if (isDark) {
            document.body.classList.add('dark-mode');
            updateDarkIcon(true);
        }
    }

    // 2. Basculement
    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('sirh_dark_mode', isDark);
        updateDarkIcon(isDark);
        
        // Feedback sonore léger ou vibration
        if (navigator.vibrate) navigator.vibrate(50);
    }

    // 3. Mise à jour de l'icône
    function updateDarkIcon(isDark) {
        const icon = document.getElementById('dark-icon');
        const btn = document.querySelector('.dark-toggle-btn');
        if (isDark) {
            icon.classList.replace('fa-moon', 'fa-sun');
            btn.classList.replace('bg-slate-100', 'bg-slate-800');
            btn.classList.replace('text-slate-600', 'text-yellow-400');
        } else {
            icon.classList.replace('fa-sun', 'fa-moon');
            btn.classList.replace('bg-slate-800', 'bg-slate-100');
            btn.classList.replace('text-yellow-400', 'text-slate-600');
        }
    }


    function applySmartFilter(filterType) {
        currentFilter = filterType;
        currentPage = 1; // On revient à la page 1 lors d'un filtrage
        
        // Mise à jour visuelle des boutons
        document.querySelectorAll('.filter-chip').forEach(btn => {
            btn.classList.remove('active-chip');
            if(btn.innerText.toLowerCase() === filterType.toLowerCase() || (filterType === 'all' && btn.innerText.toLowerCase() === 'tous')) {
                btn.classList.add('active-chip');
            }
        });

        renderData(); // On redessine le tableau
    }






    // Fonction magique pour décider si on écrit en blanc ou en noir sur une couleur
    function getContrastColor(hexColor) {
        // Nettoyer le hex
        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        // Calcul de la luminosité (formule standard)
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? '#1e293b' : '#ffffff'; // Si clair -> texte noir, si sombre -> texte blanc
    }


    function applyBranding() {
        const theme = SIRH_CONFIG.theme;

        // 1. Calcul des couleurs de texte intelligentes
        const textOnPrimary = getContrastColor(theme.primary);
        const textOnAccent = getContrastColor(theme.accent);

        // 2. Application des variables CSS
        const root = document.documentElement;
        root.style.setProperty('--primary', theme.primary);
        root.style.setProperty('--accent', theme.accent);
        root.style.setProperty('--font-main', theme.fontFamily);
        root.style.setProperty('--base-size', theme.baseFontSize);
        root.style.setProperty('--text-on-primary', textOnPrimary);
        root.style.setProperty('--text-on-accent', textOnAccent);

        // 3. Sidebar : Nom et Logo
        const nameEls = document.querySelectorAll('.company-name-display');
        nameEls.forEach(el => {
            el.innerText = SIRH_CONFIG.company.name;
            el.style.color = textOnPrimary; // Le nom s'adapte à la couleur de fond
        });

        const logoSidebar = document.querySelector('.app-logo-display');
        if(logoSidebar) logoSidebar.src = SIRH_CONFIG.company.logo;

        // 4. Écran de Connexion
        const loginTitle = document.querySelector('#login-screen h1');
        if(loginTitle) loginTitle.innerText = SIRH_CONFIG.company.name;
        
        const loginIconContainer = document.querySelector('#login-screen .inline-flex');
        if(loginIconContainer && SIRH_CONFIG.company.logo) {
            loginIconContainer.innerHTML = `<img src="${SIRH_CONFIG.company.logo}" class="w-14 h-14 object-contain">`;
        }

        // 5. Titre du navigateur
        document.title = SIRH_CONFIG.company.name + " | Portail RH";

        console.log(`🎨 Branding intelligent appliqué (${textOnAccent} sur ${theme.accent})`);
    }






    let deferredPrompt;
    const installBtn = document.getElementById('install-button');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Empêche Chrome d'afficher le pop-up automatique
        e.preventDefault();
        // Garde l'événement pour plus tard
        deferredPrompt = e;
        // Affiche notre bouton personnalisé
        installBtn.classList.remove('hidden');

        installBtn.addEventListener('click', async () => {
            // Affiche le vrai pop-up d'installation
            deferredPrompt.prompt();
            // Attend la réponse de l'utilisateur
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('L\'utilisateur a installé l\'app');
            }
            // On cache le bouton car l'installation est faite ou demandée
            installBtn.classList.add('hidden');
            deferredPrompt = null;
        });
    });

    // Cache le bouton si l'app est déjà installée
    window.addEventListener('appinstalled', () => {
        installBtn.classList.add('hidden');
        deferredPrompt = null;
    });












    // Variable temporaire pour stocker les données du rapport affiché
    let currentReportData = [];

    function downloadReportCSV(period = 'monthly') {
    if (!currentReportData || currentReportData.length === 0) {
        return Swal.fire('Erreur', 'Aucune donnée à exporter.', 'warning');
    }

    let headers = [];
    let csvContent = "";

    if (period === 'today') {
        // En-têtes pour le rapport du jour
        headers = ["Employe", "Heure Arrivee", "Zone", "Statut"];
        csvContent = headers.join(";") + "\n";
        
        currentReportData.forEach(row => {
            const clean = (text) => String(text).replace(/;/g, ",").replace(/\n/g, " ");
            let heureAffichee = row.heure_arrivee.match(/(\d{2}:\d{2})/) ? row.heure_arrivee.match(/(\d{2}:\d{2})/)[1] : row.heure_arrivee;
            
            const rowData = [
                clean(row.nom),
                clean(heureAffichee),
                clean(row.zone),
                'PRÉSENT' 
            ];
            const cleanRow = rowData.map(val => `"${String(val).replace(/"/g, '""')}"`);
            csvContent += cleanRow.join(";") + "\n";
        });
        
    } else {
        // En-têtes pour le rapport mensuel (Ton code qui marche bien)
        headers = ["Mois/Annee", "Employe", "Jours Presence", "Total Heures", "Statut"];
        csvContent = headers.join(";") + "\n";

        currentReportData.forEach(row => {
            const clean = (text) => String(text).replace(/;/g, ",").replace(/\n/g, " ");
            
            const rowData = [
                clean(row.mois),
                clean(row.nom),
                clean(row.jours),
                clean(row.heures).replace('h', ''), 
                clean(row.statut)
            ];
            const cleanRow = rowData.map(val => `"${String(val).replace(/"/g, '""')}"`);
            csvContent += cleanRow.join(";") + "\n";
        });
    }

    // 3. Créer le fichier et le télécharger
    const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    const dateStr = new Date().toLocaleDateString('fr-FR').replace(/\//g, "-");
    link.setAttribute("href", url);
    link.setAttribute("download", `Rapport_Presence_${dateStr}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
    Toast.fire({ icon: 'success', title: 'Exportation réussie !' });
}



















// CONFIGURATION DES LIENS DU FORMULAIRE
const AIRTABLE_FORM_PUBLIC_LINK = "https://airtable.com/appMZ85rH1jnHtiyo/pagaxgodARPVOvib4/form"; // Remplacez par votre lien de partage
const AIRTABLE_FORM_EDIT_LINK = "https://airtable.com/appMZ85rH1jnHtiyo/pagaxgodARPVOvib4/edit"; // Remplacez par le lien de votre vue formulaire sur Airtable

// Fonction pour copier le lien public
function copyFormLink() {
    navigator.clipboard.writeText(AIRTABLE_FORM_PUBLIC_LINK).then(() => {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
        
        Toast.fire({
            icon: 'success',
            title: 'Lien copié !',
            text: 'Vous pouvez maintenant l\'envoyer au candidat.'
        });
    }).catch(err => {
        Swal.fire('Erreur', 'Impossible de copier le lien automatiquement.', 'error');
    });
}

// Fonction pour ouvrir l'éditeur Airtable
function openFormEditor() {
    Swal.fire({
        title: 'Modifier le formulaire ?',
        text: "Vous allez être redirigé vers l'interface de modification d'Airtable.",
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Y aller',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#0f172a'
    }).then((result) => {
        if (result.isConfirmed) {
            window.open(AIRTABLE_FORM_EDIT_LINK, '_blank');
        }
    });
}



    </script>




        <script>
            // Enregistrement du Service Worker pour la PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('Service Worker enregistré', reg))
                        .catch(err => console.log('Erreur Service Worker', err));
                });
            }
        </script>











    </body>
    </html>